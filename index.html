<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUMO</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --color-background: #0f172a;
            --color-surface: #1e293b;
            --color-primary: #3b82f6;
            --color-secondary: #475569;
            --color-accent: #6366f1;
            --color-success: #22c55e;
            --color-danger: #ef4444;
            --color-warning: #f59e0b;
            --color-text-primary: #f1f5f9;
            --color-text-secondary: #94a3b8;
            --color-border: #334155;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.25);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }

        body, html {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: var(--color-background);
            color: var(--color-text-primary);
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        .kanban-column {
            min-width: 300px;
            max-width: 340px;
            flex-shrink: 0;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            transition: all 0.3s ease;
            background-color: var(--color-surface);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-sm);
        }

        .kanban-column:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .kanban-card {
            cursor: grab;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            border: 1px solid var(--color-border);
            background-color: var(--color-background);
            color: var(--color-text-primary);
            border-radius: 8px;
            margin: 8px;
            padding: 12px;
            box-shadow: var(--shadow-sm);
        }

        .kanban-card:hover {
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.3), 0 6px 12px -8px rgba(0, 0, 0, 0.22);
            transform: translateY(-3px) scale(1.01);
            background-color: #2d2e32;
        }
        .kanban-card:active {
            cursor: grabbing;
            transform: scale(0.97);
        }
        .kanban-card.dragging {
            opacity: 0.75;
            transform: scale(1.03) rotate(2deg);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
            border-color: transparent;
        }
        .kanban-column.drag-over {
            background-color: #323438;
            border-color: #4f46e5;
        }
        .kanban-column-content::-webkit-scrollbar { width: 8px; }
        .kanban-column-content::-webkit-scrollbar-track { background: #2d2e32; border-radius: 10px; }
        .kanban-column-content::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        .kanban-column-content::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.75); }
        .modal-content { 
            animation: fadeInScaleModal 0.35s cubic-bezier(0.25, 0.8, 0.25, 1) forwards;
            background-color: #27282b;
            color: #e2e8f0;
        }
        @keyframes fadeInScaleModal {
            from { opacity: 0; transform: translateY(25px) scale(0.96); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 1000; }
        .toast { 
            animation: slideInRightToast 0.5s cubic-bezier(0.25, 0.8, 0.25, 1) forwards, fadeOutToast 0.5s ease-in forwards 3.5s;
            background-color: #27282b;
            color: #e2e8f0;
        }
        @keyframes slideInRightToast { from { transform: translateX(110%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOutToast { from { opacity: 1; } to { opacity: 0; } }
        .truncate-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block; }
        .column-title-text { max-width: 130px; }
        .task-title-text { max-width: 190px; font-weight: 500; }
        .priority-icon { width: 1em; height: 1em; }
        .color-swatch { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; transition: transform 0.1s ease, box-shadow 0.1s ease; border: 2px solid transparent; }
        .color-swatch.selected { transform: scale(1.15); box-shadow: 0 0 0 2px #27282b, 0 0 0 4px currentColor; }
        .board-card { 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            background-color: #2d2e32;
            border: 1px solid #3f3f46;
        }
        .board-card:hover { 
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            background-color: #323438;
        }
        /* ======================================== */
        /* ESTILOS PARA TAREFAS BLOQUEADAS E CONCLUÍDAS - VERSÃO UNIFICADA */
        /* ======================================== */
        .task-blocked { 
            border-left-color: #ef4444 !important;              /* Borda vermelha à esquerda para tarefas bloqueadas */
            background-color: #471818;                           /* Fundo vermelho escuro para tarefas bloqueadas */
        }
        .task-blocked .task-title-text::before { 
            content: "\f023";                                   /* Ícone de cadeado do Font Awesome */
            font-family: "Font Awesome 6 Free"; 
            font-weight: 900; 
            margin-right: 6px; 
            color: #ef4444;                                      /* Cor vermelha do ícone */
        }
        .task-completed { 
            border-left-color: #22c55e !important;              /* Borda verde à esquerda para tarefas concluídas */
            background-color: #1a2f1d;                          /* Fundo verde escuro para tarefas concluídas */
            opacity: 0.8;                                        /* Reduz a opacidade para indicar conclusão */
        }
        .task-completed .task-title-text { 
            text-decoration: line-through;                       /* Risca o texto da tarefa concluída */
            color: #94a3b8;                                      /* Cor mais clara para texto concluído */
        }
        .task-completed .task-title-text::before { 
            content: "\f00c";                                    /* Ícone de check do Font Awesome */
            font-family: "Font Awesome 6 Free"; 
            font-weight: 900; 
            margin-right: 6px; 
            color: #22c55e;                                      /* Cor verde do ícone */
        }
        /* Ajustes adicionais para elementos de interface */
        input, select, textarea {
            background-color: var(--color-background) !important;
            color: var(--color-text-primary) !important;
            border-color: var(--color-border) !important;
        }
        input::placeholder, textarea::placeholder {
            color: var(--color-text-secondary) !important;
        }
        /* Estilos modernos para elementos da interface */
        .bg-white,
        div[class*="bg-white"],
        section[class*="bg-white"],
        header[class*="bg-white"],
        nav[class*="bg-white"],
        aside[class*="bg-white"] {
            background-color: var(--color-surface) !important;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
        }

        .bg-gray-50 {
            background-color: var(--color-background) !important;
        }

        .bg-gray-100 {
            background-color: var(--color-surface) !important;
        }

        /* Estilos modernos para botões */
        button:not(.color-swatch) {
            transition: all 0.3s ease !important;
            border-radius: 8px !important;
            font-weight: 500 !important;
        }

        button:not(.color-swatch):hover {
            transform: translateY(-2px) !important;
            box-shadow: var(--shadow-md) !important;
        }

        /* Estilos para inputs */
        input:not([type="checkbox"]), 
        select, 
        textarea {
            background-color: #2a3649 !important;
            border: 1px solid var(--color-border) !important;
            border-radius: 8px !important;
            transition: all 0.3s ease !important;
        }

        input:not([type="checkbox"]):focus,
        select:focus,
        textarea:focus {
            box-shadow: 0 0 0 2px var(--color-primary) !important;
            border-color: var(--color-primary) !important;
        }

        /* Estilos para modais */
        .modal-content {
            background-color: var(--color-surface) !important;
            border-radius: 16px !important;
            border: 1px solid var(--color-border) !important;
            box-shadow: var(--shadow-lg) !important;
        }
        .text-white {
            color: #e2e8f0 !important;
        }
        .text-gray-800 {
            color: #e2e8f0 !important;
        }
        .text-gray-700 {
            color: #cbd5e1 !important;
        }
        .text-gray-600 {
            color: #94a3b8 !important;
        }
        .text-gray-500 {
            color: #64748b !important;
        }
        .border-gray-200 {
            border-color: #3f3f46 !important;
        }
        .border-gray-300 {
            border-color: #4b5563 !important;
        }
        /* Ajustes para cards e containers */
        .shadow-md,
        .shadow-lg,
        .shadow-xl {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 
                        0 2px 4px -1px rgba(0, 0, 0, 0.25) !important;
        }
        /* Ajustes para modais e overlays */
        .modal-content,
        div[role="dialog"],
        .dropdown-menu {
            background-color: #1f2937 !important;
            border: 1px solid #374151 !important;
        }
        /* Ajustes para inputs e campos de formulário */
        .focus\:ring-white:focus {
            --tw-ring-color: #4b5563 !important;
        }
        /* Ajustes para hover states */
        .hover\:bg-white:hover {
            background-color: #374151 !important;
        }
        /* Ajustes para botões */
        .bg-gray-200 {
            background-color: #374151 !important;
            color: #e2e8f0 !important;
        }
        .bg-gray-200:hover {
            background-color: #4b5563 !important;
        }
        .bg-gray-300 {
            background-color: #4b5563 !important;
            color: #e2e8f0 !important;
        }
        .bg-gray-300:hover {
            background-color: #6b7280 !important;
        }
        /* Ajuste para botões com fundo branco */
        button.bg-white, 
        .bg-white[role="button"] {
            color: #e2e8f0 !important;
        }
        /* Ajuste para botões com texto branco em fundos coloridos */
        .bg-indigo-600,
        .bg-purple-600,
        .bg-blue-500,
        .bg-green-500,
        .bg-red-500,
        .bg-red-600,
        .bg-yellow-500 {
            color: #ffffff !important;
        }
        /* Ajuste para títulos coloridos */
        .text-emerald-700 {
            color: #34d399 !important;
        }

        /* Ajustes para o chat */
        #kanbanChatSidebar {
            background-color: var(--color-surface) !important;
            border-left: 1px solid var(--color-border) !important;
        }

        #kanbanChatMessages {
            background-color: var(--color-background) !important;
            padding: 0.75rem;
            max-height: 250px;
            min-height: 120px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--color-primary) var(--color-background);
        }

        #kanbanChatMessages::-webkit-scrollbar {
            width: 6px;
        }

        #kanbanChatMessages::-webkit-scrollbar-track {
            background: var(--color-background);
        }

        #kanbanChatMessages::-webkit-scrollbar-thumb {
            background-color: var(--color-primary);
            border-radius: 3px;
        }

        #kanbanChatForm {
            background-color: var(--color-surface) !important;
            border-top: 1px solid var(--color-border) !important;
            padding: 1rem;
        }

        #kanbanChatInput {
            background-color: var(--color-background) !important;
            color: var(--color-text-primary) !important;
            border: 1px solid var(--color-border) !important;
        }

        /* Estilo das mensagens */
        .message {
            display: flex;
            align-items: flex-start;
            gap: 0.25rem;
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            background-color: var(--color-surface) !important;
            border: 1px solid var(--color-border) !important;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .message:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .message-mine {
            background-color: var(--color-primary) !important;
            border-color: var(--color-primary) !important;
        }

        .message .sender {
            color: var(--color-primary) !important;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .message-mine .sender {
            color: var(--color-text-primary) !important;
        }

        .message .timestamp {
            color: var(--color-text-secondary) !important;
            font-size: 0.75rem;
        }

        .message .content {
            color: var(--color-text-primary) !important;
            font-size: 0.875rem;
            line-height: 1.25rem;
            white-space: pre-line;
            word-break: break-word;
        }

        .message-mine .content {
            color: var(--color-text-primary) !important;
        }

        /* Ajustes para o avatar na mensagem */
        .message .flex-shrink-0 {
            background-color: var(--color-surface) !important;
            color: var(--color-primary) !important;
        }

        .message-mine .flex-shrink-0 {
            background-color: var(--color-background) !important;
            color: var(--color-text-primary) !important;
        }

        /* Remove estilos conflitantes */
        .bg-white.message,
        div[class*="bg-white"].message {
            background-color: var(--color-surface) !important;
        }

        .text-white.message,
        .text-white .message {
            color: var(--color-text-primary) !important;
        }

        /* Ajustes para o cabeçalho */
        header.bg-white {
            background-color: var(--color-surface) !important;
            border-bottom: 1px solid var(--color-border);
        }

        /* Ajustes para modais */
        .modal-content {
            background-color: var(--color-surface) !important;
            color: var(--color-text-primary) !important;
        }

        /* Ajustes adicionais para consistência de cores */
        .kanban-column {
            background-color: var(--color-surface) !important;
            border-color: var(--color-border) !important;
        }

        .kanban-card {
            background-color: var(--color-background) !important;
            border-color: var(--color-border) !important;
            color: var(--color-text-primary) !important;
        }

        .kanban-card:hover {
            background-color: var(--color-surface) !important;
        }

        #kanbanChatSidebar {
            border-left-color: var(--color-border) !important;
        }

        #openChatSidebarBtn {
            background-color: var(--color-primary) !important;
        }

        #openChatSidebarBtn:hover {
            background-color: var(--color-accent) !important;
        }

        /* Ajustes para inputs e botões */
        input, select, textarea {
            background-color: var(--color-background) !important;
            color: var(--color-text-primary) !important;
            border-color: var(--color-border) !important;
        }

        input::placeholder, textarea::placeholder {
            color: var(--color-text-secondary) !important;
        }

        button.bg-gray-200 {
            background-color: var(--color-surface) !important;
            color: var(--color-text-primary) !important;
        }

        button.bg-gray-200:hover {
            background-color: var(--color-secondary) !important;
        }

        /* Estilos do botão de apagar mensagem */
        .delete-chat-msg-btn {
            color: var(--color-danger) !important;
            opacity: 0;
            transition: opacity 0.2s ease;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            background: var(--color-background);
            border: 1px solid var(--color-border);
            position: absolute;
            right: 8px;
            top: 8px;
        }

        .message:hover .delete-chat-msg-btn {
            opacity: 1;
        }

        .delete-chat-msg-btn:hover {
            background: var(--color-surface);
        }

        .message {
            position: relative;
        }

        /* Ajuste para mensagens próprias */
        .message-mine .delete-chat-msg-btn {
            background: var(--color-background);
            border-color: var(--color-border);
        }

        .message-mine .delete-chat-msg-btn:hover {
            background: var(--color-surface);
        }

        /* Estado inicial do botão limpar chat */
        #clearChatBtn {
            display: none;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
        
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Overlay de Carregamento Global -->
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[100]">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-12 w-12 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-white text-lg font-medium">Carregando...</p>
        </div>
    </div>

    <!-- Container para Toasts (Notificações) -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Seção de Autenticação -->
    <div id="authSection" class="flex flex-grow items-center justify-center bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 p-4">
        <div class="bg-white p-8 sm:p-10 rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 hover:scale-[1.02]">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-8" id="authTitle">Bem-vindo ao LUMO</h2>
            <div class="space-y-5">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email" autocomplete="email" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm placeholder-gray-400" placeholder="seu.email@exemplo.com">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="password" autocomplete="current-password" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm placeholder-gray-400" placeholder="Sua senha">
                </div>
                <button id="authButton" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 px-4 rounded-lg shadow-md hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-150 ease-in-out font-semibold text-lg transform hover:scale-105">
                    Entrar
                </button>
            </div>
            <p id="authError" class="text-red-500 text-sm mt-4 text-center hidden"></p>
        </div>
    </div>

    <!-- Seção de Gerenciamento de Quadros -->
    <div id="boardManagementSection" class="flex-grow p-6 hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Meus Quadros LUMO</h1>
            <button id="logoutButtonTop" class="bg-red-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 transition duration-150 ease-in-out">
                <i class="fas fa-sign-out-alt mr-2"></i>Sair
            </button>
        </div>
        <button id="showCreateBoardModalButton" class="mb-6 bg-green-500 text-white px-6 py-2.5 rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 transition duration-150 ease-in-out font-medium">
            <i class="fas fa-plus mr-2"></i>Criar Novo Quadro
        </button>
        <div id="boardListContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- Cards de quadros -->
        </div>
        <p id="noBoardsMessage" class="text-center text-gray-500 mt-10 hidden">Você ainda não tem quadros. Crie um novo para começar!</p>
    </div>

    <!-- Seção Principal do LUMO -->
    <div id="kanbanSection" class="flex flex-col flex-grow hidden">
        <header class="bg-white shadow-md p-4 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 sm:space-x-4">
            <div class="flex items-center space-x-3">
                <button id="backToBoardsButton" class="text-indigo-600 hover:text-indigo-800" title="Voltar para Meus Quadros">
                    <i class="fas fa-arrow-left fa-lg"></i>
                </button>
                <h1 id="currentBoardNameDisplay" class="text-2xl font-bold text-gray-800 truncate-text max-w-xs sm:max-w-sm md:max-w-md" title="Nome do Quadro">Carregando...</h1>
                <button id="showManageMembersModalButton" class="ml-2 bg-blue-500 text-white px-3 py-1.5 rounded-md shadow-sm hover:bg-blue-600 text-xs font-medium hidden" title="Gerenciar Membros">
                    <i class="fas fa-users mr-1"></i>Membros
                </button>
            </div>
            <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                <input type="text" id="taskSearchInput" placeholder="Pesquisar tarefas..." class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm w-full sm:w-52">
                <select id="filterPriority" class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm w-full sm:w-auto">
                    <option value="">Todas Prioridades</option>
                    <option value="low">Baixa</option>
                    <option value="medium">Média</option>
                    <option value="high">Alta</option>
                </select>
                <div class="flex items-center space-x-2">
                    <span id="userIdDisplay" class="text-gray-600 text-sm truncate-text max-w-[100px] sm:max-w-[150px]" title="ID do Usuário">ID: Carregando...</span>
                    <button id="showEditProfileModalButton" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded-md" title="Editar meu nome de exibição">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </div>
                <button id="logoutButtonKanban" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors duration-150 ease-in-out w-full sm:w-auto">
                    <i class="fas fa-sign-out-alt mr-2"></i>Sair
                </button>
            </div>
        </header>
        <div class="flex flex-row flex-grow relative">
            <div class="flex-grow flex flex-col">
                <div class="p-5 pb-2">
                    <button id="showAddColumnModalButton" class="bg-purple-600 text-white px-5 py-2.5 rounded-lg shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-colors duration-150 ease-in-out font-medium">
                        <i class="fas fa-plus mr-2"></i>Adicionar Nova Coluna
                    </button>
                </div>
                <main class="flex-grow p-5 pt-0 overflow-x-auto">
                    <div id="kanbanBoard" class="flex flex-nowrap space-x-6 h-full items-start pb-5">
                        <!-- Colunas do LUMO -->
                    </div>
                </main>
            </div>
            <!-- Chat lateral -->
            <aside id="kanbanChatSidebar" class="w-full sm:w-80 max-w-full sm:max-w-xs bg-white border-l border-gray-200 flex flex-col shadow-lg z-30 transition-all duration-300 fixed sm:static right-0 top-0 sm:top-auto sm:right-auto" style="min-width:280px; max-width:320px; display:none; max-height:450px;">
                <div class="flex items-center justify-between px-3 py-2 border-b border-gray-100 bg-gray-50">
                    <h3 class="text-base font-bold text-indigo-700 flex items-center"><i class="fas fa-comments mr-1"></i>Chat do Quadro</h3>
                    <button id="closeChatSidebarBtn" class="text-gray-400 hover:text-red-500 text-lg p-1 rounded transition"><i class="fas fa-times"></i></button>
                </div>
                <div id="kanbanChatMessages" class="flex-1 px-3 py-2 space-y-2 bg-white overflow-y-auto" style="max-height:250px;">
                    <div class="flex flex-col gap-2">
                        <!-- Mensagens do chat -->
                    </div>
                </div>
                <form id="kanbanChatForm" class="flex items-center gap-2 px-3 py-2 border-t border-gray-100 bg-gray-50">
                    <input id="kanbanChatInput" type="text" maxlength="500" placeholder="Digite sua mensagem..." class="flex-1 px-2 py-1 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm" autocomplete="off" />
                    <button type="submit" class="bg-indigo-600 text-white px-3 py-1 rounded-lg shadow-md hover:bg-indigo-700 font-semibold text-sm"><i class="fas fa-paper-plane"></i></button>
                </form>
                <div class="flex justify-end p-2 border-t border-gray-200 bg-gray-50">
                    <button type="button" id="clearChatBtn" class="hidden items-center gap-1 px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded-lg shadow-md transition-all duration-200 ease-in-out text-xs">
                        <i class="fas fa-trash-alt"></i>
                        <span class="font-medium">Limpar Chat</span>
                    </button>
                </div>
            </aside>
            <button id="openChatSidebarBtn" class="fixed sm:absolute bottom-6 right-6 sm:top-5 sm:right-5 z-40 bg-indigo-600 text-white rounded-full shadow-lg w-14 h-14 flex items-center justify-center text-2xl hover:bg-indigo-700 transition-all"><i class="fas fa-comments"></i></button>
        </div>
    </div>

    <!-- Modais -->
    <div id="editProfileModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md modal-content"><h3 class="text-2xl font-bold text-gray-800 mb-6">Editar Meu Nome de Exibição</h3><div class="space-y-4"><div><label for="myDisplayNameInput" class="block text-sm font-medium text-gray-700 mb-1">Seu Nome de Exibição</label><input type="text" id="myDisplayNameInput" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Como você quer ser chamado"></div><div class="flex justify-end space-x-4 pt-2"><button id="cancelEditProfileButton" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 font-medium">Cancelar</button><button id="confirmEditProfileButton" class="bg-green-500 text-white py-2 px-4 rounded-lg shadow-md hover:bg-green-600 font-medium">Salvar Nome</button></div></div></div></div>
    <div id="createBoardModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md modal-content"><h3 class="text-2xl font-bold text-gray-800 mb-6">Criar Novo Quadro LUMO</h3><div class="space-y-4"><div><label for="newBoardNameInput" class="block text-sm font-medium text-gray-700 mb-1">Nome do Quadro</label><input type="text" id="newBoardNameInput" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Ex: Projeto Alpha"></div><div class="flex justify-end space-x-4 pt-2"><button id="cancelCreateBoardButton" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 font-medium">Cancelar</button><button id="confirmCreateBoardButton" class="bg-green-500 text-white py-2 px-4 rounded-lg shadow-md hover:bg-green-600 font-medium">Criar Quadro</button></div></div></div></div>
    <div id="editBoardModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md modal-content"><h3 class="text-2xl font-bold text-gray-800 mb-6">Editar Nome do Quadro</h3><input type="hidden" id="editBoardIdInput"><div class="space-y-4"><div><label for="currentBoardNameStatic" class="block text-sm font-medium text-gray-700 mb-1">Nome Atual</label><p id="currentBoardNameStatic" class="mt-1 block w-full px-4 py-2 border border-gray-200 bg-gray-50 rounded-lg sm:text-sm truncate"></p></div><div><label for="newBoardNameEditInput" class="block text-sm font-medium text-gray-700 mb-1">Novo Nome</label><input type="text" id="newBoardNameEditInput" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Digite o novo nome"></div><div class="flex justify-end space-x-4 pt-2"><button id="cancelEditBoardButton" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 font-medium">Cancelar</button><button id="confirmEditBoardButton" class="bg-blue-500 text-white py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 font-medium">Salvar</button></div></div></div></div>
    <div id="deleteBoardConfirmModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md modal-content"><h3 class="text-2xl font-bold text-red-700 mb-4"><i class="fas fa-exclamation-triangle mr-2"></i>Confirmar Exclusão</h3><input type="hidden" id="deleteBoardIdInputConfirm"><input type="hidden" id="deleteBoardNameActualConfirm"><p class="text-gray-700 mb-2">Excluir quadro: <strong id="deleteBoardNameDisplayConfirm" class="font-semibold text-gray-800"></strong>?</p><p class="text-sm text-gray-600 mb-4">Ação <strong class="text-red-600">irreversível</strong>.</p><div class="mb-5"><label for="deleteBoardNameConfirmInput" class="block text-sm font-medium text-gray-700 mb-1">Confirme digitando o nome do quadro:</label><input type="text" id="deleteBoardNameConfirmInput" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm" placeholder="Nome do quadro"><p id="deleteBoardConfirmError" class="text-red-500 text-xs mt-1 hidden">Nome não corresponde.</p></div><div class="flex justify-end space-x-4 pt-3"><button id="cancelDeleteBoardConfirmButton" class="bg-gray-300 text-gray-800 py-2 px-5 rounded-lg shadow-sm hover:bg-gray-400 font-medium">Cancelar</button><button id="confirmDeleteBoardFinalButton" class="bg-red-600 text-white py-2 px-5 rounded-lg shadow-md hover:bg-red-700 font-medium">Excluir</button></div></div></div>
    
    <!-- Modal de Gerenciar Membros (Ajustado) -->
    <div id="manageMembersModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-[60] hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Gerenciar Membros</h3>
                <button id="closeManageMembersModalButton" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
            </div>
            <input type="hidden" id="manageMembersBoardIdInput">
            <div class="mb-6 border-b border-gray-200 pb-6">
                <label for="newMemberIdInput" class="block text-sm font-medium text-gray-700 mb-1">Adicionar Membro (UID)</label>
                <div class="flex space-x-2">
                    <input type="text" id="newMemberIdInput" class="flex-grow mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="UID do novo membro">
                    <button id="addMemberButton" class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 font-medium">Adicionar</button>
                </div>
                <p class="text-xs text-gray-500 mt-1">Peça ao usuário o "ID do Usuário" (visível no cabeçalho do LUMO).</p>
            </div>
            <div id="membersSectionContainer">
                <h4 class="text-lg font-medium text-gray-700 mb-3 pt-4 border-t border-gray-200 flex items-center">
                    <i class="fas fa-users mr-2 text-indigo-500"></i>
                    Membros Atuais:
                </h4>
                <ul id="memberListContainer" class="space-y-3 max-h-[50vh] sm:max-h-64 overflow-y-auto bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <!-- Lista de membros será populada aqui -->
                </ul>
            </div>
        </div>
    </div>

    <div id="addTaskModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg modal-content"><h3 class="text-2xl font-bold text-gray-800 mb-6">Adicionar Tarefa</h3><div class="space-y-4"><div><label for="taskTitle" class="block text-sm font-medium text-gray-700 mb-1">Título</label><input type="text" id="taskTitle" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Ex: Nova funcionalidade"></div><div><label for="taskDescription" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label><textarea id="taskDescription" rows="3" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Detalhes..."></textarea></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="taskPriority" class="block text-sm font-medium text-gray-700 mb-1">Prioridade</label><select id="taskPriority" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"><option value="low">Baixa</option><option value="medium" selected>Média</option><option value="high">Alta</option></select></div><div><label for="taskDueDate" class="block text-sm font-medium text-gray-700 mb-1">Vencimento</label><input type="date" id="taskDueDate" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div></div>
<!-- Bloco de produtos necessários para esta tarefa -->
<div id="taskProductMentionContainer" class="col-span-2 mt-2">
  <label class="block text-sm font-medium text-gray-700 mb-1">Produtos necessários para esta tarefa</label>
  <div class="flex flex-col gap-2">
    <div class="flex gap-2 items-center">
      <select id="taskProductMentionSelect" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-sm"></select>
      <input id="taskProductMentionQty" type="number" min="1" class="w-20 px-2 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-sm" placeholder="Qtd">
      <button id="addTaskProductMentionBtn" class="bg-emerald-500 text-white px-3 py-2 rounded-lg shadow-md hover:bg-emerald-600 font-medium"><i class="fas fa-plus"></i></button>
    </div>
    <div id="taskProductMentionList" class="flex flex-wrap gap-2"></div>
  </div>
</div>
<div class="flex justify-end space-x-4 pt-2"><button id="cancelAddTask" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 font-medium">Cancelar</button><button id="confirmAddTask" class="bg-indigo-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 font-medium">Adicionar</button></div></div></div></div>
    <div id="editTaskModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg modal-content"><h3 class="text-2xl font-bold text-gray-800 mb-6">Editar Tarefa</h3><input type="hidden" id="editTaskId"><div class="space-y-4"><div><label for="editTaskTitle" class="block text-sm font-medium text-gray-700 mb-1">Título</label><input type="text" id="editTaskTitle" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div><div><label for="editTaskDescription" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label><textarea id="editTaskDescription" rows="3" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="editTaskPriority" class="block text-sm font-medium text-gray-700 mb-1">Prioridade</label><select id="editTaskPriority" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"><option value="low">Baixa</option><option value="medium">Média</option><option value="high">Alta</option></select></div><div><label for="editTaskDueDate" class="block text-sm font-medium text-gray-700 mb-1">Vencimento</label><input type="date" id="editTaskDueDate" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div></div><div class="mt-4"><p class="text-sm font-medium text-gray-700 mb-1">Responsável: <span id="editTaskAssignedToDisplay" class="font-normal text-gray-600"></span></p><p id="editTaskAssignedAtDisplay" class="text-xs text-gray-500"></p></div><div id="editTaskCompletedDisplayContainer" class="mt-2 hidden"><p class="text-sm font-medium text-green-700">Concluída em: <span id="editTaskCompletedAtDisplay" class="font-normal"></span></p></div><div class="flex justify-between items-center pt-2"><button id="deleteTaskButton" class="bg-red-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-red-700 font-medium"><i class="fas fa-trash-alt mr-2"></i>Excluir</button><div class="space-x-4"><button id="cancelEditTask" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 font-medium">Cancelar</button><button id="saveEditTask" class="bg-indigo-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 font-medium">Salvar</button></div></div></div></div></div>
    <div id="addColumnModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md modal-content"><h3 class="text-2xl font-bold text-gray-800 mb-6">Nova Coluna</h3><div class="space-y-4"><div><label for="newColumnTitleInput" class="block text-sm font-medium text-gray-700 mb-1">Título</label><input type="text" id="newColumnTitleInput" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Ex: Revisão"></div><div class="flex justify-end space-x-4 pt-2"><button id="cancelAddColumnButton" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 font-medium">Cancelar</button><button id="confirmAddColumnButton" class="bg-purple-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 font-medium">Adicionar</button></div></div></div></div>
    <div id="editColumnModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md modal-content"><h3 class="text-2xl font-bold text-gray-800 mb-6">Editar Coluna</h3><input type="hidden" id="editColumnIdInput"><div class="space-y-5"><div><label for="editColumnTitleInput" class="block text-sm font-medium text-gray-700 mb-1">Novo Título</label><input type="text" id="editColumnTitleInput" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Novo Título"></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Cor</label><div id="editColumnColorPicker" class="flex flex-wrap gap-2 mt-1"></div><input type="hidden" id="editColumnColorInput"></div><div class="flex justify-end space-x-4 pt-3"><button id="cancelEditColumnButton" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 font-medium">Cancelar</button><button id="saveEditColumnButton" class="bg-indigo-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 font-medium">Salvar</button></div></div></div></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, orderBy, writeBatch, arrayUnion, arrayRemove, setLogLevel, getDoc, deleteField, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variáveis Globais & Configuração do Firebase ---
        let app;
        let db;
        let auth;
        let userProfilesCollectionRef; 

        const firebaseConfigFromGlobal = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appIdFromGlobal = typeof __app_id !== 'undefined' ? __app_id : 'default-lumo-app-id'; // Mantendo o ID padrão que você usou

        const fallbackFirebaseConfig = { // Configuração de fallback caso __firebase_config não esteja disponível
            apiKey: "AIzaSyAtAiYVQadYd1WpSIBWK3cbnJWMOOefAbM",
            authDomain: "lumo1-59d86.firebaseapp.com",
            projectId: "lumo1-59d86",
            storageBucket: "lumo1-59d86.firebasestorage.app",
            messagingSenderId: "547051453085",
            appId: "1:547051453085:web:3aa5b80a7f1da9db197274",
            measurementId: "G-WWHWY2T4ZG"
        };
        // Use a configuração global se disponível, senão use o fallback (ajuste o fallback com seus dados reais se __firebase_config não for fornecido)
        const finalFirebaseConfig = firebaseConfigFromGlobal || fallbackFirebaseConfig;


        try {
            app = initializeApp(finalFirebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug'); // Mantenha para depuração, pode remover em produção
            console.log("Firebase inicializado com sucesso. App ID em uso:", appIdFromGlobal);
            userProfilesCollectionRef = collection(db, `artifacts/${appIdFromGlobal}/userProfiles`);
        } catch (error) {
            console.error("Erro Crítico ao inicializar Firebase:", error);
            document.getElementById('loadingOverlay')?.classList.add('hidden');
            if (typeof showMessageModal === "function") {
                 showMessageModal("Erro Crítico de Conexão", "Não foi possível conectar ao sistema. Verifique sua conexão com a internet e tente recarregar a página. Se o problema persistir, contate o suporte.\n\nDetalhes: " + error.message, "error");
            } else {
                alert("Erro Crítico: Não foi possível conectar ao sistema. Verifique o console para mais detalhes.");
            }
            throw error; 
        }

        // --- Seletores de Elementos da UI ---
        const authSection = document.getElementById('authSection');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authButton = document.getElementById('authButton');
        const authError = document.getElementById('authError');
        const boardManagementSection = document.getElementById('boardManagementSection');
        const boardListContainer = document.getElementById('boardListContainer');
        const noBoardsMessage = document.getElementById('noBoardsMessage');
        const showCreateBoardModalButton = document.getElementById('showCreateBoardModalButton');
        const createBoardModal = document.getElementById('createBoardModal');
        const newBoardNameInput = document.getElementById('newBoardNameInput');
        const confirmCreateBoardButton = document.getElementById('confirmCreateBoardButton');
        const cancelCreateBoardButton = document.getElementById('cancelCreateBoardButton');
        const logoutButtonTop = document.getElementById('logoutButtonTop');
        const editBoardModal = document.getElementById('editBoardModal');
        const editBoardIdInput = document.getElementById('editBoardIdInput');
        const currentBoardNameStatic = document.getElementById('currentBoardNameStatic');
        const newBoardNameEditInput = document.getElementById('newBoardNameEditInput');
        const confirmEditBoardButton = document.getElementById('confirmEditBoardButton');
        const cancelEditBoardButton = document.getElementById('cancelEditBoardButton');
        const deleteBoardConfirmModal = document.getElementById('deleteBoardConfirmModal');
        const deleteBoardIdInputConfirm = document.getElementById('deleteBoardIdInputConfirm');
        const deleteBoardNameActualConfirm = document.getElementById('deleteBoardNameActualConfirm');
        const deleteBoardNameDisplayConfirm = document.getElementById('deleteBoardNameDisplayConfirm');
        const deleteBoardNameConfirmInput = document.getElementById('deleteBoardNameConfirmInput');
        const deleteBoardConfirmError = document.getElementById('deleteBoardConfirmError');
        const confirmDeleteBoardFinalButton = document.getElementById('confirmDeleteBoardFinalButton');
        const cancelDeleteBoardConfirmButton = document.getElementById('cancelDeleteBoardConfirmButton');
        
        const manageMembersModal = document.getElementById('manageMembersModal');
        const manageMembersBoardIdInput = document.getElementById('manageMembersBoardIdInput');
        const newMemberIdInput = document.getElementById('newMemberIdInput'); 
        const addMemberButton = document.getElementById('addMemberButton'); 
        const memberListContainer = document.getElementById('memberListContainer');
        const closeManageMembersModalButton = document.getElementById('closeManageMembersModalButton');
        // Seletores para a seção de criar novo usuário foram removidos pois a seção HTML foi removida

        const kanbanSection = document.getElementById('kanbanSection');
        const backToBoardsButton = document.getElementById('backToBoardsButton');
        const currentBoardNameDisplay = document.getElementById('currentBoardNameDisplay');
        const showManageMembersModalButton = document.getElementById('showManageMembersModalButton');
        const logoutButtonKanban = document.getElementById('logoutButtonKanban');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const taskSearchInput = document.getElementById('taskSearchInput');
        const filterPrioritySelect = document.getElementById('filterPriority');
        const addTaskModal = document.getElementById('addTaskModal');
        const taskTitleInput = document.getElementById('taskTitle');
        const taskDescriptionInput = document.getElementById('taskDescription');
        const taskPriorityInput = document.getElementById('taskPriority');
        const taskDueDateInput = document.getElementById('taskDueDate');
        const cancelAddTaskButton = document.getElementById('cancelAddTask');
        const confirmAddTaskButton = document.getElementById('confirmAddTask');
        const editTaskModal = document.getElementById('editTaskModal');
        const editTaskIdInput = document.getElementById('editTaskId');
        const editTaskTitleInput = document.getElementById('editTaskTitle');
        const editTaskDescriptionInput = document.getElementById('editTaskDescription');
        const editTaskPriorityInput = document.getElementById('editTaskPriority');
        const editTaskDueDateInput = document.getElementById('editTaskDueDate');
        const editTaskAssignedToDisplay = document.getElementById('editTaskAssignedToDisplay');
        const editTaskAssignedAtDisplay = document.getElementById('editTaskAssignedAtDisplay');
        const editTaskCompletedDisplayContainer = document.getElementById('editTaskCompletedDisplayContainer');
        const editTaskCompletedAtDisplay = document.getElementById('editTaskCompletedAtDisplay');
        const cancelEditTaskButton = document.getElementById('cancelEditTask');
        const saveEditTaskButton = document.getElementById('saveEditTask');
        const deleteTaskButton = document.getElementById('deleteTaskButton');
        const showAddColumnModalButton = document.getElementById('showAddColumnModalButton');
        const addColumnModal = document.getElementById('addColumnModal');
        const newColumnTitleInput = document.getElementById('newColumnTitleInput');
        const confirmAddColumnButton = document.getElementById('confirmAddColumnButton');
        const cancelAddColumnButton = document.getElementById('cancelAddColumnButton');
        const editColumnModal = document.getElementById('editColumnModal');
        const editColumnIdInput = document.getElementById('editColumnIdInput');
        const editColumnTitleInput = document.getElementById('editColumnTitleInput');
        const editColumnColorPicker = document.getElementById('editColumnColorPicker');
        const editColumnColorInput = document.getElementById('editColumnColorInput');
        const saveEditColumnButton = document.getElementById('saveEditColumnButton');
        const cancelEditColumnButton = document.getElementById('cancelEditColumnButton');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const toastContainer = document.getElementById('toastContainer');
        const showEditProfileModalButton = document.getElementById('showEditProfileModalButton');
        const editProfileModal = document.getElementById('editProfileModal');
        const myDisplayNameInput = document.getElementById('myDisplayNameInput');
        const confirmEditProfileButton = document.getElementById('confirmEditProfileButton');
        const cancelEditProfileButton = document.getElementById('cancelEditProfileButton');

        // --- Estado da Aplicação ---
        let currentUserId = null;
        let currentUserEmail = null; 
        let currentUserDisplayName = null; 
        let isCurrentUserAdmin = false; 
        let activeBoardId = null;
        let activeBoardData = null;
        let boardsCollectionRef = null;
        let columnsCollectionRef = null;
        let tasksCollectionRef = null;
        let unsubscribeBoardsSnapshot = null;
        let unsubscribeTasksSnapshot = null;
        let unsubscribeColumnsSnapshot = null;
        let boardTasks = [];
        let boardColumns = [];
        let userBoardCollection = [];

        const defaultColumnColors = [
            'bg-sky-500', 'bg-amber-500', 'bg-emerald-500', 'bg-purple-500', 'bg-pink-500',
            'bg-teal-500', 'bg-rose-500', 'bg-lime-500', 'bg-cyan-500', 'bg-fuchsia-500',
            'bg-slate-500', 'bg-orange-500', 'bg-red-500', 'bg-yellow-500', 'bg-green-500', 'bg-blue-500'
        ];

        // --- Permissões administrativas por cargo/tag ---
        // Mapeamento de permissões por cargo/tag (pode ser customizado)
        const ROLE_PERMISSIONS = {
            'Administrador': {
                // Permissões de quadro e tarefas
                canEditColumn: true,
                canDeleteColumn: true,
                canRemoveMember: true,
                canEditTag: true,
                canBlockTask: true,
                canEditTask: true,
                canDeleteChat: true,
                
                // Permissões de gerenciamento
                canManageRolePermissions: true,
                
                // Permissões de estoque
                canManageInventory: true,
                canWithdrawInventory: true,
                canApproveRequests: true,
                canViewReports: true,
                canManageCategories: true,
                canApproveReturns: true
            },
            'Supervisor': {
                // Permissões de quadro e tarefas
                canEditColumn: false,
                canDeleteColumn: false,
                canRemoveMember: false,
                canEditTag: false,
                canBlockTask: true,
                canEditTask: true,
                canDeleteChat: false,
                
                // Permissões de gerenciamento
                canManageRolePermissions: false,
                
                // Permissões de estoque
                canManageInventory: false,
                canWithdrawInventory: true,
                canApproveRequests: true,
                canViewReports: true,
                canManageCategories: false,
                canApproveReturns: true
            },
            'Membro': {
                // Permissões de quadro e tarefas
                canEditColumn: false,
                canDeleteColumn: false,
                canRemoveMember: false,
                canEditTag: false,
                canBlockTask: false,
                canEditTask: true,
                canDeleteChat: false,
                
                // Permissões de gerenciamento
                canManageRolePermissions: false,
                
                // Permissões de estoque
                canManageInventory: false,
                canWithdrawInventory: true,
                canApproveRequests: false,
                canViewReports: false,
                canManageCategories: false,
                canApproveReturns: false
            },
            'Proprietário': {
                // Permissões de quadro e tarefas
                canEditColumn: true,
                canDeleteColumn: true,
                canRemoveMember: true,
                canEditTag: true,
                canBlockTask: true,
                canEditTask: true,
                canDeleteChat: true,
                
                // Permissões de gerenciamento
                canManageRolePermissions: true,
                
                // Permissões de estoque
                canManageInventory: true,
                canWithdrawInventory: true,
                canApproveRequests: true,
                canViewReports: true,
                canManageCategories: true,
                canApproveReturns: true
            },
        };

        // --- Categorias de Permissões para o Modal ---
        const PERMISSION_CATEGORIES = {
            'Quadro': {
                icon: 'fa-chalkboard',
                permissions: {
                    'canEditColumn': 'Editar e criar colunas',
                    'canDeleteColumn': 'Excluir colunas',
                    'canRemoveMember': 'Remover membros do quadro',
                }
            },
            'Tarefas': {
                icon: 'fa-tasks',
                permissions: {
                    'canEditTask': 'Editar qualquer tarefa',
                    'canDeleteTask': 'Excluir qualquer tarefa',
                    'canBlockTask': 'Bloquear e desbloquear tarefas',
                }
            },
            'Estoque': {
                icon: 'fa-boxes-stacked',
                permissions: {
                    'canManageInventory': 'Gerenciar produtos (adicionar/editar/excluir)',
                    'canWithdrawInventory': 'Retirar itens do estoque',
                    'canApproveRequests': 'Aprovar solicitações de retirada',
                    'canApproveReturns': 'Aprovar devoluções de itens',
                    // ---> PERMISSÃO NOVA ADICIONADA AQUI <---
                    'canManageCategories': 'Gerenciar categorias de produtos',
                }
            },
            'Admin': {
                icon: 'fa-user-shield',
                permissions: {
                    'canManageMembers': 'Adicionar e remover membros',
                    'canEditTag': 'Editar cargos dos membros',
                    'canManageRolePermissions': 'Editar permissões dos cargos',
                    'canDeleteChat': 'Limpar o histórico do chat',
                    // ---> PERMISSÃO NOVA ADICIONADA AQUI <---
                    'canViewReports': 'Visualizar relatórios e histórico',
                }
            }
        };

        // Função utilitária para obter o cargo/tag do usuário no quadro
        function getUserRoleForBoard(boardData, userId) {
            if (!boardData || !userId) return null;
            if (boardData.owner === userId) return 'Proprietário';
            if (boardData.memberTags && boardData.memberTags[userId]) {
                return boardData.memberTags[userId];
            }
            return null;
        }

        // Função para checar permissão
        function hasPermission(boardData, userId, permission) {
            const role = getUserRoleForBoard(boardData, userId);
            if (!role) return false;
            const perms = (boardData.rolePermissions && boardData.rolePermissions[role]) ? boardData.rolePermissions[role] : ROLE_PERMISSIONS[role];
            

            
            return perms && perms[permission] === true;
        }

        // Adicionar funções ao escopo global para evitar problemas de escopo
        window.hasPermission = hasPermission;
        window.getUserRoleForBoard = getUserRoleForBoard;
        window.showToast = showToast;
        window.showMessageModal = showMessageModal;

        // Garantir que currentUserId seja global para as funções restauradas
        Object.defineProperty(window, 'currentUserId', {
            get: () => currentUserId,
            set: (value) => { currentUserId = value; }
        });

        // Garantir que activeBoardData seja global
        Object.defineProperty(window, 'activeBoardData', {
            get: () => activeBoardData,
            set: (value) => { activeBoardData = value; }
        });

        // --- Funções Utilitárias ---
        function showLoading() { loadingOverlay?.classList.remove('hidden'); }
        function hideLoading() { loadingOverlay?.classList.add('hidden'); }

        function showToast(message, type = 'success', duration = 3500) {
            if (!toastContainer) return;
            const toastElement = document.createElement('div');
            toastElement.className = `toast p-4 rounded-lg shadow-xl mb-3 flex items-center space-x-3 text-white text-sm font-medium`;
            let iconHtml = '';
            switch (type) {
                case 'success': toastElement.classList.add('bg-green-500'); iconHtml = '<i class="fas fa-check-circle fa-lg"></i>'; break;
                case 'error': toastElement.classList.add('bg-red-500'); iconHtml = '<i class="fas fa-times-circle fa-lg"></i>'; break;
                case 'info': toastElement.classList.add('bg-blue-500'); iconHtml = '<i class="fas fa-info-circle fa-lg"></i>'; break;
                default: toastElement.classList.add('bg-gray-700'); iconHtml = '<i class="fas fa-bell fa-lg"></i>';
            }
            toastElement.innerHTML = `${iconHtml} <span>${message}</span>`;
            toastContainer.appendChild(toastElement);
            setTimeout(() => {
                toastElement.style.animation = 'fadeOutToast 0.5s ease-in forwards';
                setTimeout(() => toastElement.remove(), 500);
            }, duration);
        }

        function showMessageModal(title, message, type = 'info', onConfirm = null, confirmText = 'Ok', showCancel = false, cancelText = 'Cancelar') {
            const modalId = `messageModal-${Date.now()}`;
            let buttonsHtml = `<button id="confirmBtn-${modalId}" class="bg-indigo-600 text-white py-2 px-5 rounded-lg shadow-md hover:bg-indigo-700 font-medium transition-colors">${confirmText}</button>`;
            if (showCancel) {
                buttonsHtml = `<button id="cancelBtn-${modalId}" class="bg-gray-200 text-gray-700 py-2 px-5 rounded-lg shadow-sm hover:bg-gray-300 font-medium transition-colors">${cancelText}</button> ${buttonsHtml}`;
            }
            const modalHtml = `
                <div id="${modalId}" class="fixed inset-0 modal-overlay flex items-center justify-center z-[70] p-4">
                    <div class="bg-white p-7 rounded-xl shadow-2xl w-full max-w-md modal-content">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">${title}</h3>
                        <p class="text-gray-600 mb-7 text-sm whitespace-pre-wrap">${message}</p>
                        <div class="flex justify-end space-x-3">${buttonsHtml}</div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const confirmButton = document.getElementById(`confirmBtn-${modalId}`);
            const cancelButton = document.getElementById(`cancelBtn-${modalId}`);
            const closeModal = () => document.getElementById(modalId)?.remove();
            confirmButton.addEventListener('click', () => { if (onConfirm) onConfirm(); closeModal(); });
            if (showCancel && cancelButton) { cancelButton.addEventListener('click', closeModal); }
        }

        function populateColorPicker(container, currentColorClass, inputTarget) {
            if (!container) return;
            container.innerHTML = '';
            defaultColumnColors.forEach(colorClass => {
                const swatch = document.createElement('div');
                swatch.className = `color-swatch ${colorClass}`;
                if (colorClass === currentColorClass) { swatch.classList.add('selected'); }
                swatch.addEventListener('click', () => {
                    if (inputTarget) inputTarget.value = colorClass;
                    container.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
                    swatch.classList.add('selected');
                });
                container.appendChild(swatch);
            });
        }

        // [INÍCIO: CENTRALIZAÇÃO E CORREÇÃO DOS BOTÕES FLUTUANTES]
        
        // Sistema centralizado de controle de visibilidade de botões administrativos
        // 
        // LAYOUT FINAL DOS BOTÕES FAB (POSIÇÕES ORGANIZADAS PELO ADMIN):
        // 
        // POSIÇÕES FINAIS APLICADAS:
        // manageInventoryCategoriesBtn (Gerenciar Categorias) - bottom-130 right-6
        // adminUserInventoryBtn (Inventário Usuários) - bottom-130 right-63
        // requestStockBtn (Solicitar Item) - bottom-70 right-6
        // approveInventoryRequestsBtn (Aprovar Solicitações) - bottom-70 right-63
        // inventoryHistoryBtn (Histórico) - bottom-188 right-63
        // inventoryReportsBtn (Relatórios) - bottom-70 right-120
        // adminReturnsBtn (Aprovar Devoluções) - bottom-130 right-120
        // myItemsFabBtn (Meus Itens) - bottom-188 right-6
        // openInventoryBtn (Estoque) - bottom-11 right-6
        // pendingRequestsBtn (Aprovar Solicitações Pendentes) - bottom-11 right-63
        // myRequestsBtn (Minhas Solicitações) - bottom-11 right-120
        // 
        // NOTA: Editor de grid removido - posições organizadas pelo admin
        // AS POSIÇÕES SÃO FIXAS NO CÓDIGO E FUNCIONAM EM QUALQUER PC
        const ADMIN_BUTTONS = {
            // Botões de estoque
            'openInventoryBtn': { permission: 'canWithdrawInventory', description: 'Acesso ao Estoque' },
            'requestStockBtn': { permission: 'canWithdrawInventory', description: 'Solicitar Itens do Estoque' },

            'myItemsFabBtn': { permission: 'canWithdrawInventory', description: 'Visualizar Meus Itens' },
            'pendingRequestsBtn': { permission: 'canApproveRequests', description: 'Aprovar Solicitações Pendentes' },
            'myRequestsBtn': { permission: 'canWithdrawInventory', description: 'Minhas Solicitações' },
            'adminReturnsBtn': { permission: 'canApproveReturns', description: 'Aprovar Devoluções' },
            'inventoryReportsBtn': { permission: 'canViewReports', description: 'Relatórios de Estoque' },
            
            // Botões restaurados e otimizados
            'approveInventoryRequestsBtn': { permission: 'canApproveRequests', description: 'Aprovar Solicitações de Estoque' },
            'manageInventoryCategoriesBtn': { permission: 'canManageCategories', description: 'Gerenciar Categorias de Produtos' },
            
            // Novos botões para ciclo de vida de itens
            'inventoryHistoryBtn': { permission: 'canViewReports', description: 'Histórico Completo de Estoque' },
            'adminUserInventoryBtn': { permission: 'canManageInventory', description: 'Inventário dos Usuários' },
            
            // Adicionar aqui novos botões administrativos conforme necessário
        };
        
        // Função para garantir criação única de FABs
        window.ensureFabBtn = function(id, iconClass, colorClass, title, onClick) {
            let btn = document.getElementById(id);
            if (!btn) {
                btn = document.createElement('button');
                btn.id = id;
                btn.className = `fixed z-40 rounded-full shadow-lg w-14 h-14 flex items-center justify-center text-2xl transition-all duration-200 focus:outline-none focus:ring-2 ${colorClass}`;
                btn.title = title;
                btn.setAttribute('aria-label', title);
                btn.setAttribute('tabindex', '0');
                btn.setAttribute('role', 'button');
                btn.innerHTML = `<i class="${iconClass}" aria-hidden="true"></i><span class="sr-only">${title}</span>`;
                btn.style.display = 'none';
                document.body.appendChild(btn);
            }
            if (onClick) {
                btn.onclick = onClick;
            }
            return btn;
        }

        // Posições finais dos botões (organizadas pelo admin)
        let buttonPositions = {
            'manageInventoryCategoriesBtn': { bottom: '130', right: '6' },
            'adminUserInventoryBtn': { bottom: '130', right: '63' },
            'requestStockBtn': { bottom: '70', right: '6' },
            'approveInventoryRequestsBtn': { bottom: '70', right: '63' },
            'inventoryHistoryBtn': { bottom: '188', right: '63' },
            'inventoryReportsBtn': { bottom: '70', right: '120' },
            'adminReturnsBtn': { bottom: '130', right: '120' },
            'myItemsFabBtn': { bottom: '188', right: '6' },
            'openInventoryBtn': { bottom: '11', right: '6' },
            'pendingRequestsBtn': { bottom: '11', right: '63' },
            'myRequestsBtn': { bottom: '11', right: '120' }
        };

        // Função para aplicar posições finais dos botões (FIXAS NO CÓDIGO)
        function applyButtonPositions() {
            // Aplica as posições fixas definidas no código
            Object.entries(buttonPositions).forEach(([btnId, pos]) => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.style.bottom = pos.bottom + 'px';
                    btn.style.right = pos.right + 'px';
                }
            });
        }


        
        // Função central para mostrar/esconder FABs
        function toggleFabs(show, boardData) {
            if (!show || !boardData) {
                // Esconde todos os botões administrativos quando não houver quadro ativo
                Object.keys(ADMIN_BUTTONS).forEach(btnId => {
                    const btn = document.getElementById(btnId);
                    if (btn) btn.style.display = 'none';
                });
                return;
            }

            // Itera sobre cada botão administrativo e verifica permissões
            Object.entries(ADMIN_BUTTONS).forEach(([btnId, config]) => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    // Verifica se o usuário tem a permissão necessária
                    const canAccess = hasPermission(boardData, currentUserId, config.permission);
                    
                    btn.style.display = show && canAccess ? 'flex' : 'none';
                    
                    // Adiciona classe para identificação e dados para uso em interfaces de permissão
                    btn.classList.add('admin-fab-btn');
                    btn.dataset.permission = config.permission;
                    btn.dataset.description = config.description;
                }
            });

            // Aplicar posições salvas (sem mostrar grid automaticamente)
            if (show && boardData) {
                setTimeout(() => {
                    applyButtonPositions();
                }, 1000); // Aguarda 1 segundo para os botões aparecerem
            }
        }

        // Substitui a função temporária pela versão completa
        window.toggleFabs = toggleFabs;

        // Criação dos FABs - SISTEMA DINÂMICO DE POSIÇÕES
        // 
        // [1,1] = Gerenciar Categorias (roxo)
        window.ensureFabBtn('manageInventoryCategoriesBtn', 'fas fa-tags', 'bg-purple-600 text-white', 'Gerenciar Categorias de Produtos', () => {
            if (window.activeBoardData) {
                window.openInventoryCategoriesManagementModal(window.activeBoardData);
            } else {
                showToast('Erro: Dados do quadro não encontrados.', 'error');
            }
        });

        // [1,2] = Inventário de Usuários (cinza)
        window.ensureFabBtn('adminUserInventoryBtn', 'fas fa-users-cog', 'bg-gray-600 text-white', 'Inventário dos Usuários', () => {
            loadAndShowAdminUserInventory();
        });

        // [1,3] = Solicitar Item (verde) - REQUER PERMISSÃO: canWithdrawInventory
        window.ensureFabBtn('requestStockBtn', 'fas fa-box-open', 'bg-emerald-500 text-white', 'Solicitar Item do Estoque', () => {
            const modal = document.getElementById('requestStockModal');
            if (modal) modal.classList.remove('hidden');
        });

        // [2,1] = Aprovar Solicitações (verde)
        window.ensureFabBtn('approveInventoryRequestsBtn', 'fas fa-check-circle', 'bg-green-600 text-white', 'Aprovar Solicitações de Estoque', () => {
            if (window.activeBoardData) {
                window.openInventoryRequestsApprovalModal(window.activeBoardData);
            } else {
                showToast('Erro: Dados do quadro não encontrados.', 'error');
            }
        });

        // [2,2] = Histórico de Estoque (azul)
        window.ensureFabBtn('inventoryHistoryBtn', 'fas fa-history', 'bg-blue-600 text-white', 'Histórico de Estoque', () => {
            loadAndShowInventoryHistory();
        });

        // [2,3] = Relatórios de Estoque (azul escuro)
        window.ensureFabBtn('inventoryReportsBtn', 'fas fa-chart-bar', 'bg-blue-800 text-white', 'Relatórios de Estoque', () => {
            // Função temporária - implementar quando necessário
            showToast('Relatórios de Estoque - Funcionalidade em desenvolvimento', 'info');
        });

        // [3,1] = Aprovar Devoluções (laranja)
        window.ensureFabBtn('adminReturnsBtn', 'fas fa-undo', 'bg-yellow-600 text-white', 'Aprovar devoluções de itens', () => {
            loadAndShowAdminReturns();
        });

        // [3,2] = Meus Itens (azul)
        window.ensureFabBtn('myItemsFabBtn', 'fas fa-box', 'bg-blue-600 text-white', 'Meus Itens', () => {
            loadAndShowMyItems();
        });

        // [3,3] = Estoque (verde)
        window.ensureFabBtn('openInventoryBtn', 'fas fa-boxes', 'bg-emerald-600 text-white', 'Estoque', () => {
            document.getElementById('inventoryModal').classList.remove('hidden');
        });

        // [4,1] = Aprovar Solicitações Pendentes (verde claro)
        window.ensureFabBtn('pendingRequestsBtn', 'fas fa-clock', 'bg-green-400 text-white', 'Aprovar Solicitações Pendentes', () => {
            loadAndShowPendingRequests();
        });

        // [4,2] = Minhas Solicitações (azul claro)
        window.ensureFabBtn('myRequestsBtn', 'fas fa-list', 'bg-blue-400 text-white', 'Minhas Solicitações', () => {
            loadAndShowMyRequests();
        });

        // DEBUG: Para verificar se os botões estão aparecendo, abra o console e digite:
        // document.querySelectorAll('.admin-fab-btn').forEach(btn => console.log(btn.id, btn.style.display, btn.dataset.permission));
        
        // NOTA: Agora todos os 11 botões estão organizados em um grid 4x3 visível
        // com espaçamento de 24 unidades (6rem) entre cada linha para melhor visualização
        
        // Posições finais aplicadas automaticamente
        // (Editor de grid removido - posições organizadas pelo admin)

        // Centralizar listeners de entrada/saída do quadro
        const _oldSetActiveBoard = typeof window._oldSetActiveBoardBackup === 'function' ? window._oldSetActiveBoardBackup : activateBoardAndSetup;
        activateBoardAndSetup = async function(boardId, boardData) {
            if (_oldSetActiveBoard) await _oldSetActiveBoard(boardId, boardData);
            window.toggleFabs(true, boardData);
        };
        backToBoardsButton?.addEventListener('click', () => {
            window.toggleFabs(false);
        });
        
        // [FIM: CENTRALIZAÇÃO E CORREÇÃO DOS BOTÕES FLUTUANTES]
        
        async function updateUserProfileAndActivity() {
            if (!currentUserId || !userProfilesCollectionRef || !currentUserEmail) {
                console.warn("updateUserProfileAndActivity: Dados do usuário incompletos.");
                isCurrentUserAdmin = false; 
                return;
            }
            isCurrentUserAdmin = false; 
            try {
                const userProfileRef = doc(userProfilesCollectionRef, currentUserId);
                const profileSnap = await getDoc(userProfileRef);
                let dataToSet = {
                    email: currentUserEmail, 
                    lastBoardAccess: serverTimestamp()
                };
                let needsUpdate = false;

                if (profileSnap.exists()) {
                    const profileData = profileSnap.data();
                    let finalDisplayName = currentUserEmail; 
                    if (Array.isArray(profileData.displayName) && profileData.displayName.length > 0) {
                        finalDisplayName = profileData.displayName.join(" ").trim(); 
                    } else if (typeof profileData.displayName === 'string' && profileData.displayName.trim() !== '') {
                        finalDisplayName = profileData.displayName.trim();
                    }
                    currentUserDisplayName = finalDisplayName; // Atualiza a variável global

                    if (profileData.displayName !== currentUserDisplayName) { 
                        dataToSet.displayName = currentUserDisplayName;
                        needsUpdate = true;
                    }
                    isCurrentUserAdmin = profileData.isAdmin === true; 
                    if (typeof profileData.isAdmin === 'undefined') {
                        dataToSet.isAdmin = false;
                        isCurrentUserAdmin = false; 
                        needsUpdate = true;
                    }
                } else {
                    currentUserDisplayName = currentUserEmail; 
                    dataToSet.displayName = currentUserDisplayName;
                    dataToSet.isAdmin = false; 
                    isCurrentUserAdmin = false;
                    needsUpdate = true; 
                }
                
                if (needsUpdate || !profileSnap.exists()) {
                    await setDoc(userProfileRef, dataToSet, { merge: true });
                    console.log("Perfil do usuário criado/atualizado no Firestore. Admin:", isCurrentUserAdmin, "Nome:", currentUserDisplayName);
                } else {
                    console.log("Perfil do usuário lido do Firestore. Admin:", isCurrentUserAdmin, "Nome:", currentUserDisplayName);
                }

                if (userIdDisplay) {
                     userIdDisplay.title = `Seu ID: ${currentUserId}\nNome: ${currentUserDisplayName}${isCurrentUserAdmin ? ' (Admin)' : ''}`;
                }
            } catch (error) {
                console.error("Erro ao atualizar/ler perfil do usuário:", error);
                currentUserDisplayName = currentUserEmail; 
                isCurrentUserAdmin = false; 
            }
        }


        // --- Lógica de Autenticação ---
        onAuthStateChanged(auth, async (user) => {
            showLoading();
            if (user) {
                currentUserId = user.uid;
                currentUserEmail = user.email; 
                currentUserDisplayName = user.email; 
                
                await updateUserProfileAndActivity(); 

                if (userIdDisplay) {
                    userIdDisplay.textContent = `ID: ${currentUserId.substring(0,8)}...`; 
                }
                boardsCollectionRef = collection(db, `artifacts/${appIdFromGlobal}/boards`);
                authSection?.classList.add('hidden');
                boardManagementSection?.classList.remove('hidden');
                kanbanSection?.classList.add('hidden');
                loadUserBoardCollection(); 
            } else {
                currentUserId = null;
                currentUserEmail = null;
                currentUserDisplayName = null; 
                isCurrentUserAdmin = false; 
                activeBoardId = null;
                activeBoardData = null;
                authSection?.classList.remove('hidden');
                boardManagementSection?.classList.add('hidden');
                kanbanSection?.classList.add('hidden');
                if (unsubscribeBoardsSnapshot) unsubscribeBoardsSnapshot();
                if (unsubscribeTasksSnapshot) unsubscribeTasksSnapshot();
                if (unsubscribeColumnsSnapshot) unsubscribeColumnsSnapshot();
                unsubscribeBoardsSnapshot = null; unsubscribeTasksSnapshot = null; unsubscribeColumnsSnapshot = null;
                boardTasks = []; boardColumns = []; userBoardCollection = [];
                if(kanbanBoard) kanbanBoard.innerHTML = '';
                if(boardListContainer) boardListContainer.innerHTML = '';
                hideLoading();
            }
        });

        const handleLogin = async () => {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            if (!email || !password) { authError.textContent = 'Preencha email e senha.'; authError.classList.remove('hidden'); return; }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { authError.textContent = 'Email inválido.'; authError.classList.remove('hidden'); return; }
            if (password.length < 6) { authError.textContent = 'Senha curta (mínimo 6 caracteres).'; authError.classList.remove('hidden'); return; }
            showLoading();
            authError.classList.add('hidden');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast('Login bem-sucedido!', 'success');
            } catch (error) {
                let errorMessage = 'Erro ao entrar.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') errorMessage = 'Email ou senha inválidos.';
                else if (error.code === 'auth/invalid-email') errorMessage = 'Formato de email inválido.';
                else if (error.code === 'auth/too-many-requests') errorMessage = 'Muitas tentativas. Tente mais tarde.';
                else if (error.code === 'auth/user-disabled') errorMessage = 'Usuário desabilitado.';
                authError.textContent = errorMessage; authError.classList.remove('hidden');
                showToast(`Erro no login: ${errorMessage}`, 'error');
                console.error("Erro de login:", error.code, error.message);
                hideLoading();
            }
        };
        authButton?.addEventListener('click', handleLogin);
        emailInput?.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
        passwordInput?.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });

        const handleLogout = async () => {
            showLoading();
            try {
                await signOut(auth);
                showToast('Logout realizado com sucesso!', 'info');
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
                showMessageModal('Erro de Logout', 'Não foi possível fazer logout. Tente novamente.', 'error');
                hideLoading();
            }
        };
        logoutButtonTop?.addEventListener('click', handleLogout);
        logoutButtonKanban?.addEventListener('click', handleLogout);

        showEditProfileModalButton?.addEventListener('click', () => {
            if (myDisplayNameInput && currentUserDisplayName) {
                myDisplayNameInput.value = currentUserDisplayName;
            }
            editProfileModal?.classList.remove('hidden');
            myDisplayNameInput?.focus();
        });

        cancelEditProfileButton?.addEventListener('click', () => {
            editProfileModal?.classList.add('hidden');
        });

        confirmEditProfileButton?.addEventListener('click', async () => {
            const newName = myDisplayNameInput.value.trim();
            if (!newName) {
                showMessageModal('Atenção', 'O nome de exibição não pode ser vazio.', 'info');
                myDisplayNameInput.focus();
                return;
            }
            if (newName.length > 50) { 
                 showMessageModal('Atenção', 'O nome de exibição é muito longo (máx 50 caracteres).', 'info');
                myDisplayNameInput.focus();
                return;
            }

            showLoading();
            try {
                const userProfileRef = doc(userProfilesCollectionRef, currentUserId);
                await setDoc(userProfileRef, { displayName: newName }, { merge: true });
                currentUserDisplayName = newName; 
                showToast("Nome de exibição atualizado!", "success");
                editProfileModal?.classList.add('hidden');
                if (userIdDisplay) { 
                    userIdDisplay.title = `Seu ID: ${currentUserId}\nNome: ${currentUserDisplayName}${isCurrentUserAdmin ? ' (Admin)' : ''}`;
                }
                if(activeBoardId) { 
                    const board = userBoardCollection.find(b => b.id === activeBoardId);
                    if(board && board.owner === currentUserId) { 
                        activeBoardData.ownerDisplayName = currentUserDisplayName;
                         // Se o quadro ativo for do usuário, atualiza o nome do proprietário na UI do quadro
                        if (currentBoardNameDisplay && activeBoardData) {
                            // Atualizar o ownerDisplayName no activeBoardData e re-renderizar a lista de membros se o modal estiver aberto
                            const boardDocRef = doc(boardsCollectionRef, activeBoardId);
                            await updateDoc(boardDocRef, { ownerDisplayName: currentUserDisplayName });
                        }
                    }
                     renderBoardList(userBoardCollection); 
                    if (activeBoardData && activeBoardData.members.includes(currentUserId)) { 
                        openBoardMembersManagementModal(activeBoardId, activeBoardData.name, activeBoardData.owner, activeBoardData.members);
                    }
                } else {
                     renderBoardList(userBoardCollection); 
                }
            } catch (error) {
                console.error("Erro ao salvar nome de exibição:", error);
                showMessageModal('Erro ao Salvar', `Não foi possível salvar o nome. Detalhes: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        });

        // --- Gerenciamento de Quadros (Boards) ---
        showCreateBoardModalButton?.addEventListener('click', () => {
            if (newBoardNameInput) newBoardNameInput.value = '';
            createBoardModal?.classList.remove('hidden');
            newBoardNameInput?.focus();
        });
        cancelCreateBoardButton?.addEventListener('click', () => createBoardModal?.classList.add('hidden'));
        confirmCreateBoardButton?.addEventListener('click', async () => {
            const boardName = newBoardNameInput.value.trim();
            if (!boardName) {
                showMessageModal('Atenção', 'O nome do quadro não pode ser vazio.', 'info');
                newBoardNameInput.focus();
                return;
            }
            if (!currentUserId || !boardsCollectionRef) {
                showMessageModal('Erro de Autenticação', 'Usuário não autenticado ou referência de quadros não pronta.', 'error');
                return;
            }
            showLoading();
            try {
                const newBoardRef = await addDoc(boardsCollectionRef, {
                    name: boardName,
                    owner: currentUserId,
                    ownerDisplayName: currentUserDisplayName, 
                    members: [currentUserId], 
                    memberTags: { [currentUserId]: 'Proprietário' },
                    createdAt: serverTimestamp()
                });
                createBoardModal?.classList.add('hidden');
                showToast(`Quadro "${boardName}" criado com sucesso!`, 'success');
            } catch (error) {
                console.error("Erro ao criar novo quadro:", error);
                showMessageModal('Erro ao Criar Quadro', `Não foi possível criar o quadro. Detalhes: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        });
        // --- SISTEMA DE CARREGAMENTO DE QUADROS DO USUÁRIO ---
        function loadUserBoardCollection() {
            if (!currentUserId || !boardsCollectionRef) {
                console.warn("loadUserBoardCollection chamado sem currentUserId ou boardsCollectionRef.");
                hideLoading();
                return;
            }
            if (unsubscribeBoardsSnapshot) unsubscribeBoardsSnapshot(); 
            showLoading();
            const q = query(boardsCollectionRef, where("members", "array-contains", currentUserId));
            unsubscribeBoardsSnapshot = onSnapshot(q, (snapshot) => {
                userBoardCollection = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                userBoardCollection.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                renderBoardList(userBoardCollection);
                hideLoading();
            }, (error) => {
                console.error("Erro ao carregar quadros do usuário:", error);
                showMessageModal('Erro ao Carregar Quadros', `Não foi possível carregar seus quadros. Detalhes: ${error.message}`, 'error');
                if (boardListContainer) boardListContainer.innerHTML = '<p class="text-red-500 text-center col-span-full">Erro ao carregar quadros.</p>';
                noBoardsMessage?.classList.remove('hidden');
                hideLoading();
            });
        }
        function renderBoardList(boards) {
             if (!boardListContainer) return;
            boardListContainer.innerHTML = '';
            if (boards.length === 0) {
                noBoardsMessage?.classList.remove('hidden');
            } else {
                noBoardsMessage?.classList.add('hidden');
                boards.forEach(board => {
                    const isOwner = board.owner === currentUserId;
                    const card = document.createElement('div');
                    card.className = 'board-card bg-white p-5 rounded-xl shadow-lg hover:shadow-xl transition-all flex flex-col justify-between min-h-[180px]';

                    const createdDate = board.createdAt?.toDate ? board.createdAt.toDate().toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' }) : 'Data N/A';
                    
                    let ownerDisplay = 'Desconhecido';
                    if (board.ownerDisplayName) {
                        ownerDisplay = board.ownerDisplayName;
                    } else if (board.owner) {
                         ownerDisplay = board.owner.substring(0, 8) + '...';
                    }
                    if (isOwner && currentUserDisplayName) { // Se o usuário atual é o dono E tem um displayName, usa ele.
                         ownerDisplay = currentUserDisplayName;
                    }

                    card.innerHTML = `
                        <div>
                            <h3 class="text-xl font-semibold text-indigo-700 mb-2 truncate" title="${board.name}">${board.name}</h3>
                            <p class="text-xs text-gray-500 mb-1">Membros: ${board.members.length}</p>
                            <p class="text-xs text-gray-500 mb-1" title="Proprietário UID: ${board.owner || 'N/A'}">Proprietário: ${ownerDisplay}</p>
                            <p class="text-xs text-gray-500 mb-3">Criado em: ${createdDate}</p>
                        </div>
                        <div class="mt-auto pt-3 border-t border-gray-100 flex flex-col space-y-2 sm:flex-row sm:justify-between sm:items-center sm:space-y-0">
                            <button class="select-board-button w-full sm:w-auto bg-indigo-500 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-indigo-600 transition-colors">
                                <i class="fas fa-sign-in-alt mr-1"></i>Abrir Quadro
                            </button>
                            ${isOwner ? `
                                <div class="flex space-x-2 justify-center sm:justify-end mt-2 sm:mt-0">
                                    <button class="edit-board-button text-blue-600 hover:text-blue-800 p-1.5 rounded-md hover:bg-blue-100 transition-colors" data-board-id="${board.id}" data-board-name="${board.name}" title="Editar Nome do Quadro">
                                        <i class="fas fa-edit fa-fw"></i>
                                    </button>
                                    <button class="manage-board-members-button text-green-600 hover:text-green-800 p-1.5 rounded-md hover:bg-green-100 transition-colors" data-board-id="${board.id}" title="Gerenciar Membros">
                                        <i class="fas fa-users fa-fw"></i>
                                    </button>
                                    <button class="delete-board-button text-red-600 hover:text-red-800 p-1.5 rounded-md hover:bg-red-100 transition-colors" data-board-id="${board.id}" data-board-name="${board.name}" title="Excluir Quadro">
                                        <i class="fas fa-trash-alt fa-fw"></i>
                                    </button>
                                </div>
                            ` : `
                                <div class="flex justify-center sm:justify-end mt-2 sm:mt-0">
                                     <button class="manage-board-members-button text-green-600 hover:text-green-800 p-1.5 rounded-md hover:bg-green-100 transition-colors" data-board-id="${board.id}" title="Ver Membros">
                                        <i class="fas fa-users fa-fw"></i>
                                    </button>
                                </div>
                            `}
                        </div>
                    `;
                    card.querySelector('.select-board-button').addEventListener('click', () => activateBoardAndSetup(board.id, board));
                    const editBtn = card.querySelector('.edit-board-button');
                    if (editBtn) { editBtn.addEventListener('click', (e) => { e.stopPropagation(); openEditBoardModal(e.currentTarget.dataset.boardId, e.currentTarget.dataset.boardName); }); }
                    const deleteBtn = card.querySelector('.delete-board-button');
                    if (deleteBtn) { deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); openDeleteBoardConfirmModal(e.currentTarget.dataset.boardId, e.currentTarget.dataset.boardName); }); }
                    const membersBtn = card.querySelector('.manage-board-members-button');
                     if (membersBtn) { membersBtn.addEventListener('click', (e) => { e.stopPropagation(); const targetBoard = userBoardCollection.find(b => b.id === e.currentTarget.dataset.boardId); if (targetBoard) { openBoardMembersManagementModal(targetBoard.id, targetBoard.name, targetBoard.owner, targetBoard.members); } }); }
                    boardListContainer.appendChild(card);
                });
            }
        }
        function openEditBoardModal(boardId, currentName) { 
            if (!editBoardModal || !editBoardIdInput || !currentBoardNameStatic || !newBoardNameEditInput) return;
            editBoardIdInput.value = boardId;
            currentBoardNameStatic.textContent = currentName;
            currentBoardNameStatic.title = currentName;
            newBoardNameEditInput.value = currentName;
            editBoardModal.classList.remove('hidden');
            newBoardNameEditInput.focus();
            newBoardNameEditInput.select();
        }
        cancelEditBoardButton?.addEventListener('click', () => editBoardModal.classList.add('hidden'));
        confirmEditBoardButton?.addEventListener('click', async () => { 
            const boardId = editBoardIdInput.value;
            const newName = newBoardNameEditInput.value.trim();
            if (!newName) { showMessageModal('Atenção', 'O novo nome do quadro não pode ser vazio.', 'info'); newBoardNameEditInput.focus(); return; }
            if (!boardId || !boardsCollectionRef) { showMessageModal('Erro', 'ID do quadro ou referência da coleção não encontrados.', 'error'); return; }
            showLoading();
            const boardRef = doc(boardsCollectionRef, boardId);
            try {
                await updateDoc(boardRef, { name: newName });
                showToast('Nome do quadro atualizado!', 'success');
                editBoardModal.classList.add('hidden');
            } catch (error) { console.error("Erro ao atualizar nome do quadro:", error); showMessageModal('Erro ao Atualizar', `Não foi possível atualizar. Detalhes: ${error.message}`, 'error');
            } finally { hideLoading(); }
        });
        function openDeleteBoardConfirmModal(boardId, boardName) { 
            if (!deleteBoardConfirmModal || !deleteBoardIdInputConfirm || !deleteBoardNameActualConfirm || !deleteBoardNameDisplayConfirm || !deleteBoardNameConfirmInput) return;
            deleteBoardIdInputConfirm.value = boardId;
            deleteBoardNameActualConfirm.value = boardName;
            deleteBoardNameDisplayConfirm.textContent = boardName;
            deleteBoardNameConfirmInput.value = '';
            deleteBoardConfirmError.classList.add('hidden');
            deleteBoardConfirmModal.classList.remove('hidden');
            deleteBoardNameConfirmInput.focus();
        }
        cancelDeleteBoardConfirmButton?.addEventListener('click', () => deleteBoardConfirmModal.classList.add('hidden'));
        confirmDeleteBoardFinalButton?.addEventListener('click', async () => { 
            const boardId = deleteBoardIdInputConfirm.value;
            const actualName = deleteBoardNameActualConfirm.value;
            const typedName = deleteBoardNameConfirmInput.value.trim();
            if (typedName !== actualName) { deleteBoardConfirmError.textContent = 'O nome digitado não corresponde.'; deleteBoardConfirmError.classList.remove('hidden'); deleteBoardNameConfirmInput.focus(); return; }
            deleteBoardConfirmError.classList.add('hidden');
            if (!boardId || !boardsCollectionRef) { showMessageModal('Erro', 'ID do quadro ou ref. não encontrados.', 'error'); return; }
            showLoading();
            const boardRef = doc(boardsCollectionRef, boardId);
            try {
                const tasksPath = `artifacts/${appIdFromGlobal}/boards/${boardId}/tasks`;
                const tasksQuery = query(collection(db, tasksPath));
                const tasksSnapshot = await getDocs(tasksQuery);
                const taskBatch = writeBatch(db);
                tasksSnapshot.forEach(taskDoc => taskBatch.delete(taskDoc.ref));
                await taskBatch.commit();
                const columnsPath = `artifacts/${appIdFromGlobal}/boards/${boardId}/columns`;
                const columnsQuery = query(collection(db, columnsPath));
                const columnsSnapshot = await getDocs(columnsQuery);
                const columnBatch = writeBatch(db);
                columnsSnapshot.forEach(columnDoc => columnBatch.delete(columnDoc.ref));
                await columnBatch.commit();
                await deleteDoc(boardRef);
                showToast(`Quadro "${actualName}" e conteúdo excluídos!`, 'success');
                deleteBoardConfirmModal.classList.add('hidden');
                if (activeBoardId === boardId) { backToBoardsButton.click(); }
            } catch (error) { console.error("Erro ao excluir quadro:", error); showMessageModal('Erro ao Excluir', `Não foi possível excluir. Detalhes: ${error.message}`, 'error');
            } finally { hideLoading(); }
        });
        // --- SISTEMA DE ATIVAÇÃO E CONFIGURAÇÃO DE QUADROS ---
        async function activateBoardAndSetup(boardId, boardData) { 
            activeBoardId = boardId;
            activeBoardData = boardData;
            // Sincronizar com o escopo global para as funções restauradas
            window.activeBoardData = boardData;
            if (currentBoardNameDisplay) { currentBoardNameDisplay.textContent = boardData.name; currentBoardNameDisplay.title = boardData.name; }
            if (showManageMembersModalButton) { showManageMembersModalButton.classList.toggle('hidden', boardData.owner !== currentUserId); }
            boardManagementSection?.classList.add('hidden');
            kanbanSection?.classList.remove('hidden');
            if (unsubscribeColumnsSnapshot) unsubscribeColumnsSnapshot();
            if (unsubscribeTasksSnapshot) unsubscribeTasksSnapshot();
            boardColumns = []; boardTasks = [];
            if (kanbanBoard) kanbanBoard.innerHTML = '<p class="text-gray-500 p-4 text-center w-full">Carregando colunas e tarefas...</p>';
            columnsCollectionRef = collection(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}/columns`);
            tasksCollectionRef = collection(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}/tasks`);
            
            // ---> INÍCIO DO LISTENER DE ATUALIZAÇÃO DO QUADRO
            // Listener para o próprio documento do quadro, para atualizações em tempo real (ex: permissões)
            const boardDocRef = doc(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}`);
            onSnapshot(boardDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    console.log("Dados do quadro atualizados em tempo real.");
                    const updatedBoardData = { id: docSnap.id, ...docSnap.data() };
                    activeBoardData = updatedBoardData;
                    window.activeBoardData = updatedBoardData; // Sincroniza globalmente

                    // Re-renderiza o quadro com as permissões e dados atualizados
                    applyFiltersAndRender(boardTasks);
                }
            });
            // ---> FIM DO LISTENER
            
            loadAndListenToColumns();
            setupBoardChat(boardId, boardData);
        }
        backToBoardsButton?.addEventListener('click', () => { 
            activeBoardId = null; activeBoardData = null; window.activeBoardData = null;
            kanbanSection?.classList.add('hidden');
            boardManagementSection?.classList.remove('hidden');
            if (unsubscribeColumnsSnapshot) unsubscribeColumnsSnapshot();
            if (unsubscribeTasksSnapshot) unsubscribeTasksSnapshot();
        });

        // --- SISTEMA DE GERENCIAMENTO DE MEMBROS DO QUADRO ---
        async function openBoardMembersManagementModal(boardId, boardName, ownerId, members) {
            if (!manageMembersModal || !manageMembersBoardIdInput || !memberListContainer || !newMemberIdInput) return;
            manageMembersBoardIdInput.value = boardId;
            
            console.log("Abrindo modal de gerenciamento de membros para o quadro:", boardId, boardName);
            
            // Verifica se estamos dentro de um quadro ativo ou fora dele
            const isInsideBoard = kanbanSection && !kanbanSection.classList.contains('hidden');
            console.log("Estado do quadro:", isInsideBoard ? "Dentro do quadro" : "Fora do quadro", kanbanSection?.classList.contains('hidden'));
            
            // Ajusta o título do modal
            if (isInsideBoard) {
                manageMembersModal.querySelector('h3').textContent = `Membros de: ${boardName}`;
            } else {
                const titleElement = manageMembersModal.querySelector('h3');
                titleElement.innerHTML = `Adicionar Membro<br><span class="text-lg text-indigo-600">Quadro: ${boardName}</span>`;
            }
            
            newMemberIdInput.value = '';
            const isCurrentUserOwnerOfBoard = ownerId === currentUserId;
            
            // Configura o campo de adicionar membro
            newMemberIdInput.disabled = !isCurrentUserOwnerOfBoard;
            addMemberButton.disabled = !isCurrentUserOwnerOfBoard;
            if (!isCurrentUserOwnerOfBoard) {
                newMemberIdInput.placeholder = "Apenas o proprietário do quadro pode adicionar membros";
                addMemberButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                newMemberIdInput.placeholder = "UID do novo membro";
                addMemberButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            // Remove avisos anteriores
            document.getElementById('membersPermNotice')?.remove();
            document.getElementById('ownerInstructions')?.remove();
            document.getElementById('nonOwnerPermissionsBtn')?.remove();
            document.getElementById('outsideBoardNotice')?.remove();
            
            // Adiciona aviso quando acessado fora do quadro
            if (!isInsideBoard) {
                const outsideBoardNotice = document.createElement('div');
                outsideBoardNotice.id = 'outsideBoardNotice';
                outsideBoardNotice.className = 'mb-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-700 text-sm';
                outsideBoardNotice.innerHTML = `
                    <div class="flex items-center mb-2">
                        <i class="fas fa-info-circle text-yellow-600 mr-2 text-lg"></i>
                        <span class="font-semibold">Modo de adição rápida</span>
                    </div>
                    <p class="mb-2">Você está adicionando membros fora do quadro. Para acessar todas as funcionalidades de gerenciamento de membros, entre no quadro.</p>
                    <p class="text-xs font-medium">Para configurar permissões e gerenciar cargos, acesse o quadro e clique em "Gerenciar Membros".</p>
                `;
                const addMemberSection = document.querySelector('#manageMembersModal .mb-6');
                if (addMemberSection) {
                    addMemberSection.appendChild(outsideBoardNotice);
                }
                
                // Quando fora do quadro, mostra uma versão simplificada dos membros
                const membersSectionContainer = document.getElementById('membersSectionContainer');
                if (membersSectionContainer) {
                    membersSectionContainer.style.display = 'none';
                }
                
                // Remover visualização anterior se existir
                const existingView = document.getElementById('simpleMembersView');
                if (existingView) {
                    existingView.remove();
                }
                
                // Criar uma seção para mostrar os membros de forma intuitiva
                const simpleMembersView = document.createElement('div');
                simpleMembersView.id = 'simpleMembersView';
                simpleMembersView.className = 'mt-4 pt-4 border-t border-gray-200';
                
                // Título da seção
                const membersTitle = document.createElement('div');
                membersTitle.className = 'flex items-center mb-3';
                membersTitle.innerHTML = `
                    <i class="fas fa-users text-indigo-500 mr-2"></i>
                    <h4 class="text-base font-medium text-gray-700">Membros do Quadro</h4>
                    <span class="ml-2 bg-indigo-100 text-indigo-800 text-xs font-medium px-2 py-0.5 rounded-full">${members.length}</span>
                `;
                simpleMembersView.appendChild(membersTitle);
                
                // Container para os cards de membros
                const membersGrid = document.createElement('div');
                membersGrid.className = 'bg-gray-50 rounded-lg p-3 max-h-[200px] overflow-y-auto';
                simpleMembersView.appendChild(membersGrid);
                
                // Buscar os dados atualizados do quadro para garantir os cargos mais recentes
                let currentBoardData;
                try {
                    // Buscar dados atualizados diretamente do Firestore para garantir os cargos mais recentes
                    const boardDocRef = doc(boardsCollectionRef, boardId); // Usar boardId em vez de activeBoardId
                    const boardDoc = await getDoc(boardDocRef);
                    if (boardDoc.exists()) {
                        currentBoardData = boardDoc.data();
                        // Atualizar a variável activeBoardData para uso nas funções subsequentes
                        activeBoardData = currentBoardData;
                window.activeBoardData = currentBoardData;
                        console.log("Dados do quadro atualizados:", currentBoardData);
                        // Verificar se há tags de membros
                        if (currentBoardData.memberTags) {
                            console.log("Tags de membros encontradas:", currentBoardData.memberTags);
                        } else {
                            console.log("Nenhuma tag de membro encontrada no quadro");
                        }
                    } else {
                        console.warn("Documento do quadro não encontrado");
                    }
                } catch (e) {
                    console.error("Erro ao buscar dados do quadro:", e);
                }
                
                // Se não houver membros, mostrar mensagem
                if (members.length === 0) {
                    membersGrid.innerHTML = '<p class="text-center text-gray-500 py-3">Nenhum membro neste quadro.</p>';
                } else {
                    // Criar um grid para os membros
                    const membersContainer = document.createElement('div');
                    membersContainer.className = 'grid grid-cols-1 gap-2';
                    membersGrid.appendChild(membersContainer);
                    
                    // Carregar os dados dos membros
                    showLoading();
                    Promise.all(members.map(async (memberId) => {
                        let displayName = memberId.substring(0, 8) + '...';
                        let isProfileOwnerOfBoard = memberId === ownerId;
                        let memberAvatar = '';
                        
                        try {
                            const profileDocRef = doc(userProfilesCollectionRef, memberId);
                            const profileDoc = await getDoc(profileDocRef);
                            if (profileDoc.exists()) {
                                const profileData = profileDoc.data();
                                displayName = profileData.displayName || profileData.email || displayName;
                                // Primeira letra para o avatar
                                memberAvatar = (displayName.charAt(0) || '?').toUpperCase();
                            }
                        } catch (e) {
                            console.warn("Erro ao buscar perfil:", memberId, e);
                        }
                        
                                                 // Buscar o cargo/tag mais recente do banco de dados
                        let tag = '';
                        
                        // Verificar se temos dados do quadro e tags de membros
                        if (currentBoardData && currentBoardData.memberTags && memberId in currentBoardData.memberTags) {
                            tag = currentBoardData.memberTags[memberId];
                            console.log(`Tag encontrada para membro ${memberId}: "${tag}"`);
                        } else {
                            console.log(`Nenhuma tag encontrada para membro ${memberId}`);
                            // Tentar buscar no activeBoardData como fallback
                            if (activeBoardData && activeBoardData.memberTags && memberId in activeBoardData.memberTags) {
                                tag = activeBoardData.memberTags[memberId];
                                console.log(`Tag encontrada no fallback para membro ${memberId}: "${tag}"`);
                            }
                        }
                        
                        // Criar o card do membro
                        const memberCard = document.createElement('div');
                        memberCard.className = 'flex items-center bg-white p-2 rounded-lg shadow-sm border border-gray-100';
                        
                        // Gerar cor de fundo para o avatar baseada no ID
                        const avatarColors = ['bg-blue-100', 'bg-green-100', 'bg-purple-100', 'bg-pink-100', 'bg-yellow-100', 'bg-indigo-100', 'bg-red-100'];
                        const colorIndex = Math.abs(memberId.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0)) % avatarColors.length;
                        const avatarBgColor = avatarColors[colorIndex];
                        const avatarTextColor = avatarBgColor.replace('100', '700');
                        
                        memberCard.innerHTML = `
                            <div class="flex-shrink-0 w-8 h-8 ${avatarBgColor} ${avatarTextColor} rounded-full flex items-center justify-center font-bold text-sm mr-2">
                                ${memberAvatar}
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-800 truncate" title="${displayName}">
                                    ${displayName} ${isProfileOwnerOfBoard ? '<span class="text-xs text-green-600 ml-1">(Proprietário)</span>' : ''}
                                </p>
                                ${tag ? `
                                <p class="text-xs text-gray-500 flex items-center">
                                    <i class="fas fa-tag text-xs mr-1 text-indigo-400"></i>
                                    <span class="truncate">${tag}</span>
                                </p>` : 
                                `<p class="text-xs text-gray-400 italic">Sem cargo</p>`}
                            </div>
                        `;
                        
                        return memberCard;
                    })).then(memberCards => {
                        hideLoading();
                        memberCards.forEach(card => membersContainer.appendChild(card));
                    }).catch(err => {
                        hideLoading();
                        console.error("Erro ao carregar membros:", err);
                        membersGrid.innerHTML = '<p class="text-center text-red-500 py-3">Erro ao carregar membros.</p>';
                    });
                }
                
                // Adicionar a visualização ao modal
                const addMemberSectionElement = document.querySelector('#manageMembersModal .mb-6');
                if (addMemberSectionElement && addMemberSectionElement.parentNode) {
                    addMemberSectionElement.parentNode.insertBefore(simpleMembersView, addMemberSectionElement.nextSibling);
                }
                
                manageMembersModal.classList.remove('hidden');
                return; // Retorna aqui para não carregar a lista de membros
            }
            
            // Continua com o comportamento normal quando dentro do quadro
            const membersSectionContainer = document.getElementById('membersSectionContainer');
            if (membersSectionContainer) {
                membersSectionContainer.style.display = 'block';
            }
            
            // Remover a visualização simplificada se existir
            const existingView = document.getElementById('simpleMembersView');
            if (existingView) {
                existingView.remove();
            }
            
            memberListContainer.innerHTML = '<li class="text-center text-gray-500 p-2">Carregando membros...</li>';
            const memberTags = (activeBoardData && activeBoardData.memberTags) ? activeBoardData.memberTags : {};
            
            const memberItemsPromises = members.map(async (memberId) => {
                let displayName = memberId.substring(0, 12) + '...';
                let memberEmail = 'Email não disponível';
                let isProfileOwnerOfBoard = memberId === ownerId;
                try {
                    const profileDocRef = doc(userProfilesCollectionRef, memberId);
                    const profileDoc = await getDoc(profileDocRef);
                    if (profileDoc.exists()) {
                        const profileData = profileDoc.data();
                        displayName = profileData.displayName || profileData.email || displayName;
                        memberEmail = profileData.email || memberEmail;
                    }
                } catch (e) {
                    console.warn("Erro ao buscar perfil para membro:", memberId, e);
                }
                const tag = memberTags[memberId] || '';
                const li = document.createElement('li');
                li.className = 'bg-white rounded-lg shadow-sm';
                const tagBadgeHtml = tag ? `<span class='ml-2 inline-block bg-blue-100 text-blue-700 text-xs font-semibold px-2 py-0.5 rounded align-middle'>${tag}</span>` : '';
                // Layout: badge ao lado do nome/email, campo de edição abaixo
                li.innerHTML = `
                    <div class="relative bg-white rounded-xl shadow border border-gray-200 p-4 mb-3 flex flex-col gap-2 transition hover:shadow-lg">
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center flex-wrap">
                                <span class="font-semibold text-gray-800 text-base truncate max-w-[180px] sm:max-w-xs" title="${displayName}">${displayName}</span>
                                ${isProfileOwnerOfBoard ? '<span class="ml-2 text-xs text-green-600 font-semibold whitespace-nowrap">(Proprietário do Quadro)</span>' : ''}
                                ${tagBadgeHtml}
                            </div>
                            ${isCurrentUserOwnerOfBoard && memberId !== ownerId ?
                                `<button class="remove-member-button text-red-500 hover:text-red-700 text-sm p-1 rounded-full hover:bg-red-50 transition ml-2" data-member-id="${memberId}" title="Remover Membro">
                                    <i class="fas fa-trash-alt"></i>
                                </button>` : ''}
                        </div>
                        <div class="flex items-center flex-wrap mt-1">
                            <div class="flex items-center mr-2 ${isCurrentUserOwnerOfBoard ? 'mb-2 sm:mb-0' : ''}">
                                <label class="text-xs text-gray-500 font-medium mr-1">Cargo:</label>
                                ${!isCurrentUserOwnerOfBoard ? 
                                    (tag ? `<span class="ml-1 text-xs bg-blue-100 text-blue-700 font-semibold px-2 py-0.5 rounded">${tag}</span>` : 
                                    '<span class="ml-1 text-xs text-gray-400">Sem cargo</span>') : ''}
                            </div>
                            ${isCurrentUserOwnerOfBoard ?
                                `<div class="flex items-center flex-grow">
                                    <input type="text" class="member-tag-input px-2 py-1 border border-gray-300 rounded text-xs w-full sm:w-40 focus:ring-2 focus:ring-blue-400 transition" placeholder="Defina um cargo para este membro" value="${tag}" data-member-id="${memberId}" />
                                    <button class="save-tag-btn bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded transition-colors flex items-center ml-2" data-member-id="${memberId}">
                                        <i class='fas fa-save mr-1'></i>Salvar
                                    </button>
                                </div>` : ''}
                        </div>
                    </div>
                `;
                if (isCurrentUserOwnerOfBoard) {
                    li.querySelector('.save-tag-btn')?.addEventListener('click', async (e) => {
                        // Busca o input dentro do mesmo card do botão clicado
                        const cardDiv = e.currentTarget.closest('.relative');
                        const input = cardDiv ? cardDiv.querySelector('.member-tag-input') : null;
                        const newTag = input ? input.value.trim() : '';
                        const memberIdToUpdate = e.currentTarget.dataset.memberId;
                        if (!activeBoardId || !boardsCollectionRef) return;
                        showLoading();
                        try {
                            const boardRef = doc(boardsCollectionRef, activeBoardId);
                            await updateDoc(boardRef, { [`memberTags.${memberIdToUpdate}`]: newTag });
                            if (!activeBoardData.memberTags) activeBoardData.memberTags = {};
                            activeBoardData.memberTags[memberIdToUpdate] = newTag;
                            showToast('Cargo/Tag atualizado!', 'success');
                            openBoardMembersManagementModal(activeBoardId, activeBoardData.name, activeBoardData.owner, activeBoardData.members);
                        } catch (err) {
                            showToast('Erro ao salvar cargo/tag: ' + err.message, 'error');
                        } finally {
                            hideLoading();
                        }
                    });
                }
                if (isCurrentUserOwnerOfBoard && memberId !== ownerId) {
                    li.querySelector('.remove-member-button')?.addEventListener('click', () => handleRemoveMember(boardId, memberId));
                }
                return li;
            });
            const resolvedMemberItems = await Promise.all(memberItemsPromises);
            memberListContainer.innerHTML = '';
            if (resolvedMemberItems.length > 0) {
                resolvedMemberItems.forEach(item => memberListContainer.appendChild(item));
            } else {
                memberListContainer.innerHTML = '<li class="text-center text-gray-500 p-2">Nenhum membro neste quadro ainda.</li>';
            }
            
            manageMembersModal.classList.remove('hidden');
            
            // Adiciona avisos visuais úteis no modal
            let permNotice = document.createElement('div');
            permNotice.id = 'membersPermNotice';
            permNotice.className = 'mb-3 p-2 bg-blue-50 border border-blue-200 rounded text-blue-700 text-xs font-medium';
            permNotice.innerHTML = `<i class='fas fa-info-circle mr-1'></i>As permissões e cargos valem <b>apenas para este quadro</b>.`;
            const membersSectionContainerForPermissions = document.getElementById('membersSectionContainer');
            if (membersSectionContainerForPermissions) {
                membersSectionContainerForPermissions.insertBefore(permNotice, memberListContainer);
            }
            
            // Adiciona instruções para proprietários do quadro
            if (isCurrentUserOwnerOfBoard) {
                let ownerInstructions = document.createElement('div');
                ownerInstructions.id = 'ownerInstructions';
                ownerInstructions.className = 'mt-3 p-2 bg-indigo-50 border border-indigo-200 rounded text-indigo-700 text-xs';
                ownerInstructions.innerHTML = `
                    <p class="font-medium mb-1"><i class="fas fa-lightbulb mr-1"></i>Dicas para o proprietário:</p>
                    <ul class="list-disc pl-5 space-y-1">
                        <li>Digite um cargo (como "Supervisor", "Administrador") no campo e clique em "Salvar"</li>
                        <li>Membros podem ser removidos clicando no ícone de lixeira</li>
                        <li>O cargo define as permissões que o membro terá neste quadro</li>
                    </ul>
                    <button id="managePermissionsBtn" class="w-full mt-3 bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded flex items-center justify-center transition-colors">
                        <i class="fas fa-shield-alt mr-2"></i>Configurar Permissões dos Cargos
                    </button>
                `;
                document.getElementById('membersSectionContainer')?.appendChild(ownerInstructions);
                
                // Adiciona função ao botão de permissões
                document.getElementById('managePermissionsBtn')?.addEventListener('click', () => {
                    manageMembersModal.classList.add('hidden'); // Esconde o modal de membros
                    if (activeBoardData) {
                        openPermissionsModal(activeBoardData); // Abre o modal de permissões
                    }
                });
            }

            // Verifica se o usuário atual tem permissão para gerenciar permissões
            if (!isCurrentUserOwnerOfBoard && hasPermission(activeBoardData, currentUserId, 'canManageRolePermissions')) {
                let permSettingsBtn = document.createElement('div');
                permSettingsBtn.id = 'nonOwnerPermissionsBtn';
                permSettingsBtn.className = 'mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-yellow-800';
                permSettingsBtn.innerHTML = `
                    <p class="font-medium mb-2 text-xs"><i class="fas fa-user-shield mr-1"></i>Você tem permissão para configurar o acesso aos recursos:</p>
                    <button class="bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded flex items-center justify-center transition-colors w-full text-xs">
                        <i class="fas fa-cog mr-2"></i>Configurar Permissões dos Cargos
                    </button>
                `;
                permSettingsBtn.querySelector('button').onclick = () => {
                    manageMembersModal.classList.add('hidden'); // Esconde o modal de membros
                    if (activeBoardData) {
                        openPermissionsModal(activeBoardData); // Abre o modal de permissões
                    }
                };
                document.getElementById('membersSectionContainer')?.appendChild(permSettingsBtn);
            }
        }

        showManageMembersModalButton?.addEventListener('click', () => { 
            if (activeBoardData) { 
                openBoardMembersManagementModal(activeBoardId, activeBoardData.name, activeBoardData.owner, activeBoardData.members); 
            } 
        });
        closeManageMembersModalButton?.addEventListener('click', () => manageMembersModal.classList.add('hidden'));
        
        addMemberButton?.addEventListener('click', async () => {
            const boardId = manageMembersBoardIdInput.value;
            const memberIdToAdd = newMemberIdInput.value.trim();
            if (!memberIdToAdd) { showToast('Insira o UID do membro.', 'info'); return; }
            if (!boardId || !boardsCollectionRef) { showToast('Erro: ID do quadro não encontrado.', 'error'); return; }
            if (memberIdToAdd.length < 20) { showToast('UID inválido. Verifique o ID completo.', 'info'); return; }
            if (activeBoardData && activeBoardData.owner !== currentUserId) {
                showToast('Apenas o proprietário do quadro pode adicionar novos membros.', 'error');
                return;
            }
            showLoading();
            const boardRef = doc(boardsCollectionRef, boardId);
            try {
                const userProfileRef = doc(userProfilesCollectionRef, memberIdToAdd);
                const userProfileSnap = await getDoc(userProfileRef);
                if (!userProfileSnap.exists()) {
                    showToast(`Usuário com UID ${memberIdToAdd.substring(0,6)}... não encontrado. O usuário precisa existir no sistema.`, 'error', 6000);
                    hideLoading();
                    return;
                }
                // Adiciona membro e já cria tag vazia
                await updateDoc(boardRef, { members: arrayUnion(memberIdToAdd), [`memberTags.${memberIdToAdd}`]: '' });
                showToast('Membro adicionado!', 'success');
                newMemberIdInput.value = '';
                const updatedBoardDoc = await getDoc(boardRef);
                if (updatedBoardDoc.exists()) {
                    const updatedBoardData = { id: updatedBoardDoc.id, ...updatedBoardDoc.data() };
                    if (activeBoardId === boardId) {
                        activeBoardData = updatedBoardData;
                        window.activeBoardData = updatedBoardData;
                    }
                    openBoardMembersManagementModal(boardId, updatedBoardData.name, updatedBoardData.owner, updatedBoardData.members);
                }
            } catch (error) {
                console.error("Erro ao adicionar membro:", error);
                showToast(`Erro ao adicionar membro: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        });

        async function handleRemoveMember(boardId, memberIdToRemove) {
            // ---> INÍCIO DA VERIFICAÇÃO DE SEGURANÇA
            if (!hasPermission(activeBoardData, currentUserId, 'canRemoveMember')) {
                showToast('Você não tem permissão para remover membros.', 'error');
                return;
            }
            // ---> FIM DA VERIFICAÇÃO
            
            if (!boardId || !memberIdToRemove || !boardsCollectionRef) { showToast('Erro ao remover (dados faltando).', 'error'); return; }
            if (activeBoardData && activeBoardData.owner !== currentUserId) {
                showToast('Apenas o proprietário do quadro pode remover membros.', 'error');
                return;
            }
            if (memberIdToRemove === activeBoardData.owner) {
                showToast('O proprietário não pode ser removido do quadro.', 'info');
                return;
            }
            showLoading();
            const boardRef = doc(boardsCollectionRef, boardId);
            try {
                // Remove membro e a tag/cargo dele
                await updateDoc(boardRef, { members: arrayRemove(memberIdToRemove), [`memberTags.${memberIdToRemove}`]: deleteField() });
                showToast('Membro removido!', 'success');
                const updatedBoardDoc = await getDoc(boardRef);
                if (updatedBoardDoc.exists()) {
                    const updatedBoardData = { id: updatedBoardDoc.id, ...updatedBoardDoc.data() };
                    if (activeBoardId === boardId) {
                        activeBoardData = updatedBoardData;
                        window.activeBoardData = updatedBoardData;
                    }
                    openBoardMembersManagementModal(boardId, updatedBoardData.name, updatedBoardData.owner, updatedBoardData.members);
                }
            } catch (error) {
                console.error("Erro ao remover membro:", error);
                showToast(`Erro ao remover: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // --- SISTEMA DE GERENCIAMENTO DE COLUNAS DO KANBAN ---
        showAddColumnModalButton?.addEventListener('click', () => { 
            if (newColumnTitleInput) newColumnTitleInput.value = '';
            addColumnModal?.classList.remove('hidden'); newColumnTitleInput?.focus();
        });
        cancelAddColumnButton?.addEventListener('click', () => addColumnModal.classList.add('hidden'));
        confirmAddColumnButton?.addEventListener('click', async () => { 
            const title = newColumnTitleInput.value.trim();
            if (!title) { showMessageModal('Atenção', 'Título da coluna é obrigatório.', 'info'); newColumnTitleInput.focus(); return; }
            if (!activeBoardId || !columnsCollectionRef) { showMessageModal('Erro Crítico', 'Quadro não ativo ou ref. não pronta.', 'error'); return; }
            showLoading();
            const newOrder = boardColumns.length > 0 ? Math.max(0, ...boardColumns.map(c => c.order || 0)) + 1 : 0;
            const newColor = defaultColumnColors[boardColumns.length % defaultColumnColors.length];
            try {
                await addDoc(columnsCollectionRef, { title, order: newOrder, color: newColor, createdAt: serverTimestamp(), boardId: activeBoardId });
                addColumnModal?.classList.add('hidden'); showToast('Coluna adicionada!', 'success');
            } catch (error) { console.error("Erro ao adicionar coluna:", error); showMessageModal('Erro ao Adicionar', `Não foi possível adicionar. Detalhes: ${error.message}`, 'error');
            } finally { hideLoading(); }
        });
        saveEditColumnButton?.addEventListener('click', async () => { 
            // ---> INÍCIO DA VERIFICAÇÃO DE SEGURANÇA
            if (!hasPermission(activeBoardData, currentUserId, 'canEditColumn')) {
                showToast('Você não tem permissão para editar colunas.', 'error');
                return;
            }
            // ---> FIM DA VERIFICAÇÃO
            
            const columnId = editColumnIdInput.value;
            const newTitle = editColumnTitleInput.value.trim();
            const newColor = editColumnColorInput.value;
            if (!newTitle) { showMessageModal('Atenção', 'Título é obrigatório.', 'info'); editColumnTitleInput.focus(); return; }
            if (!newColor) { showMessageModal('Atenção', 'Cor é obrigatória.', 'info'); return; }
            if (!columnsCollectionRef) { showMessageModal('Erro', 'Ref. de colunas não pronta.', 'error'); return; }
            showLoading();
            const columnRef = doc(columnsCollectionRef, columnId);
            try {
                await updateDoc(columnRef, { title: newTitle, color: newColor });
                editColumnModal?.classList.add('hidden'); showToast('Coluna atualizada!', 'success');
            } catch (error) { console.error("Erro ao atualizar coluna:", error); showMessageModal('Erro ao Atualizar', `Não foi possível atualizar. Detalhes: ${error.message}`, 'error');
            } finally { hideLoading(); }
        });
        cancelEditColumnButton?.addEventListener('click', () => editColumnModal.classList.add('hidden'));
        async function deleteColumn(columnId, columnTitle) { 
            // ---> INÍCIO DA VERIFICAÇÃO DE SEGURANÇA
            if (!hasPermission(activeBoardData, currentUserId, 'canDeleteColumn')) {
                showToast('Você não tem permissão para excluir colunas.', 'error');
                return;
            }
            // ---> FIM DA VERIFICAÇÃO
            
            if (boardColumns.length <= 1) { showMessageModal('Ação Não Permitida', 'Não pode excluir a última coluna.', 'info'); return; }
            const targetColumnForTasks = boardColumns.filter(col => col.id !== columnId).sort((a,b) => (a.order || 0) - (b.order || 0))[0];
            if (!targetColumnForTasks) { showMessageModal('Erro Crítico', 'Coluna de destino não encontrada.', 'error'); return; }
            const message = `Excluir coluna "${columnTitle}"? Tarefas serão movidas para "${targetColumnForTasks.title}".`;
            showMessageModal('Confirmar Exclusão', message, 'warning', async () => {
                if (!columnsCollectionRef || !tasksCollectionRef) { showMessageModal('Erro', 'Refs. não prontas.', 'error'); return; }
                showLoading();
                try {
                    const batch = writeBatch(db);
                    const tasksToMoveQuery = query(tasksCollectionRef, where("status", "==", columnId));
                    const tasksToMoveSnapshot = await getDocs(tasksToMoveQuery);
                    tasksToMoveSnapshot.forEach(taskDoc => { batch.update(doc(tasksCollectionRef, taskDoc.id), { status: targetColumnForTasks.id }); });
                    batch.delete(doc(columnsCollectionRef, columnId));
                    await batch.commit(); showToast(`Coluna "${columnTitle}" excluída.`, 'success');
                } catch (error) { console.error("Erro ao excluir coluna:", error); showMessageModal('Erro ao Excluir', `Não foi possível excluir. Detalhes: ${error.message}`, 'error');
                } finally { hideLoading(); }
            }, 'Excluir Coluna', true, 'Cancelar');
        }
        function openEditColumnModal(columnId, currentTitle) { 
            const column = boardColumns.find(c => c.id === columnId);
            if (!column) { console.error("Coluna não encontrada:", columnId); showMessageModal('Erro', 'Coluna não encontrada.', 'error'); return; }
            if (editColumnIdInput) editColumnIdInput.value = columnId;
            if (editColumnTitleInput) editColumnTitleInput.value = currentTitle;
            if (editColumnColorInput) editColumnColorInput.value = column.color || defaultColumnColors[0];
            populateColorPicker(editColumnColorPicker, column.color || defaultColumnColors[0], editColumnColorInput);
            if (editColumnModal) { editColumnModal.classList.remove('hidden'); if (editColumnTitleInput) editColumnTitleInput.focus(); }
        }

        function loadAndListenToColumns() { 
            if (!columnsCollectionRef) { console.error("loadAndListenToColumns: columnsCollectionRef não definida."); kanbanBoard.innerHTML = '<p class="text-red-500 p-4 text-center w-full">Erro: Ref. colunas.</p>'; hideLoading(); return; }
            if (unsubscribeColumnsSnapshot) unsubscribeColumnsSnapshot();
            showLoading();
            const q = query(columnsCollectionRef, orderBy("order"));
            unsubscribeColumnsSnapshot = onSnapshot(q, async (snapshot) => {
                if (snapshot.empty && activeBoardId) { await createDefaultColumnsForBoard(); return; }
                boardColumns = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
                loadAndListenToTasks();
            }, (error) => { console.error("Erro ao carregar colunas:", error); showMessageModal('Erro Colunas', `Erro: ${error.message}`, 'error'); kanbanBoard.innerHTML = `<p class="text-red-500 p-4 text-center w-full">Erro colunas: ${error.message}.</p>`; hideLoading(); });
        }
        async function createDefaultColumnsForBoard() { 
            if (!columnsCollectionRef || !activeBoardId) { console.error("createDefaultColumnsForBoard: Quadro não ativo ou ref. não pronta."); hideLoading(); return; }
            showLoading(); const batch = writeBatch(db);
            const defaultColsData = [ { title: 'A Fazer', order: 0, color: defaultColumnColors[0] }, { title: 'Em Andamento', order: 1, color: defaultColumnColors[1] }, { title: 'Concluído', order: 2, color: defaultColumnColors[2] } ];
            defaultColsData.forEach(colData => { const newColRef = doc(columnsCollectionRef); batch.set(newColRef, { ...colData, createdAt: serverTimestamp(), boardId: activeBoardId }); });
            try { await batch.commit(); showToast('Colunas padrão criadas!', 'info');
            } catch (error) { console.error("Erro criar colunas padrão:", error); showMessageModal('Erro Colunas Padrão', `Erro: ${error.message}`, 'error'); }
        }
        function loadAndListenToTasks() { 
            if (!tasksCollectionRef) { console.error("loadAndListenToTasks: tasksCollectionRef não definida."); kanbanBoard.innerHTML = '<p class="text-red-500 p-4 text-center w-full">Erro: Ref. tarefas.</p>'; hideLoading(); return; }
            if (unsubscribeTasksSnapshot) unsubscribeTasksSnapshot();
            showLoading(); 
            const qTasks = query(tasksCollectionRef, orderBy("createdAt", "desc"));
            unsubscribeTasksSnapshot = onSnapshot(qTasks, (snapshot) => {
                boardTasks = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
                applyFiltersAndRender(boardTasks);
                            }, (error) => { console.error("Erro carregar tarefas:", error); showMessageModal('Erro Tarefas', `Erro: ${error.message}`, 'error'); if (kanbanBoard && boardColumns.length > 0) { renderKanbanBoard([]); } else { kanbanBoard.innerHTML = `<p class="text-red-500 p-4 text-center w-full">Erro tarefas: ${error.message}.</p>`; } hideLoading(); });
        }
        taskSearchInput?.addEventListener('input', () => applyFiltersAndRender(boardTasks));
        filterPrioritySelect?.addEventListener('change', () => applyFiltersAndRender(boardTasks));
        function applyFiltersAndRender(tasks) { 
            boardTasks = tasks; let filteredTasks = [...tasks];
            const searchTerm = taskSearchInput.value.toLowerCase().trim();
            const filterPriorityValue = filterPrioritySelect.value;
            if (searchTerm) { filteredTasks = filteredTasks.filter(task => (task.title && task.title.toLowerCase().includes(searchTerm)) || (task.description && task.description.toLowerCase().includes(searchTerm))); }
            if (filterPriorityValue) { filteredTasks = filteredTasks.filter(task => task.priority === filterPriorityValue); }
            renderKanbanBoard(filteredTasks);
        }

        // --- SISTEMA DE RENDERIZAÇÃO DO QUADRO KANBAN E CARDS DE TAREFA ---
        function renderKanbanBoard(tasksToRender) {
            if (!kanbanBoard) { hideLoading(); return; }
            kanbanBoard.innerHTML = '';
            if (!boardColumns || boardColumns.length === 0) {
                kanbanBoard.innerHTML = `<p class="text-gray-500 p-4 text-center w-full">Nenhuma coluna. Adicione colunas.</p>`;
                hideLoading(); return;
            }
            boardColumns.forEach((column, index) => {
                const columnElement = document.createElement('div');
                columnElement.id = `column-${column.id}`;
                columnElement.className = 'kanban-column flex flex-col bg-slate-100 rounded-xl shadow-lg p-4 h-full';
                columnElement.setAttribute('data-column-id', column.id);

                const columnTasksCount = tasksToRender.filter(t => t.status === column.id).length;
                const columnHeader = document.createElement('div');
                columnHeader.className = 'flex items-center justify-between mb-5';
                const columnColorClass = column.color || defaultColumnColors[index % defaultColumnColors.length];

                columnHeader.innerHTML = `
                    <div class="flex items-center min-w-0">
                        <span class="w-3.5 h-3.5 ${columnColorClass} rounded-full mr-2.5 flex-shrink-0"></span>
                        <h2 class="text-lg font-semibold text-gray-700 flex items-center">
                            <span class="column-title-text truncate-text cursor-pointer hover:underline" title="Editar: ${column.title}">${column.title}</span>
                        </h2>
                        <span class="ml-2 text-sm text-gray-500 font-medium">(${columnTasksCount})</span>
                    </div>
                    <div class="flex items-center space-x-1.5 flex-shrink-0">
                         ${hasPermission(activeBoardData, currentUserId, 'canEditColumn') ? `
                         <button class="edit-column-button text-gray-400 hover:text-indigo-600 p-1.5 rounded-md hover:bg-gray-200 transition-colors" data-column-id="${column.id}" data-column-title="${column.title}" title="Editar coluna">
                            <i class="fas fa-pencil-alt fa-sm"></i>
                        </button>` : ''}
                         ${hasPermission(activeBoardData, currentUserId, 'canDeleteColumn') ? `
                        <button class="delete-column-button text-gray-400 hover:text-red-600 p-1.5 rounded-md hover:bg-gray-200 transition-colors" data-column-id="${column.id}" data-column-title="${column.title}" title="Excluir coluna">
                            <i class="fas fa-trash-alt fa-sm"></i>
                        </button>` : ''}
                        <button class="add-task-to-column-button bg-indigo-500 text-white w-8 h-8 rounded-lg shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-1 transition-all flex items-center justify-center" data-column-id="${column.id}" title="Adicionar tarefa">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>`;
                columnElement.appendChild(columnHeader);
                const columnTitleSpan = columnHeader.querySelector('.column-title-text');
                if (columnTitleSpan) columnTitleSpan.addEventListener('click', () => openEditColumnModal(column.id, column.title));
                const editColBtn = columnHeader.querySelector('.edit-column-button');
                if (editColBtn) editColBtn.addEventListener('click', (e) => openEditColumnModal(e.currentTarget.dataset.columnId, e.currentTarget.dataset.columnTitle));
                const deleteColBtn = columnHeader.querySelector('.delete-column-button');
                if (deleteColBtn) deleteColBtn.addEventListener('click', (e) => deleteColumn(e.currentTarget.dataset.columnId, e.currentTarget.dataset.columnTitle));
                const addTaskButtonForColumn = columnHeader.querySelector('.add-task-to-column-button');
                if (addTaskButtonForColumn) {
                    addTaskButtonForColumn.addEventListener('click', (e) => {
                        const targetColId = e.currentTarget.dataset.columnId;
                        if (addTaskModal) {
                            addTaskModal.classList.remove('hidden');
                            if (taskTitleInput) { taskTitleInput.value = ''; taskTitleInput.focus(); }
                            if (taskDescriptionInput) taskDescriptionInput.value = '';
                            if (taskPriorityInput) taskPriorityInput.value = 'medium';
                            if (taskDueDateInput) taskDueDateInput.value = '';
                            if (confirmAddTaskButton) confirmAddTaskButton.dataset.targetColumnId = targetColId;
                        }
                    });
                }
                const columnContent = document.createElement('div');
                columnContent.className = 'kanban-column-content flex-grow overflow-y-auto space-y-3.5 pr-1.5';
                columnElement.appendChild(columnContent);
                kanbanBoard.appendChild(columnElement);
                columnElement.addEventListener('dragover', handleDragOver);
                columnElement.addEventListener('dragleave', handleDragLeave);
                columnElement.addEventListener('drop', handleDrop);
                const tasksForThisColumn = tasksToRender.filter(task => task.status === column.id);
                if (tasksForThisColumn.length > 0) {
                    tasksForThisColumn.forEach(task => columnContent.appendChild(createTaskCard(task)));
                } else {
                    const emptyMsg = document.createElement('p');
                    emptyMsg.className = 'text-center text-sm text-gray-500 italic mt-6 px-2';
                    emptyMsg.textContent = 'Nenhuma tarefa aqui.';
                    columnContent.appendChild(emptyMsg);
                }
            });
            hideLoading();
        }

        function createTaskCard(task) {
            const card = document.createElement('div');
            card.id = `task-${task.id}`;
            card.className = 'kanban-card bg-white p-3.5 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 border-l-4 flex flex-col space-y-2'; 
            // Se a tarefa estiver bloqueada, ela não pode ser arrastada.
            card.setAttribute('draggable', !task.isBlocked);
            card.setAttribute('data-task-id', task.id);
            card.setAttribute('data-task-status', task.status);

            if (task.isBlocked) card.classList.add('task-blocked');
            if (task.completedAt) card.classList.add('task-completed');

            let priorityIconHtml = '', priorityText = '', priorityBorderClass = 'border-gray-300', priorityIconColor = 'text-gray-500';
            switch (task.priority) {
                case 'high': priorityIconHtml = '<i class="fas fa-exclamation-triangle priority-icon"></i>'; priorityText = 'Alta'; priorityBorderClass = 'border-red-500'; priorityIconColor = 'text-red-500'; break;
                case 'medium': priorityIconHtml = '<i class="fas fa-minus-circle priority-icon"></i>'; priorityText = 'Média'; priorityBorderClass = 'border-yellow-500'; priorityIconColor = 'text-yellow-500'; break;
                case 'low': priorityIconHtml = '<i class="fas fa-check-circle priority-icon"></i>'; priorityText = 'Baixa'; priorityBorderClass = 'border-green-500'; priorityIconColor = 'text-green-500'; break;
                default: priorityIconHtml = '<i class="fas fa-info-circle priority-icon"></i>'; priorityText = 'N/D'; priorityBorderClass = 'border-gray-400'; priorityIconColor = 'text-gray-400';
            }
            if (!task.isBlocked && !task.completedAt) card.classList.add(priorityBorderClass);


            let formattedDueDate = 'N/A', dueDate = null;
            if (task.dueDate) {
                if (task.dueDate.toDate) dueDate = task.dueDate.toDate();
                else if (typeof task.dueDate === 'string' && task.dueDate.match(/^\d{4}-\d{2}-\d{2}$/)) { const parts = task.dueDate.split('-'); dueDate = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2])); }
                if(dueDate && !isNaN(dueDate.getTime())) formattedDueDate = dueDate.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'UTC' });
            }
            const completedKeywords = ['concluído', 'concluido', 'completo', 'finalizado', 'done', 'resolvido'];
            const colData = boardColumns.find(col => col.id === task.status);
            const isInCompletedColumn = colData && completedKeywords.some(k => colData.title.toLowerCase().includes(k));
            let isOverdue = false, overdueIcon = '';
            if (dueDate && !isNaN(dueDate.getTime()) && !isInCompletedColumn && !task.completedAt && !task.isBlocked) {
                const today = new Date(); today.setUTCHours(0,0,0,0);
                isOverdue = dueDate < today;
                if(isOverdue) overdueIcon = '<i class="fas fa-exclamation-circle text-red-500 ml-1.5" title="Tarefa Vencida!"></i>';
            }
            const dueDateCls = isOverdue ? 'text-red-600 font-semibold' : 'text-gray-500';

            const assignedToText = task.assignedToDisplayName || (task.assignedTo ? task.assignedTo.substring(0,8) + '...' : 'Ninguém');
            const assignedAtDate = task.assignedAt?.toDate ? task.assignedAt.toDate().toLocaleDateString('pt-BR', {day:'2-digit', month:'short'}) : '';
            const completedAtDate = task.completedAt?.toDate ? task.completedAt.toDate().toLocaleDateString('pt-BR', {day:'2-digit', month:'short', year:'numeric'}) : '';


            // ---> INÍCIO DO BLOCO DE LÓGICA DE BOTÕES DE AÇÃO REFINADO
            let actionButtonsHtml = '';

            // Só mostra botões de ação se a tarefa NÃO estiver bloqueada
            if (!task.isBlocked) {
                if (task.completedAt) {
                    // Permissão para reabrir tarefa será verificada na própria função
                    actionButtonsHtml += `<button class="reopen-task-btn text-xs bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-1 px-2 rounded-md transition-colors" data-task-id="${task.id}" title="Reabrir Tarefa"><i class="fas fa-undo mr-1"></i>Reabrir</button>`;
                } else {
                    if (!task.assignedTo) {
                        actionButtonsHtml += `<button class="assign-task-btn text-xs bg-blue-500 hover:bg-blue-600 text-white font-medium py-1 px-2 rounded-md transition-colors" data-task-id="${task.id}" title="Assumir tarefa"><i class="fas fa-user-plus mr-1"></i>Assumir</button>`;
                    } else if (task.assignedTo === currentUserId) {
                        actionButtonsHtml += `<button class="complete-task-btn text-xs bg-green-500 hover:bg-green-600 text-white font-medium py-1 px-2 rounded-md transition-colors" data-task-id="${task.id}" title="Concluir tarefa"><i class="fas fa-check mr-1"></i>Concluir</button>`;
                        actionButtonsHtml += `<button class="unassign-task-btn text-xs bg-gray-400 hover:bg-gray-500 text-white font-medium py-1 px-2 rounded-md transition-colors ml-1" data-task-id="${task.id}" title="Liberar tarefa"><i class="fas fa-user-minus mr-1"></i>Liberar</button>`;
                    }
                }
            }

            // O botão de bloquear/desbloquear aparece independentemente das outras ações
            if (hasPermission(activeBoardData, currentUserId, 'canBlockTask')) {
                 actionButtonsHtml += `<button class="toggle-block-task-btn text-xs ${task.isBlocked ? 'bg-yellow-400 hover:bg-yellow-500 text-black' : 'bg-red-500 hover:bg-red-600 text-white'} font-medium py-1 px-2 rounded-md transition-colors ml-1" data-task-id="${task.id}" title="${task.isBlocked ? 'Desbloquear' : 'Bloquear'}"><i class="fas ${task.isBlocked ? 'fa-lock-open' : 'fa-lock'} mr-1"></i>${task.isBlocked ? 'Desbloq.' : 'Bloquear'}</button>`;
            }
            // ---> FIM DO BLOCO REFINADO


            card.innerHTML = `
                <div>
                    <div class="flex justify-between items-start mb-1.5">
                        <h4 class="task-title-text text-gray-800 text-base truncate-text" title="${task.title}">${task.title}</h4>
                        <button class="edit-task-button text-gray-400 hover:text-indigo-600 p-1 -mr-1 flex-shrink-0" data-task-id="${task.id}" title="Detalhes/Editar"><i class="fas fa-ellipsis-h fa-sm"></i></button>
                    </div>
                    ${task.description ? `<p class="text-xs text-gray-600 break-words leading-snug max-h-12 overflow-y-auto mb-1.5">${task.description.substring(0,100)}${task.description.length > 100 ? '...' : ''}</p>` : '<p class="text-xs text-gray-400 italic mb-1.5">Sem descrição.</p>'}
                </div>
                <div class="text-xs text-gray-600 mb-1.5">
                    <span class="font-medium">Responsável:</span> ${assignedToText} ${task.assignedAt ? `(${assignedAtDate})` : ''}
                    ${task.completedAt ? `<br><span class="font-medium text-green-700">Concluída:</span> <span class="text-green-600">${completedAtDate}</span>` : ''}
                </div>
                <div class="flex justify-between items-center text-xs mt-auto pt-2 border-t border-gray-200">
                    <div class="flex items-center ${priorityIconColor}" title="Prioridade: ${priorityText}">${priorityIconHtml}<span class="ml-1.5 font-medium">${priorityText}</span></div>
                    <div class="flex items-center ${dueDateCls}" title="Vencimento"><i class="far fa-calendar-alt mr-1.5"></i><span class="font-medium">${formattedDueDate}</span>${overdueIcon}</div>
                </div>
                <div class="flex justify-start items-center space-x-1.5 mt-2.5 pt-2 border-t border-gray-200">
                    ${actionButtonsHtml}
                </div>
            `;

            const assignBtn = card.querySelector('.assign-task-btn');
            if(assignBtn) assignBtn.addEventListener('click', (e) => { e.stopPropagation(); assignTaskToSelf(e.currentTarget.dataset.taskId); });

            const completeBtn = card.querySelector('.complete-task-btn');
            if(completeBtn) completeBtn.addEventListener('click', (e) => { e.stopPropagation(); completeTask(e.currentTarget.dataset.taskId); });
            
            const reopenBtn = card.querySelector('.reopen-task-btn');
            if(reopenBtn) reopenBtn.addEventListener('click', (e) => { e.stopPropagation(); reopenTask(e.currentTarget.dataset.taskId); });

            const unassignBtn = card.querySelector('.unassign-task-btn');
            if(unassignBtn) unassignBtn.addEventListener('click', (e) => { e.stopPropagation(); unassignTask(e.currentTarget.dataset.taskId); });

            const blockBtn = card.querySelector('.toggle-block-task-btn');
            if(blockBtn) blockBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleBlockTask(e.currentTarget.dataset.taskId); });


            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            card.querySelector('.edit-task-button').addEventListener('click', (e) => { e.stopPropagation(); openEditTaskModal(task); });
            return card;
        }

        async function assignTaskToSelf(taskId) {
            if (!currentUserId || !tasksCollectionRef || !currentUserDisplayName) { 
                showMessageModal('Erro', 'Não foi possível assumir a tarefa. Usuário ou contexto não definidos.', 'error');
                return;
            }
            showLoading();
            const taskRef = doc(tasksCollectionRef, taskId);
            try {
                await updateDoc(taskRef, {
                    assignedTo: currentUserId,
                    assignedToDisplayName: currentUserDisplayName, 
                    assignedAt: serverTimestamp(),
                    completedAt: null, 
                    isBlocked: false 
                });
                showToast('Tarefa assumida por você!', 'success');
            } catch (error) {
                console.error("Erro ao assumir tarefa:", error);
                showMessageModal('Erro', `Não foi possível assumir a tarefa: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function unassignTask(taskId) {
            if (!tasksCollectionRef) return;
            showLoading();
            const taskRef = doc(tasksCollectionRef, taskId);
            try {
                await updateDoc(taskRef, {
                    assignedTo: null,
                    assignedToDisplayName: null,
                    assignedAt: null
                });
                showToast('Tarefa liberada!', 'info');
            } catch (error) {
                console.error("Erro ao liberar tarefa:", error);
                showMessageModal('Erro', `Não foi possível liberar a tarefa: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function completeTask(taskId) {
            if (!tasksCollectionRef) return;
            showLoading();
            const taskRef = doc(tasksCollectionRef, taskId);
            try {
                await updateDoc(taskRef, {
                    completedAt: serverTimestamp(),
                    isBlocked: false 
                });
                showToast('Tarefa marcada como concluída!', 'success');
            } catch (error) {
                console.error("Erro ao concluir tarefa:", error);
                showMessageModal('Erro', `Não foi possível concluir a tarefa: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }
        
        async function reopenTask(taskId) {
            // ---> INÍCIO DA VERIFICAÇÃO DE SEGURANÇA
            if (!hasPermission(activeBoardData, currentUserId, 'canEditTask')) {
                showToast('Você não tem permissão para reabrir tarefas.', 'error');
                return;
            }
            // ---> FIM DA VERIFICAÇÃO
            
            if (!tasksCollectionRef) return;
            showLoading();
            const taskRef = doc(tasksCollectionRef, taskId);
            try {
                await updateDoc(taskRef, {
                    completedAt: null
                });
                showToast('Tarefa reaberta!', 'info');
            } catch (error) {
                console.error("Erro ao reabrir tarefa:", error);
                showMessageModal('Erro', `Não foi possível reabrir a tarefa: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function toggleBlockTask(taskId) {
            // ---> INÍCIO DA VERIFICAÇÃO DE SEGURANÇA
            if (!hasPermission(activeBoardData, currentUserId, 'canBlockTask')) {
                showToast('Você não tem permissão para bloquear/desbloquear tarefas.', 'error');
                return;
            }
            // ---> FIM DA VERIFICAÇÃO
            
            if (!tasksCollectionRef) return;
            const task = boardTasks.find(t => t.id === taskId);
            if (!task) {
                showMessageModal('Erro', 'Tarefa não encontrada para bloquear/desbloquear.', 'error');
                return;
            }
            showLoading();
            const taskRef = doc(tasksCollectionRef, taskId);
            try {
                await updateDoc(taskRef, {
                    isBlocked: !task.isBlocked 
                });
                showToast(task.isBlocked ? 'Tarefa desbloqueada!' : 'Tarefa bloqueada!', 'info');
            } catch (error) {
                console.error("Erro ao bloquear/desbloquear tarefa:", error);
                showMessageModal('Erro', `Não foi possível alterar o bloqueio: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        cancelAddTaskButton?.addEventListener('click', () => addTaskModal.classList.add('hidden'));
        confirmAddTaskButton?.addEventListener('click', async () => {
            const title = taskTitleInput.value.trim();
            if (!title) { showMessageModal('Atenção', 'Título da tarefa é obrigatório.', 'info'); taskTitleInput.focus(); return; }
            if (!activeBoardId || !tasksCollectionRef || !boardColumns.length) { showMessageModal('Erro Crítico', 'Contexto inválido para adicionar tarefa.', 'error'); return; }
            const targetColumnId = confirmAddTaskButton.dataset.targetColumnId || boardColumns[0].id;
            showLoading();
            try {
                await addDoc(tasksCollectionRef, {
                    title,
                    description: taskDescriptionInput.value.trim(),
                    priority: taskPriorityInput.value,
                    status: targetColumnId,
                    dueDate: taskDueDateInput.value || null,
                    createdAt: serverTimestamp(),
                    boardId: activeBoardId,
                    assignedTo: null, 
                    assignedToDisplayName: null, 
                    assignedAt: null, 
                    completedAt: null, 
                    isBlocked: false 
                });
                addTaskModal?.classList.add('hidden');
                showToast('Tarefa adicionada!', 'success');
            } catch (error) { console.error("Erro ao adicionar tarefa:", error); showMessageModal('Erro Adicionar Tarefa', `Erro: ${error.message}`, 'error');
            } finally { hideLoading(); }
        });

        function openEditTaskModal(task) {
            if (!editTaskModal) return;
            editTaskIdInput.value = task.id;
            editTaskTitleInput.value = task.title;
            editTaskDescriptionInput.value = task.description || '';
            editTaskPriorityInput.value = task.priority || 'medium';

            if (task.dueDate) {
                let dateToSet = task.dueDate;
                if (task.dueDate.toDate) { dateToSet = task.dueDate.toDate().toISOString().split('T')[0];
                } else if (typeof task.dueDate === 'string' && task.dueDate.match(/^\d{4}-\d{2}-\d{2}$/)) { dateToSet = task.dueDate; }
                editTaskDueDateInput.value = dateToSet;
            } else { editTaskDueDateInput.value = ''; }

            editTaskAssignedToDisplay.textContent = task.assignedToDisplayName || (task.assignedTo ? `UID: ${task.assignedTo.substring(0,10)}...` : 'Ninguém');
            editTaskAssignedAtDisplay.textContent = task.assignedAt?.toDate ? `Assumida em: ${task.assignedAt.toDate().toLocaleString('pt-BR')}` : '';
            
            if (task.completedAt) {
                editTaskCompletedAtDisplay.textContent = task.completedAt.toDate().toLocaleString('pt-BR');
                editTaskCompletedDisplayContainer.classList.remove('hidden');
            } else {
                editTaskCompletedDisplayContainer.classList.add('hidden');
            }

            editTaskModal.classList.remove('hidden');
            editTaskTitleInput.focus();
        }
        cancelEditTaskButton?.addEventListener('click', () => editTaskModal.classList.add('hidden'));
        saveEditTaskButton?.addEventListener('click', async () => {
            // ---> INÍCIO DA VERIFICAÇÃO DE SEGURANÇA
            if (!hasPermission(activeBoardData, currentUserId, 'canEditTask')) {
                showToast('Você não tem permissão para editar tarefas.', 'error');
                return;
            }
            // ---> FIM DA VERIFICAÇÃO
            
            const taskId = editTaskIdInput.value;
            const newTitle = editTaskTitleInput.value.trim();
            if (!newTitle) { showMessageModal('Atenção', 'Título é obrigatório.', 'info'); editTaskTitleInput.focus(); return; }
            if (!tasksCollectionRef) { showMessageModal('Erro', 'Ref. tarefas não pronta.', 'error'); return; }
            showLoading();
            try {
                const taskRef = doc(tasksCollectionRef, taskId);
                await updateDoc(taskRef, {
                    title: newTitle,
                    description: editTaskDescriptionInput.value.trim(),
                    priority: editTaskPriorityInput.value,
                    dueDate: editTaskDueDateInput.value || null
                });
                editTaskModal?.classList.add('hidden');
                showToast('Tarefa atualizada!', 'success');
            } catch (error) { console.error("Erro ao salvar tarefa:", error); showMessageModal('Erro Salvar Tarefa', `Erro: ${error.message}`, 'error');
            } finally { hideLoading(); }
        });
        deleteTaskButton?.addEventListener('click', () => { 
            // ---> INÍCIO DA VERIFICAÇÃO DE SEGURANÇA
            if (!hasPermission(activeBoardData, currentUserId, 'canDeleteTask')) {
                showToast('Você não tem permissão para excluir tarefas.', 'error');
                return;
            }
            // ---> FIM DA VERIFICAÇÃO
            
            const taskId = editTaskIdInput.value;
            const taskToDelete = boardTasks.find(t => t.id === taskId);
            const taskTitle = taskToDelete ? `"${taskToDelete.title}"` : "esta tarefa";
            showMessageModal('Confirmar Exclusão', `Excluir ${taskTitle}?`, 'warning', async () => {
                if (editTaskModal) editTaskModal.classList.add('hidden');
                if (!tasksCollectionRef) { showMessageModal('Erro', 'Ref. tarefas não pronta.', 'error'); return; }
                showLoading();
                try { await deleteDoc(doc(tasksCollectionRef, taskId)); showToast('Tarefa excluída!', 'success');
                } catch (error) { console.error("Erro ao excluir tarefa:", error); showMessageModal('Erro Excluir Tarefa', `Erro: ${error.message}`, 'error');
                } finally { hideLoading(); }
            }, 'Excluir Tarefa', true, 'Cancelar');
        });

        let draggedTaskElement = null;
        function handleDragStart(e) { if (!e.target.classList.contains('kanban-card')) return; draggedTaskElement = e.target; e.dataTransfer.setData('text/plain', draggedTaskElement.dataset.taskId); e.dataTransfer.effectAllowed = 'move'; setTimeout(() => { if(draggedTaskElement) draggedTaskElement.classList.add('dragging'); }, 0); }
        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; const colEl = e.currentTarget.closest('.kanban-column'); if (colEl && !colEl.classList.contains('drag-over')) colEl.classList.add('drag-over'); }
        function handleDragLeave(e) { const colEl = e.currentTarget.closest('.kanban-column'); if (colEl) colEl.classList.remove('drag-over'); }
        async function handleDrop(e) {
            e.preventDefault();
            const taskId = e.dataTransfer.getData('text/plain');
            const targetColEl = e.currentTarget.closest('.kanban-column');
            if (!targetColEl || !draggedTaskElement) return;
            const newStatusColId = targetColEl.dataset.columnId;
            targetColEl.classList.remove('drag-over');
            const taskToMove = boardTasks.find(t => t.id === taskId);
            if (taskToMove && taskToMove.status !== newStatusColId) {
                if (!tasksCollectionRef) { showMessageModal('Erro', 'Ref. tarefas não pronta para mover.', 'error'); if (draggedTaskElement) draggedTaskElement.classList.remove('dragging'); draggedTaskElement = null; return; }
                showLoading();
                try {
                    const taskRef = doc(tasksCollectionRef, taskId);
                    await updateDoc(taskRef, { status: newStatusColId });
                    showToast(`Tarefa movida para "${boardColumns.find(c=>c.id === newStatusColId)?.title || 'nova coluna'}"!`, 'success');
                } catch (err) { console.error("Erro ao mover tarefa:", err); showMessageModal('Erro Mover Tarefa', `Erro: ${err.message}`, 'error');
                } finally { hideLoading(); }
            }
            if (draggedTaskElement) draggedTaskElement.classList.remove('dragging');
            draggedTaskElement = null;
        }
        function handleDragEnd(e) { if (draggedTaskElement) draggedTaskElement.classList.remove('dragging'); document.querySelectorAll('.kanban-column.drag-over').forEach(col => col.classList.remove('drag-over')); draggedTaskElement = null; }

        window.onload = () => {
            console.log("Janela carregada. Aguardando autenticação do Firebase...");
            // A autenticação será tratada pelo onAuthStateChanged
        };

        // --- [PAINEL DE PERMISSÕES ADMINISTRATIVAS] ---
        // Adiciona botão no modal de membros (só para proprietário)
        let managePermissionsButton = null;
        if (!document.getElementById('managePermissionsButton')) {
            managePermissionsButton = document.createElement('button');
            managePermissionsButton.id = 'managePermissionsButton';
            managePermissionsButton.className = 'ml-2 bg-yellow-500 text-white px-3 py-1.5 rounded-md shadow-sm hover:bg-yellow-600 text-xs font-medium';
            managePermissionsButton.innerHTML = '<i class="fas fa-shield-alt mr-1"></i>Permissões';
            document.querySelector('#manageMembersModal .flex.justify-between')?.appendChild(managePermissionsButton);
        }

        // Modal de permissões (criado dinamicamente)
        function openPermissionsModal(boardData) {
            let modal = document.getElementById('permissionsModal');
            if (modal) modal.remove();
            modal = document.createElement('div');
            modal.id = 'permissionsModal';
            modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-[70] p-4';
            // Pega todos os cargos únicos
            const tags = Array.from(new Set(Object.values(boardData.memberTags||{}).concat(['Proprietário'])));
            // Permissões possíveis usando PERMISSION_CATEGORIES
            const allPerms = [];
            
            // Converte PERMISSION_CATEGORIES para o formato esperado pelo modal
            Object.entries(PERMISSION_CATEGORIES).forEach(([categoryName, categoryData]) => {
                Object.entries(categoryData.permissions).forEach(([permKey, permLabel]) => {
                    // Mapeia a categoria para o formato esperado
                    let category = 'board';
                    if (categoryName === 'Estoque') category = 'inventory';
                    else if (categoryName === 'Admin') category = 'admin';
                    else if (categoryName === 'Tarefas') category = 'board';
                    
                    // Adiciona tooltips baseados na permissão
                    let tip = '';
                    if (permKey === 'canViewReports') tip = 'Permite visualizar relatórios de estoque e movimentações.';
                    else if (permKey === 'canManageCategories') tip = 'Permite criar e editar categorias do estoque.';
                    else if (permKey === 'canEditColumn') tip = 'Permite editar o título e cor das colunas.';
                    else if (permKey === 'canDeleteColumn') tip = 'Permite excluir colunas do quadro.';
                    else if (permKey === 'canEditTask') tip = 'Permite editar o conteúdo das tarefas.';
                    else if (permKey === 'canBlockTask') tip = 'Permite bloquear/desbloquear tarefas.';
                    else if (permKey === 'canManageInventory') tip = 'Permissão completa sobre o estoque (adicionar, editar, remover itens).';
                    else if (permKey === 'canWithdrawInventory') tip = 'Permite solicitar e retirar itens do estoque.';
                    else if (permKey === 'canApproveRequests') tip = 'Permite aprovar solicitações de retirada de estoque.';
                    else if (permKey === 'canApproveReturns') tip = 'Permite aprovar devoluções de itens ao estoque.';
                    else if (permKey === 'canManageRolePermissions') tip = 'Permite acessar o painel de permissões e definir regras de acesso.';
                    else if (permKey === 'canEditTag') tip = 'Permite editar o cargo/tag de outros membros.';
                    else if (permKey === 'canDeleteChat') tip = 'Permite apagar mensagens do chat ou limpar o chat.';
                    else if (permKey === 'canRemoveMember') tip = 'Permite remover membros do quadro.';
                    else tip = `Permite ${permLabel.toLowerCase()}.`;
                    
                    allPerms.push({
                        key: permKey,
                        label: permLabel,
                        tip: tip,
                        category: category
                    });
                });
            });
            
            const rolePerms = boardData.rolePermissions || ROLE_PERMISSIONS;
            // Mapeia membros por cargo
            const membersByTag = {};
            boardData.members.forEach(uid => {
                const tag = (boardData.memberTags && boardData.memberTags[uid]) || (uid === boardData.owner ? 'Proprietário' : '');
                if (!membersByTag[tag]) membersByTag[tag] = [];
                membersByTag[tag].push(uid);
            });
            // Ícones e cores para cargos
            const tagIcons = {
                'Proprietário': 'fa-crown text-yellow-500',
                'Administrador': 'fa-user-shield text-blue-600',
                'Supervisor': 'fa-user-tie text-green-600',
                'Membro': 'fa-user text-gray-500',
            };
            // Agrupando permissões por categoria
            const permsByCategory = {
                board: allPerms.filter(p => p.category === 'board'),
                inventory: allPerms.filter(p => p.category === 'inventory'),
                admin: allPerms.filter(p => p.category === 'admin')
            };
            
            // Ícones e cores para categorias
            const categoryIcons = {
                board: { icon: 'fa-columns', color: 'text-blue-500' },
                inventory: { icon: 'fa-boxes', color: 'text-emerald-600' },
                admin: { icon: 'fa-shield-alt', color: 'text-yellow-600' }
            };
            
            let html = `<div class='bg-white p-8 rounded-xl shadow-2xl w-full max-w-4xl modal-content overflow-y-auto max-h-[90vh]'>
                <div class='flex justify-between items-center mb-6'>
                    <h3 class='text-2xl font-bold text-gray-800'>Gerenciar Permissões</h3>
                    <button id='closePermissionsModalBtn' class='text-gray-500 hover:text-gray-700 text-2xl leading-none'>&times;</button>
                </div>
                <div class='mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-blue-700 text-sm font-medium'>
                    <i class='fas fa-info-circle mr-1'></i>As permissões configuradas aqui controlam quem pode acessar cada funcionalidade neste quadro. 
                    <span class="block mt-1 text-xs">Marque ou desmarque as caixas para conceder ou remover permissões de cada cargo.</span>
                </div>
                
                <div class='mb-6'>
                    <div class='flex border-b border-gray-200 mb-3 pb-1'>
                        <button class='tab-button active px-4 py-2 text-sm font-medium rounded-t-lg border-b-2 border-indigo-500 text-indigo-600' data-tab="all">
                            <i class='fas fa-th-list mr-1'></i>Todos os Cargos
                        </button>
                    </div>
                    
                    <div id='all-tab' class='tab-content'>
                        <div class='grid grid-cols-1 gap-6'>`;
                        
            tags.forEach(tag => {
                const isOwner = tag === 'Proprietário';
                const icon = tagIcons[tag] || 'fa-id-badge text-indigo-400';
                const memberCount = membersByTag[tag]?.length || 0;
                const memberList = (membersByTag[tag]||[]).map(uid => boardData.memberDisplayNames?.[uid] || uid).join(', ');
                
                html += `<div class='rounded-lg border border-gray-200 shadow p-5 bg-gray-50 relative group'>
                    <div class='flex items-center mb-3'>
                        <i class='fas ${icon} fa-lg mr-2'></i>
                        <span class='font-semibold text-lg text-gray-800'>${tag}</span>
                        <span class='ml-2 text-xs text-gray-500' title='${memberList}'>${memberCount} membro${memberCount===1?'':'s'}</span>
                        ${isOwner ? `<span class='ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-700 text-xs rounded font-semibold'>Cargo Fixo</span>` : ''}
                    </div>
                    
                    <div class='grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-x-6 gap-y-2'>`;
                
                // Para cada categoria
                Object.entries(permsByCategory).forEach(([category, perms]) => {
                    const catInfo = categoryIcons[category];
                    html += `<div class='col-span-1 mb-4'>
                        <div class='flex items-center mb-2 pb-1 border-b border-gray-200'>
                            <i class='fas ${catInfo.icon} ${catInfo.color} mr-2'></i>
                            <span class='font-medium text-sm ${catInfo.color}'>
                                ${category === 'board' ? 'Quadro' : 
                                  category === 'inventory' ? 'Estoque' : 
                                  'Administração'}
                            </span>
                        </div>
                        <div class='flex flex-col gap-2 pl-1'>`;
                    
                    perms.forEach(p => {
                        if (isOwner) {
                            html += `<label class='flex items-center gap-2 text-xs text-gray-700 cursor-not-allowed' title='${p.tip}'>
                                <input type='checkbox' class='perm-checkbox' data-role='${tag}' data-perm='${p.key}' checked disabled>
                                <span>${p.label}</span>
                                <i class='fas fa-info-circle text-gray-400 ml-1' title='${p.tip}'></i>
                            </label>`;
                        } else {
                            const checked = rolePerms[tag] && rolePerms[tag][p.key] ? 'checked' : '';
                            html += `<label class='flex items-center gap-2 text-xs text-gray-700 cursor-pointer hover:bg-gray-100 px-2 py-1 rounded' title='${p.tip}'>
                                <input type='checkbox' class='perm-checkbox' data-role='${tag}' data-perm='${p.key}' ${checked}>
                                <span>${p.label}</span>
                                <i class='fas fa-info-circle text-gray-400 ml-1' title='${p.tip}'></i>
                            </label>`;
                        }
                    });
                    
                    html += `</div></div>`;
                });
                
                html += `</div></div>`; // Fim do card do cargo
            });
            
            html += `</div></div> <!-- Fim da tab -->
                <div class='flex justify-between items-center mt-6 pt-4 border-t border-gray-200'>
                    <button id='restoreDefaultPermsBtn' class='bg-gray-100 text-gray-700 py-2 px-4 rounded-lg shadow-sm hover:bg-gray-200 font-medium'><i class='fas fa-undo mr-1'></i>Restaurar padrão</button>
                    <div class='flex space-x-4'>
                        <button id='cancelPermissionsBtn' class='bg-gray-200 text-gray-700 py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 font-medium'>Cancelar</button>
                        <button id='savePermissionsBtn' class='bg-green-500 text-white py-2 px-4 rounded-lg shadow-md hover:bg-green-600 font-medium'>Salvar Permissões</button>
                    </div>
                </div>
                <div id='permSaveFeedback' class='text-center text-sm mt-3 hidden'></div>
            </div>`;
            modal.innerHTML = html;
            document.body.appendChild(modal);
            document.getElementById('closePermissionsModalBtn').onclick = () => modal.remove();
            document.getElementById('cancelPermissionsBtn').onclick = () => modal.remove();
            document.getElementById('restoreDefaultPermsBtn').onclick = () => {
                // Restaura checkboxes para padrão
                tags.forEach(tag => {
                    allPerms.forEach(p => {
                        const cb = modal.querySelector(`.perm-checkbox[data-role='${tag}'][data-perm='${p.key}']`);
                        if (cb) cb.checked = !!(ROLE_PERMISSIONS[tag] && ROLE_PERMISSIONS[tag][p.key]);
                    });
                });
            };
            document.getElementById('savePermissionsBtn').onclick = async () => {
                const feedback = document.getElementById('permSaveFeedback');
                feedback.classList.remove('hidden');
                feedback.textContent = 'Salvando permissões...';
                // Monta novo objeto de permissões
                const newPerms = {};
                tags.forEach(tag => {
                    newPerms[tag] = {};
                    allPerms.forEach(p => {
                        const cb = modal.querySelector(`.perm-checkbox[data-role='${tag}'][data-perm='${p.key}']`);
                        newPerms[tag][p.key] = !!cb.checked;
                    });
                });
                if (activeBoardId && boardsCollectionRef) {
                    showLoading();
                    try {
                        const boardRef = doc(boardsCollectionRef, activeBoardId);
                        await updateDoc(boardRef, { rolePermissions: newPerms });
                        feedback.textContent = 'Permissões salvas com sucesso!';
                        feedback.className = 'text-center text-green-600 text-sm mt-3';
                        setTimeout(()=>modal.remove(), 1200);
                        if (activeBoardData) activeBoardData.rolePermissions = newPerms;
                    } catch (err) {
                        feedback.textContent = 'Erro ao salvar permissões: ' + err.message;
                        feedback.className = 'text-center text-red-600 text-sm mt-3';
                    } finally {
                        hideLoading();
                    }
                }
            };
        }
        // Adiciona evento ao botão (só se proprietário)
        if (managePermissionsButton) {
            managePermissionsButton.onclick = () => {
                if (activeBoardData && activeBoardData.owner === currentUserId) {
                    openPermissionsModal(activeBoardData);
                }
            };
        }
        // --- FIM PAINEL DE PERMISSÕES ---

        // --- SISTEMA DE CHAT INTEGRADO AO QUADRO ---
        // Elementos do chat
        const openChatSidebarBtn = document.getElementById('openChatSidebarBtn');
        const closeChatSidebarBtn = document.getElementById('closeChatSidebarBtn');
        const kanbanChatSidebar = document.getElementById('kanbanChatSidebar');
        const kanbanChatMessages = document.getElementById('kanbanChatMessages');
        const kanbanChatForm = document.getElementById('kanbanChatForm');
        const kanbanChatInput = document.getElementById('kanbanChatInput');
        const clearChatBtn = document.getElementById('clearChatBtn');
        let chatMessagesUnsub = null;
        let chatCollectionRef = null;
        let lastChatSend = 0;
        // Função para sanitizar texto (anti-XSS)
        function sanitize(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        // Função para gerar cor de avatar baseada no userId
        function avatarColor(uid) {
            if (!uid) return 'bg-indigo-200';
            const colors = ['bg-indigo-200','bg-pink-200','bg-green-200','bg-yellow-200','bg-blue-200','bg-rose-200','bg-amber-200','bg-purple-200','bg-teal-200','bg-cyan-200'];
            let hash = 0; for (let i = 0; i < uid.length; i++) hash = uid.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        }
        // Função para ajustar a altura do chat
        function adjustChatHeight() {
            const windowHeight = window.innerHeight;
            const maxChatHeight = Math.min(windowHeight * 0.6, 450); // Máximo de 60% da altura da janela ou 450px
            kanbanChatSidebar.style.maxHeight = `${maxChatHeight}px`;
            
            // Ajusta a altura da área de mensagens
            setTimeout(() => {
                const headerHeight = kanbanChatSidebar.querySelector('.flex.items-center.justify-between')?.offsetHeight || 40;
                const formHeight = kanbanChatForm?.offsetHeight || 50;
                const clearBtnHeight = clearChatBtn?.parentElement?.offsetHeight || 40;
                const messagesHeight = maxChatHeight - headerHeight - formHeight - clearBtnHeight - 10; // 10px de margem
                kanbanChatMessages.style.maxHeight = `${messagesHeight}px`;
            }, 50);
        }
        
        // Abre/fecha chat
        openChatSidebarBtn?.addEventListener('click', () => { 
            kanbanChatSidebar.style.display = 'flex'; 
            openChatSidebarBtn.style.display = 'none';
            adjustChatHeight();
        });
        
        closeChatSidebarBtn?.addEventListener('click', () => { 
            kanbanChatSidebar.style.display = 'none'; 
            openChatSidebarBtn.style.display = 'flex'; 
        });
        
        // Ajustar altura quando a janela for redimensionada
        window.addEventListener('resize', () => {
            if (kanbanChatSidebar.style.display === 'flex') {
                adjustChatHeight();
            }
        });
        // Desabilita botão enviar se vazio
        kanbanChatInput?.addEventListener('input', () => {
            kanbanChatForm.querySelector('button[type="submit"]').disabled = !kanbanChatInput.value.trim();
        });
        // Ao trocar de board, configurar chat
        async function setupBoardChat(boardId, boardData) {
            if (chatMessagesUnsub) chatMessagesUnsub();
            kanbanChatMessages.innerHTML = '<div class="flex flex-col items-center justify-center h-32 animate-pulse"><div class="w-12 h-12 rounded-full bg-indigo-100 mb-2"></div><div class="h-3 w-32 bg-gray-200 rounded mb-1"></div><div class="h-3 w-24 bg-gray-200 rounded"></div></div>';
            chatCollectionRef = collection(db, `artifacts/${appIdFromGlobal}/boards/${boardId}/chatMessages`);
            // Permissão para limpar/apagar (nova permissão granular)
            const canDeleteChat = hasPermission(boardData, currentUserId, 'canDeleteChat');
            clearChatBtn.style.display = canDeleteChat ? 'flex' : 'none';
            // Listener de mensagens
            const q = query(chatCollectionRef, orderBy('createdAt', 'asc'));
            chatMessagesUnsub = onSnapshot(q, async (snapshot) => {
                kanbanChatMessages.innerHTML = '';
                const now = new Date();
                const weekAgo = new Date(now.getTime() - 7*24*60*60*1000);
                const batch = writeBatch(db);
                let hasOld = false;
                let lastDate = '';
                snapshot.forEach(docSnap => {
                    const msg = docSnap.data();
                    const msgId = docSnap.id;
                    const createdAt = msg.createdAt?.toDate ? msg.createdAt.toDate() : null;
                    if (createdAt && createdAt < weekAgo) {
                        batch.delete(doc(chatCollectionRef, msgId));
                        hasOld = true;
                        return;
                    }
                    // Só mostra se for membro
                    if (!boardData.members.includes(msg.userId)) return;
                    // Separador de data
                    const msgDate = createdAt ? createdAt.toLocaleDateString('pt-BR') : '';
                    if (msgDate && msgDate !== lastDate) {
                        const sep = document.createElement('div');
                        sep.className = 'flex items-center justify-center my-1';
                        sep.innerHTML = `<span class="px-2 py-0.5 bg-gray-100 text-gray-400 text-xs rounded-full">${msgDate}</span>`;
                        kanbanChatMessages.appendChild(sep);
                        lastDate = msgDate;
                    }
                    const isMine = msg.userId === currentUserId;
                    const canDelete = canDeleteChat || isMine;
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `message ${isMine ? 'message-mine' : ''}`;
                    msgDiv.innerHTML = `
                        <div class="flex-shrink-0 w-7 h-7 rounded-full ${avatarColor(msg.userId)} flex items-center justify-center font-bold text-indigo-700 text-sm">${sanitize((msg.displayName||'').substring(0,1).toUpperCase())}</div>
                        <div class="flex-1">
                            <div class="flex items-center gap-1">
                                <span class="sender text-xs">${sanitize(msg.displayName||'Usuário')}</span>
                                <span class="timestamp text-xs" title="${createdAt ? createdAt.toLocaleString('pt-BR') : ''}">${createdAt ? createdAt.toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'}) : ''}</span>
                                ${canDelete ? `<button class="delete-chat-msg-btn" data-msg-id="${msgId}" title="Apagar mensagem"><i class="fas fa-trash-alt text-xs"></i></button>` : ''}
                            </div>
                            <div class="content text-xs leading-tight">${sanitize(msg.text)}</div>
                        </div>
                    `;
                    kanbanChatMessages.appendChild(msgDiv);
                    if (canDelete) {
                        msgDiv.querySelector('.delete-chat-msg-btn')?.addEventListener('click', async () => {
                            showMessageModal('Apagar Mensagem', 'Tem certeza que deseja apagar esta mensagem?', 'warning', async () => {
                                msgDiv.style.opacity = 0.3;
                                await deleteDoc(doc(chatCollectionRef, msgId));
                            }, 'Apagar', true, 'Cancelar');
                        });
                    }
                });
                if (hasOld) await batch.commit();
                setTimeout(()=>{ 
                    adjustChatHeight();
                    kanbanChatMessages.scrollTo({top: kanbanChatMessages.scrollHeight, behavior:'smooth'}); 
                }, 100);
            }, (err) => {
                kanbanChatMessages.innerHTML = '<div class="text-center text-red-500 mt-6">Erro ao carregar chat. Verifique sua conexão.</div>';
            });
            kanbanChatInput.value = '';
            kanbanChatForm.querySelector('button[type="submit"]').disabled = true;
        }
        // Envio de mensagem
        kanbanChatForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = kanbanChatInput.value.trim();
            if (!text || !chatCollectionRef) return;
            if (text.length > 500) { showToast('Mensagem muito longa (máx 500 caracteres).', 'info'); return; }
            if (text.split('\n').length > 10) { showToast('Mensagem com muitas linhas (máx 10).', 'info'); return; }
            if (Date.now() - lastChatSend < 1200) { showToast('Espere um pouco antes de enviar outra mensagem.', 'info'); return; }
            lastChatSend = Date.now();
            kanbanChatForm.querySelector('button[type="submit"]').disabled = true;
            await addDoc(chatCollectionRef, {
                text: text,
                userId: currentUserId,
                displayName: currentUserDisplayName,
                createdAt: serverTimestamp()
            });
            kanbanChatInput.value = '';
        });
        // Limpar chat
        clearChatBtn?.addEventListener('click', async () => {
            if (!chatCollectionRef) return;
            showMessageModal('Limpar Chat', 'Tem certeza que deseja apagar todas as mensagens do chat deste quadro?', 'warning', async () => {
                const q = query(chatCollectionRef);
                const snap = await getDocs(q);
                const batch = writeBatch(db);
                snap.forEach(docSnap => batch.delete(doc(chatCollectionRef, docSnap.id)));
                await batch.commit();
                showToast('Chat limpo com sucesso!', 'success');
            }, 'Limpar', true, 'Cancelar');
        });


        // --- SISTEMA DE BOTÕES DE ESTOQUE NO MENU PRINCIPAL ---
        const openInventoryBtn = document.getElementById('openInventoryBtn');
        openInventoryBtn?.addEventListener('click', () => {
            document.getElementById('inventoryModal').classList.remove('hidden');
        });

        // --- SISTEMA DE MODAIS DE ESTOQUE ---
        const inventoryModal = document.getElementById('inventoryModal');
        const closeInventoryModalBtn = document.getElementById('closeInventoryModalBtn');
        inventoryModal?.addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                inventoryModal.classList.add('hidden');
            }
        });
        closeInventoryModalBtn?.addEventListener('click', () => {
            inventoryModal.classList.add('hidden');
        });

        // --- SISTEMA DE MODAIS DE ADIÇÃO DE PRODUTOS ---
        const addProductModal = document.getElementById('addProductModal');
        addProductModal?.addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                document.getElementById('addProductModal').classList.add('hidden');
            }
        });

        // --- SISTEMA DE MODAIS DE RETIRADA DE PRODUTOS ---
        const withdrawProductModal = document.getElementById('withdrawProductModal');
        withdrawProductModal?.addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                document.getElementById('withdrawProductModal').classList.add('hidden');
            }
        });

        // --- SISTEMA DE ESTOQUE INTEGRADO AO QUADRO ---

        // --- FUNÇÕES RESTAURADAS OTIMIZADAS ---
        
        /**
         * FUNÇÃO RESTAURADA OTIMIZADA: openInventoryRequestsApprovalModal
         * DESCRIÇÃO: Abre o modal para aprovar solicitações usando showMessageModal existente
         * PERMISSÃO: canApproveRequests
         * CATEGORIA: Sistema de Aprovação de Solicitações
         * OTIMIZAÇÃO: Usa showMessageModal em vez de criar novo código
         */
        window.openInventoryRequestsApprovalModal = function(boardData) {
            if (!hasPermission(boardData, currentUserId, 'canApproveRequests')) {
                showToast('Você não tem permissão para aprovar solicitações.', 'error');
                return;
            }
            
            // Implementação real da funcionalidade
            showLoading();
            
            // Buscar solicitações pendentes no Firestore
            const requestsQuery = query(
                collection(db, 'inventoryRequests'),
                where('boardId', '==', activeBoardId),
                where('status', '==', 'pending')
            );
            
            getDocs(requestsQuery).then((snapshot) => {
                hideLoading();
                
                if (snapshot.empty) {
                    showMessageModal(
                        'Aprovar Solicitações',
                        'Não há solicitações pendentes para aprovação.',
                        'info'
                    );
                    return;
                }
                
                const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                let requestsHtml = '<div class="space-y-3 max-h-96 overflow-y-auto">';
                
                requests.forEach(request => {
                    const requestDate = request.createdAt?.toDate ? request.createdAt.toDate().toLocaleString('pt-BR') : 'Data não disponível';
                    requestsHtml += `
                        <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-medium text-gray-800">${request.productName || 'Produto não especificado'}</h4>
                                    <p class="text-sm text-gray-600">Quantidade: ${request.quantity} ${request.unit || ''}</p>
                                    <p class="text-sm text-gray-600">Solicitante: ${request.requesterName || 'N/A'}</p>
                                    <p class="text-sm text-gray-500">Data: ${requestDate}</p>
                                    ${request.reason ? `<p class="text-sm text-gray-600 mt-1"><strong>Motivo:</strong> ${request.reason}</p>` : ''}
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="approveRequest('${request.id}')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">Aprovar</button>
                                    <button onclick="rejectRequest('${request.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Rejeitar</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                requestsHtml += '</div>';
                
                showMessageModal(
                    'Aprovar Solicitações de Estoque',
                    requestsHtml,
                    'info'
                );
            }).catch((error) => {
                hideLoading();
                console.error('Erro ao carregar solicitações:', error);
                showMessageModal(
                    'Erro',
                    `Erro ao carregar solicitações: ${error.message}`,
                    'error'
                );
            });
        };

        /**
         * FUNÇÃO RESTAURADA OTIMIZADA: openInventoryCategoriesManagementModal
         * DESCRIÇÃO: Abre o modal para gerenciar categorias usando showMessageModal existente
         * PERMISSÃO: canManageCategories
         * CATEGORIA: Sistema de Gerenciamento de Categorias
         * OTIMIZAÇÃO: Usa showMessageModal em vez de criar novo código
         */
        window.openInventoryCategoriesManagementModal = function(boardData) {
            if (!hasPermission(boardData, currentUserId, 'canManageCategories')) {
                showToast('Você não tem permissão para gerenciar categorias.', 'error');
                return;
            }
            
            // Implementação real da funcionalidade
            showLoading();
            
            // Buscar categorias existentes no Firestore
            const categoriesQuery = query(
                collection(db, 'inventoryCategories'),
                where('boardId', '==', activeBoardId)
            );
            
            getDocs(categoriesQuery).then((snapshot) => {
                hideLoading();
                
                let categoriesHtml = '<div class="space-y-4">';
                categoriesHtml += '<div class="mb-4"><h4 class="font-medium text-gray-800 mb-2">Adicionar Nova Categoria</h4>';
                categoriesHtml += '<div class="flex space-x-2"><input type="text" id="newCategoryName" placeholder="Nome da categoria" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">';
                categoriesHtml += '<button onclick="addNewCategory()" class="bg-indigo-500 text-white px-4 py-2 rounded-md hover:bg-indigo-600">Adicionar</button></div></div>';
                
                if (snapshot.empty) {
                    categoriesHtml += '<p class="text-gray-500 italic">Nenhuma categoria encontrada.</p>';
                } else {
                    categoriesHtml += '<div class="space-y-2 max-h-64 overflow-y-auto">';
                    snapshot.docs.forEach(doc => {
                        const category = { id: doc.id, ...doc.data() };
                        categoriesHtml += `
                            <div class="flex justify-between items-center p-2 border border-gray-200 rounded">
                                <span class="text-gray-800">${category.name}</span>
                                <button onclick="deleteCategory('${category.id}')" class="text-red-500 hover:text-red-700 px-2 py-1">Excluir</button>
                            </div>
                        `;
                    });
                    categoriesHtml += '</div>';
                }
                
                categoriesHtml += '</div>';
                
                showMessageModal(
                    'Gerenciar Categorias de Produtos',
                    categoriesHtml,
                    'info'
                );
            }).catch((error) => {
                hideLoading();
                console.error('Erro ao carregar categorias:', error);
                showMessageModal(
                    'Erro',
                    `Erro ao carregar categorias: ${error.message}`,
                    'error'
                );
            });
        };

        // Funções auxiliares para as funcionalidades restauradas
        window.approveRequest = function(requestId) {
            if (!hasPermission(activeBoardData, currentUserId, 'canApproveRequests')) {
                showToast('Você não tem permissão para aprovar solicitações.', 'error');
                return;
            }
            
            showLoading();
            const requestRef = doc(db, 'inventoryRequests', requestId);
            
            // ---> ADIÇÃO DA LÓGICA DE PRAZO <---
            const deadlineDate = new Date();
            deadlineDate.setDate(deadlineDate.getDate() + 8); // Adiciona 8 dias
            
            updateDoc(requestRef, { 
                status: 'approved', 
                approvedAt: serverTimestamp(), 
                approvedBy: currentUserId,
                deadline: deadlineDate // Salva o prazo final
            })
                .then(() => {
                    hideLoading();
                    showToast('Solicitação aprovada!', 'success');
                    // Recarregar o modal
                    window.openInventoryRequestsApprovalModal(activeBoardData);
                })
                .catch((error) => {
                    hideLoading();
                    console.error('Erro ao aprovar solicitação:', error);
                    showToast(`Erro ao aprovar: ${error.message}`, 'error');
                });
        };

        window.rejectRequest = function(requestId) {
            if (!hasPermission(activeBoardData, currentUserId, 'canApproveRequests')) {
                showToast('Você não tem permissão para rejeitar solicitações.', 'error');
                return;
            }
            
            showLoading();
            const requestRef = doc(db, 'inventoryRequests', requestId);
            updateDoc(requestRef, { status: 'rejected', rejectedAt: serverTimestamp(), rejectedBy: currentUserId })
                .then(() => {
                    hideLoading();
                    showToast('Solicitação rejeitada!', 'success');
                    // Recarregar o modal
                    window.openInventoryRequestsApprovalModal(activeBoardData);
                })
                .catch((error) => {
                    hideLoading();
                    console.error('Erro ao rejeitar solicitação:', error);
                    showToast(`Erro ao rejeitar: ${error.message}`, 'error');
                });
        };

        window.addNewCategory = function() {
            if (!hasPermission(activeBoardData, currentUserId, 'canManageCategories')) {
                showToast('Você não tem permissão para gerenciar categorias.', 'error');
                return;
            }
            
            const categoryName = document.getElementById('newCategoryName')?.value?.trim();
            if (!categoryName) {
                showToast('Nome da categoria é obrigatório.', 'error');
                return;
            }
            
            showLoading();
            addDoc(collection(db, 'inventoryCategories'), {
                name: categoryName,
                boardId: activeBoardId,
                createdAt: serverTimestamp(),
                createdBy: currentUserId
            })
            .then(() => {
                hideLoading();
                showToast('Categoria adicionada!', 'success');
                // Recarregar o modal
                window.openInventoryCategoriesManagementModal(activeBoardData);
            })
            .catch((error) => {
                hideLoading();
                console.error('Erro ao adicionar categoria:', error);
                showToast(`Erro ao adicionar: ${error.message}`, 'error');
            });
        };

        window.deleteCategory = function(categoryId) {
            if (!hasPermission(activeBoardData, currentUserId, 'canManageCategories')) {
                showToast('Você não tem permissão para gerenciar categorias.', 'error');
                return;
            }
            
            showMessageModal(
                'Confirmar Exclusão',
                'Tem certeza que deseja excluir esta categoria?',
                'warning',
                () => {
                    showLoading();
                    deleteDoc(doc(db, 'inventoryCategories', categoryId))
                        .then(() => {
                            hideLoading();
                            showToast('Categoria excluída!', 'success');
                            // Recarregar o modal
                            window.openInventoryCategoriesManagementModal(activeBoardData);
                        })
                        .catch((error) => {
                            hideLoading();
                            console.error('Erro ao excluir categoria:', error);
                            showToast(`Erro ao excluir: ${error.message}`, 'error');
                        });
                },
                'Excluir',
                true,
                'Cancelar'
            );
        };

        // Exibir botão Estoque só dentro do quadro
        function toggleInventoryBtn(show) {
            if (openInventoryBtn) openInventoryBtn.style.display = show ? 'flex' : 'none';
        }
        // Chamar ao entrar/sair do quadro
        const oldSetActiveBoardInventory = activateBoardAndSetup;
        activateBoardAndSetup = async function(boardId, boardData) {
            await oldSetActiveBoardInventory(boardId, boardData);
            toggleInventoryBtn(true);
            setupInventory(boardId, boardData);
        };
        backToBoardsButton?.addEventListener('click', () => {
            toggleInventoryBtn(false);
            document.getElementById('inventoryModal').classList.add('hidden');
        });
        toggleInventoryBtn(false);

        // Firestore refs
        let inventoryCollectionRef = null;
        let inventoryUnsub = null;
        let currentInventoryProducts = [];
        let currentBoardInventoryId = null;
        // Permissões do Sistema de Estoque
        function canManageInventory(boardData) {
            if (!boardData) return false;
            return hasPermission(boardData, currentUserId, 'canManageInventory') || (boardData.owner === currentUserId);
        }

        function canWithdrawInventory(boardData) {
            if (!boardData) return false;
            return hasPermission(boardData, currentUserId, 'canWithdrawInventory') || canManageInventory(boardData);
        }

        function canApproveRequests(boardData) {
            if (!boardData) return false;
            return hasPermission(boardData, currentUserId, 'canApproveRequests') || canManageInventory(boardData);
        }

        function canViewReports(boardData) {
            if (!boardData) return false;
            return hasPermission(boardData, currentUserId, 'canViewReports') || canManageInventory(boardData);
        }

        function canManageCategories(boardData) {
            if (!boardData) return false;
            return hasPermission(boardData, currentUserId, 'canManageCategories') || canManageInventory(boardData);
        }

        function canApproveReturns(boardData) {
            if (!boardData) return false;
            return hasPermission(boardData, currentUserId, 'canApproveReturns') || canManageInventory(boardData);
        }
        // Setup Inventory
        function setupInventory(boardId, boardData) {
            currentBoardInventoryId = boardId;
            inventoryCollectionRef = collection(db, `artifacts/${appIdFromGlobal}/boards/${boardId}/inventoryProducts`);
            if (inventoryUnsub) inventoryUnsub();
            const inventoryList = document.getElementById('inventoryList');
            const addProductBtn = document.getElementById('addProductBtn');
            if (canManageInventory(boardData)) {
                addProductBtn.classList.remove('hidden');
            } else {
                addProductBtn.classList.add('hidden');
            }
            // Listener de produtos
            inventoryUnsub = onSnapshot(inventoryCollectionRef, (snapshot) => {
                currentInventoryProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderInventoryList(currentInventoryProducts, boardData);
            });
        }
        // Renderizar lista de produtos
        function renderInventoryList(products, boardData) {
            const inventoryList = document.getElementById('inventoryList');
            const searchInput = document.getElementById('inventorySearchInput');
            const search = searchInput ? searchInput.value.toLowerCase() : '';
            if (!inventoryList) return;
            inventoryList.innerHTML = '';
            let filtered = Array.isArray(products) ? products.filter(p => p.name && p.name.toLowerCase().includes(search)) : [];
            if (filtered.length === 0) {
                inventoryList.innerHTML = '<div class="text-center text-gray-400 py-8">Nenhum produto encontrado.</div>';
                return;
            }
            filtered.forEach(prod => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between py-3 px-2 hover:bg-emerald-50 rounded transition';
                div.innerHTML = `
                    <div>
                        <div class="font-semibold text-emerald-800 text-base">${prod.name || ''}</div>
                        <div class="text-xs text-gray-500">${prod.code || ''} ${prod.category ? ' | ' + prod.category : ''}</div>
                        <div class="text-xs text-gray-600">Estoque: <span class="font-bold">${Number(prod.qty) || 0}</span> ${prod.unit || ''}</div>
                    </div>
                    <div class="flex gap-2">
                        <button class="withdraw-btn bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded text-xs font-medium" data-id="${prod.id}" title="Retirar" ${(canWithdrawInventory(boardData) && (Number(prod.qty) > 0)) ? '' : 'disabled'}>Retirar</button>
                        <button class="history-btn text-emerald-700 hover:text-emerald-900 px-2 py-1 rounded text-xs font-medium" data-id="${prod.id}" title="Histórico"><i class="fas fa-history"></i></button>
                        ${canManageInventory(boardData) ? `<button class="edit-btn text-blue-600 hover:text-blue-800 px-2 py-1 rounded text-xs font-medium" data-id="${prod.id}" title="Editar"><i class="fas fa-edit"></i></button><button class="delete-btn text-red-600 hover:text-red-800 px-2 py-1 rounded text-xs font-medium" data-id="${prod.id}" title="Excluir"><i class="fas fa-trash-alt"></i></button>` : ''}
                    </div>
                `;
                // Retirar produto
                const withdrawBtn = div.querySelector('.withdraw-btn');
                if (withdrawBtn) withdrawBtn.addEventListener('click', () => openWithdrawModal(prod));
                // Histórico
                const historyBtn = div.querySelector('.history-btn');
                if (historyBtn) historyBtn.addEventListener('click', () => openProductHistory(prod));
                // Editar e Excluir produto
                if (canManageInventory(boardData)) {
                    const editBtn = div.querySelector('.edit-btn');
                    if (editBtn) editBtn.addEventListener('click', () => openEditProductModal(prod));
                    const deleteBtn = div.querySelector('.delete-btn');
                    if (deleteBtn) deleteBtn.addEventListener('click', () => confirmDeleteProduct(prod));
                }
                inventoryList.appendChild(div);
            });
        }
        // Modal de retirada
        function openWithdrawModal(prod) {
            document.getElementById('withdrawProductModal').classList.remove('hidden');
            document.getElementById('withdrawProductIdInput').value = prod.id;
            document.getElementById('withdrawProductNameInput').value = prod.name;
            document.getElementById('withdrawQtyInput').value = '';
            document.getElementById('withdrawUnitInput').value = prod.unit || '';
            document.getElementById('withdrawReasonInput').value = '';
        }
        document.getElementById('cancelWithdrawBtn')?.addEventListener('click', () => {
            document.getElementById('withdrawProductModal').classList.add('hidden');
        });
        document.getElementById('confirmWithdrawBtn')?.addEventListener('click', async () => {
            const prodId = document.getElementById('withdrawProductIdInput').value;
            const qty = parseFloat(document.getElementById('withdrawQtyInput').value);
            const reason = document.getElementById('withdrawReasonInput').value.trim();
            if (!prodId || isNaN(qty) || qty <= 0) { showToast('Quantidade inválida.', 'info'); return; }
            const prod = currentInventoryProducts.find(p => p.id === prodId);
            if (!prod || prod.qty < qty) { showToast('Estoque insuficiente.', 'error'); return; }
            const prodRef = doc(inventoryCollectionRef, prodId);
            const movementsRef = collection(prodRef, 'movements');
            showLoading();
            try {
                await updateDoc(prodRef, { qty: prod.qty - qty });
                await addDoc(movementsRef, {
                    type: 'saida',
                    qty,
                    userId: currentUserId,
                    displayName: currentUserDisplayName,
                    date: serverTimestamp(),
                    reason
                });
                showToast('Retirada registrada!', 'success');
                document.getElementById('withdrawProductModal').classList.add('hidden');
            } catch (e) {
                showToast('Erro ao registrar retirada.', 'error');
            } finally {
                hideLoading();
            }
        });
        // Modal de adicionar produto
        const addProductBtnEl = document.getElementById('addProductBtn');
        if (addProductBtnEl) {
            addProductBtnEl.addEventListener('click', () => {
                // Protege o clique: só abre se tiver permissão
                if (!canManageInventory(activeBoardData)) {
                    showToast('Você não tem permissão para adicionar produtos.', 'error');
                    return;
                }
                document.getElementById('addProductModal').classList.remove('hidden');
                document.getElementById('productNameInput').value = '';
                document.getElementById('productCodeInput').value = '';
                document.getElementById('productCategoryInput').value = '';
                document.getElementById('productQtyInput').value = '';
                document.getElementById('productUnitInput').value = '';
                document.getElementById('productDescInput').value = '';
            });
        }
        const cancelAddProductBtnEl = document.getElementById('cancelAddProductBtn');
        if (cancelAddProductBtnEl) cancelAddProductBtnEl.addEventListener('click', () => {
            document.getElementById('addProductModal').classList.add('hidden');
        });
        const confirmAddProductBtnEl = document.getElementById('confirmAddProductBtn');
        if (confirmAddProductBtnEl) confirmAddProductBtnEl.addEventListener('click', async () => {
            // Protege a ação: só executa se tiver permissão
            if (!canManageInventory(activeBoardData)) {
                showToast('Você não tem permissão para adicionar produtos.', 'error');
                document.getElementById('addProductModal').classList.add('hidden');
                return;
            }
            const name = document.getElementById('productNameInput').value.trim();
            const code = document.getElementById('productCodeInput').value.trim();
            const category = document.getElementById('productCategoryInput').value.trim();
            const qty = parseFloat(document.getElementById('productQtyInput').value);
            const unit = document.getElementById('productUnitInput').value.trim();
            const desc = document.getElementById('productDescInput').value.trim();
            if (!name || isNaN(qty) || qty < 0) { showToast('Preencha nome e quantidade válida.', 'info'); return; }
            showLoading();
            try {
                await addDoc(inventoryCollectionRef, {
                    name, code, category, qty, unit, desc, createdAt: serverTimestamp()
                });
                showToast('Produto adicionado!', 'success');
                document.getElementById('addProductModal').classList.add('hidden');
            } catch (e) {
                showToast('Erro ao adicionar produto.', 'error');
            } finally {
                hideLoading();
            }
        });
        // Histórico de retiradas
        async function openProductHistory(prod) {
            showLoading();
            const prodRef = doc(inventoryCollectionRef, prod.id);
            const movementsRef = collection(prodRef, 'movements');
            const q = query(movementsRef, orderBy('date', 'desc'));
            let html = `<div class='fixed inset-0 modal-overlay flex items-center justify-center z-[100]'>
                <div class='bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg modal-content'>
                    <h3 class='text-xl font-bold text-emerald-700 mb-4'>Histórico de Retiradas<br><span class='text-base text-gray-500'>${prod.name}</span></h3>
                    <div class='max-h-96 overflow-y-auto'>`;
            try {
                const snap = await getDocs(q);
                if (snap.empty) {
                    html += `<div class='text-center text-gray-400 py-8'>Nenhuma retirada registrada.</div>`;
                } else {
                    snap.forEach(doc => {
                        const m = doc.data();
                        const dt = m.date?.toDate ? m.date.toDate().toLocaleString('pt-BR') : '';
                        html += `<div class='flex justify-between items-center border-b border-gray-100 py-2'>
                            <div><span class='font-semibold text-emerald-800'>${m.displayName||m.userId}</span> <span class='text-xs text-gray-500'>${dt}</span><br><span class='text-xs text-gray-600'>Qtd: <b>${m.qty}</b> ${prod.unit||''}</span></div>
                            <div class='text-xs text-gray-500'>${m.reason||''}</div>
                        </div>`;
                    });
                }
            } catch (e) {
                html += `<div class='text-center text-red-500 py-8'>Erro ao carregar histórico.</div>`;
            }
            html += `</div><div class='flex justify-end pt-4'><button id='closeHistoryBtn' class='bg-gray-200 text-gray-700 py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 font-medium'>Fechar</button></div></div></div>`;
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = html;
            document.body.appendChild(modalDiv);
            modalDiv.querySelector('#closeHistoryBtn').onclick = () => modalDiv.remove();
            hideLoading();
        }
        // Busca
        document.getElementById('inventorySearchInput')?.addEventListener('input', () => renderInventoryList(currentInventoryProducts, activeBoardData));

        // Exibir botões de estoque só dentro do quadro
        function toggleInventoryBtns(show) {
            const openInventoryBtn = document.getElementById('openInventoryBtn');
            const requestStockBtn = document.getElementById('requestStockBtn');
            if (openInventoryBtn) openInventoryBtn.style.display = show ? 'flex' : 'none';
            if (requestStockBtn) requestStockBtn.style.display = show ? 'flex' : 'none';
        }
        // Chamar ao entrar/sair do quadro
        const oldSetActiveBoard = activateBoardAndSetup;
        activateBoardAndSetup = async function(boardId, boardData) {
            await oldSetActiveBoard(boardId, boardData);
            toggleInventoryBtns(true);
            setupInventory(boardId, boardData);
            setupBoardChat(boardId, boardData);
        };
        backToBoardsButton?.addEventListener('click', () => {
            toggleInventoryBtns(false);
            document.getElementById('inventoryModal').classList.add('hidden');
        });
        toggleInventoryBtns(false);

        // Listener do botão Estoque (já existe)
        document.getElementById('openInventoryBtn')?.addEventListener('click', () => {
            document.getElementById('inventoryModal').classList.remove('hidden');
        });
        // Listener do botão Solicitar Item
        const requestStockBtn = document.getElementById('requestStockBtn');
        if (requestStockBtn) {
            requestStockBtn.addEventListener('click', () => {
                const modal = document.getElementById('requestStockModal');
                if (modal) modal.classList.remove('hidden');
            });
        }
        

        // Função para fechar modal ao clicar fora ou no botão cancelar
        function setupModalClose(modalId, cancelBtnId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            // Fechar ao clicar fora
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.add('hidden');
            });
            // Fechar ao clicar no botão cancelar
            if (cancelBtnId) {
                const cancelBtn = document.getElementById(cancelBtnId);
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        modal.classList.add('hidden');
                    });
                }
            }
        }
        setupModalClose('requestStockModal', 'cancelRequestStockBtn');
        setupModalClose('requestStockModal', 'cancelRequestStockBtn');

        // Após a função renderInventoryList:
        function openEditProductModal(prod) {
            document.getElementById('editProductModal').classList.remove('hidden');
            document.getElementById('editProductIdInput').value = prod.id;
            document.getElementById('editProductNameInput').value = prod.name || '';
            document.getElementById('editProductCodeInput').value = prod.code || '';
            document.getElementById('editProductCategoryInput').value = prod.category || '';
            document.getElementById('editProductQtyInput').value = prod.qty || 0;
            document.getElementById('editProductUnitInput').value = prod.unit || '';
            document.getElementById('editProductDescInput').value = prod.desc || '';
        }

        async function confirmDeleteProduct(prod) {
            if (!prod.id) return;
            if (!confirm('Tem certeza que deseja excluir este produto?')) return;
            showLoading();
            try {
                const prodRef = doc(inventoryCollectionRef, prod.id);
                await deleteDoc(prodRef);
                showToast('Produto excluído!', 'success');
                document.getElementById('editProductModal').classList.add('hidden');
            } catch (e) {
                showToast('Erro ao excluir produto.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Listeners do modal de edição
        const cancelEditProductBtn = document.getElementById('cancelEditProductBtn');
        if (cancelEditProductBtn) cancelEditProductBtn.addEventListener('click', () => {
            document.getElementById('editProductModal').classList.add('hidden');
        });
        const saveEditProductBtn = document.getElementById('saveEditProductBtn');
        if (saveEditProductBtn) saveEditProductBtn.addEventListener('click', async () => {
            const prodId = document.getElementById('editProductIdInput').value;
            const name = document.getElementById('editProductNameInput').value.trim();
            const code = document.getElementById('editProductCodeInput').value.trim();
            const category = document.getElementById('editProductCategoryInput').value.trim();
            const qty = parseFloat(document.getElementById('editProductQtyInput').value);
            const unit = document.getElementById('editProductUnitInput').value.trim();
            const desc = document.getElementById('editProductDescInput').value.trim();
            if (!prodId || !name || isNaN(qty) || qty < 0) { showToast('Preencha nome e quantidade válida.', 'info'); return; }
            showLoading();
            try {
                const prodRef = doc(inventoryCollectionRef, prodId);
                await updateDoc(prodRef, { name, code, category, qty, unit, desc });
                showToast('Produto atualizado!', 'success');
                document.getElementById('editProductModal').classList.add('hidden');
            } catch (e) {
                showToast('Erro ao atualizar produto.', 'error');
            } finally {
                hideLoading();
            }
        });
        const deleteProductBtn = document.getElementById('deleteProductBtn');
        if (deleteProductBtn) deleteProductBtn.addEventListener('click', async () => {
            const prodId = document.getElementById('editProductIdInput').value;
            if (!prodId) return;
            if (!confirm('Tem certeza que deseja excluir este produto?')) return;
            showLoading();
            try {
                const prodRef = doc(inventoryCollectionRef, prodId);
                await deleteDoc(prodRef);
                showToast('Produto excluído!', 'success');
                document.getElementById('editProductModal').classList.add('hidden');
            } catch (e) {
                showToast('Erro ao excluir produto.', 'error');
            } finally {
                hideLoading();
            }
        });
        // ... existing code ...
        // Dentro de renderInventoryList, após inventoryList.appendChild(div):
        if (canManageInventory(activeBoardData)) {
            div.querySelector('.edit-btn')?.addEventListener('click', () => openEditProductModal(prod));
            div.querySelector('.delete-btn')?.addEventListener('click', () => confirmDeleteProduct(prod));
        }
        // ... existing code ...

        // [REMOVER botão antigo 'Meus Itens']
        const oldBtn = document.getElementById('myItemsBtn');
        if (oldBtn) oldBtn.remove();

        // [2] Modal de 'Meus Itens'
        if (!document.getElementById('myItemsModal')) {
            const modal = document.createElement('div');
            modal.id = 'myItemsModal';
            modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-[100] hidden';
            modal.innerHTML = `
              <div class='bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg modal-content flex flex-col'>
                <div class='flex justify-between items-center mb-4'>
                  <h3 class='text-2xl font-bold text-blue-700 flex items-center'><i class='fas fa-box mr-2'></i>Meus Itens Retirados</h3>
                  <button id='closeMyItemsModalBtn' class='text-gray-400 hover:text-red-500 text-2xl p-1 rounded-full transition'><i class='fas fa-times'></i></button>
                </div>
                <div id='myItemsList' class='flex-1 overflow-y-auto divide-y divide-gray-100 mb-2'></div>
              </div>
            `;
            document.body.appendChild(modal);
        }
        document.getElementById('closeMyItemsModalBtn')?.addEventListener('click', () => {
            document.getElementById('myItemsModal').classList.add('hidden');
        });
        document.getElementById('myItemsFabBtn')?.addEventListener('click', () => {
            loadAndShowMyItems();
        });

        // [3] Função para carregar e exibir retiradas do usuário (VERSÃO APRIMORADA)
        async function loadAndShowMyItems() {
            if (!activeBoardId || !currentUserId) return;
            const modal = document.getElementById('myItemsModal');
            const list = document.getElementById('myItemsList');
            if (!modal || !list) return;
            list.innerHTML = '<div class="text-center text-gray-400 py-8">Carregando...</div>';
            modal.classList.remove('hidden');
            try {
                const userWithdrawalsRef = collection(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}/userWithdrawals`);
                const q = query(userWithdrawalsRef, where('userId', '==', currentUserId), where('status', 'in', ['retirado', 'devolucao_pendente']));
                const snap = await getDocs(q);
                if (snap.empty) {
                    list.innerHTML = '<div class="text-center text-gray-400 py-8">Você não possui nenhum item retirado.</div>';
                    return;
                }
                list.innerHTML = '';
                snap.forEach(docSnap => {
                    const item = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between py-3 px-2';

                    const now = new Date();
                    const deadline = item.deadline?.toDate ? item.deadline.toDate() : null;
                    let deadlineHtml = '';
                    let isOverdue = false;

                    if (deadline) {
                        const diffTime = deadline - now;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        isOverdue = diffTime < 0;

                        if (isOverdue) {
                            deadlineHtml = `<div class='text-xs font-semibold text-red-600'>ATRASADO HÁ ${Math.abs(diffDays)} DIA(S)</div>`;
                        } else {
                            deadlineHtml = `<div class='text-xs text-gray-500'>Prazo: ${diffDays} dia(s) restante(s)</div>`;
                        }
                    }
                    
                    let statusHtml = '';
                    if (item.status === 'devolucao_pendente') {
                        statusHtml = `<span class='text-xs text-yellow-600 font-semibold ml-2'>(Aguardando aprovação de devolução)</span>`;
                    }

                    let buttonsHtml = '';
                    if (item.status === 'retirado' && !isOverdue) {
                         buttonsHtml = `
                            <button class='used-item-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded text-xs font-medium' data-id='${docSnap.id}'>Marcar como Usado</button>
                            <button class='return-item-btn bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1.5 rounded text-xs font-medium ml-2' data-id='${docSnap.id}'>Devolver</button>
                        `;
                    } else if (isOverdue) {
                        buttonsHtml = `<button class='justify-overdue-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-xs font-medium' data-id='${docSnap.id}'>Justificar Atraso</button>`;
                    }

                    div.innerHTML = `
                        <div>
                            <div class='font-semibold text-blue-800 text-base'>${item.prodName || ''}</div>
                            <div class='text-xs text-gray-500'>Qtd: <b>${item.qty}</b> ${item.unit || ''}</div>
                            <div class='text-xs text-gray-400'>Retirado em: ${item.date ? new Date(item.date.seconds*1000).toLocaleDateString('pt-BR') : ''}</div>
                            ${deadlineHtml}
                            ${statusHtml}
                        </div>
                        <div class='flex gap-2'>
                            ${buttonsHtml}
                        </div>
                    `;
                    list.appendChild(div);
                });

                // Adicionar Listeners para os novos botões
                list.querySelectorAll('.used-item-btn').forEach(btn => btn.addEventListener('click', (e) => handleMarkAsUsed(e.currentTarget.dataset.id)));
                list.querySelectorAll('.justify-overdue-btn').forEach(btn => btn.addEventListener('click', (e) => handleJustifyOverdue(e.currentTarget.dataset.id)));
                
                // Listeners antigos (Devolver)
                list.querySelectorAll('.return-item-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const withdrawalId = e.currentTarget.getAttribute('data-id');
                        if (!withdrawalId) return;
                        showLoading();
                        try {
                            const userWithdrawalsRef = collection(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}/userWithdrawals`);
                            const withdrawalDoc = doc(userWithdrawalsRef, withdrawalId);
                            await updateDoc(withdrawalDoc, { status: 'devolucao_pendente', returnRequestDate: serverTimestamp() });
                            showToast('Solicitação de devolução enviada para o administrador!', 'info');
                            loadAndShowMyItems();
                        } catch (err) {
                            showToast('Erro ao solicitar devolução.', 'error');
                        } finally {
                            hideLoading();
                        }
                    });
                });
            } catch (err) {
                list.innerHTML = '<div class="text-center text-red-500 py-8">Erro ao carregar seus itens.</div>';
            }
        }

        // Listener para fechar o modal de Meus Itens
        document.getElementById('closeMyItemsModalBtn')?.addEventListener('click', () => {
            document.getElementById('myItemsModal')?.classList.add('hidden');
        });

        // Novas funções para controle do ciclo de vida dos itens
        async function handleMarkAsUsed(withdrawalId) {
            if (!withdrawalId) return;

            showMessageModal(
                'Confirmar Uso do Item',
                'Esta ação removerá o item do seu inventário. Deseja continuar?',
                'info',
                async () => {
                    showLoading();
                    try {
                        const withdrawalRef = doc(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}/userWithdrawals`, withdrawalId);
                        await updateDoc(withdrawalRef, {
                            status: 'usado',
                            usedAt: serverTimestamp()
                        });
                        showToast('Item marcado como usado!', 'success');
                        loadAndShowMyItems(); // Recarrega a lista
                    } catch (err) {
                        showToast('Erro ao marcar item como usado.', 'error');
                        console.error(err);
                    } finally {
                        hideLoading();
                    }
                },
                'Confirmar', true, 'Cancelar'
            );
        }

        async function handleJustifyOverdue(withdrawalId) {
            if (!withdrawalId) return;
            // Por enquanto, uma simples notificação. Uma lógica de justificativa pode ser adicionada aqui.
            showMessageModal(
                'Item Atrasado',
                'Este item passou do prazo de 8 dias para devolução ou uso. Por favor, procure o administrador do quadro para regularizar a situação.',
                'warning'
            );
        }

        // [4] Ao retirar produto, registrar também em userWithdrawals
        const oldConfirmWithdrawBtn = document.getElementById('confirmWithdrawBtn')?.onclick;
        document.getElementById('confirmWithdrawBtn')?.addEventListener('click', async () => {
            // ...código original de retirada...
            // Após registrar a retirada no produto, registrar em userWithdrawals:
            try {
                const prodId = document.getElementById('withdrawProductIdInput').value;
                const qty = parseFloat(document.getElementById('withdrawQtyInput').value);
                const reason = document.getElementById('withdrawReasonInput').value.trim();
                const prod = currentInventoryProducts.find(p => p.id === prodId);
                if (!prod || isNaN(qty) || qty <= 0) return;
                const userWithdrawalsRef = collection(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}/userWithdrawals`);
                await addDoc(userWithdrawalsRef, {
                    userId: currentUserId,
                    displayName: currentUserDisplayName,
                    prodId: prod.id,
                    prodName: prod.name,
                    qty,
                    unit: prod.unit || '',
                    date: serverTimestamp(),
                    status: 'retirado',
                    reason
                });
            } catch (err) {
                // Não impede a retirada, mas loga erro
                console.warn('Erro ao registrar retirada em userWithdrawals:', err);
            }
            // ...continua código original...
        });

        // [5] Botão flutuante para admin ver devoluções pendentes
        function checkShowAdminReturnsBtn() {
            if (activeBoardData && canManageInventory(activeBoardData)) {
                const btn = document.getElementById('adminReturnsBtn');
                if (btn) btn.style.display = 'flex';
            } else {
                const btn = document.getElementById('adminReturnsBtn');
                if (btn) btn.style.display = 'none';
            }
        }
        // --- CENTRALIZAÇÃO DOS BOTÕES FLUTUANTES ---
        // ⚠️ ATENÇÃO: Esta seção é apenas para compatibilidade
        // NÃO adicione novos botões aqui - use a função toggleFabs real acima
        
        // Função temporária para compatibilidade (NÃO USAR PARA NOVOS BOTÕES)
        function safeToggleFabs(show, boardData) {
            // ⚠️ ATENÇÃO: Esta é uma versão simplificada apenas para compatibilidade
            // NÃO adicione novos botões aqui - use a função toggleFabs real acima
            const btnIds = ['openInventoryBtn', 'requestStockBtn', 
                            'myItemsFabBtn', 'pendingRequestsBtn', 'myRequestsBtn', 
                            'adminReturnsBtn', 'inventoryReportsBtn'];
            
            if (!show) {
                btnIds.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.style.display = 'none';
                });
                return;
            }
            
            // Versão simplificada para quando boardData estiver disponível
            if (boardData && currentUserId) {
                const isOwner = boardData.owner === currentUserId;
                btnIds.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) btn.style.display = isOwner ? 'flex' : 'none';
                });
            }
        }
        
        // ⚠️ IMPORTANTE: NÃO sobrescrever a função toggleFabs real!
        // A linha abaixo foi removida para manter a função correta
        // window.toggleFabs = safeToggleFabs; // ← ESTA LINHA FOI REMOVIDA
        
        if (typeof window._oldSetActiveBoardBackup === 'undefined') {
            window._oldSetActiveBoardBackup = typeof activateBoardAndSetup === 'function' ? activateBoardAndSetup : undefined;
            activateBoardAndSetup = async function(boardId, boardData) {
                if (window._oldSetActiveBoardBackup) await window._oldSetActiveBoardBackup(boardId, boardData);
                window.toggleFabs(true, activeBoardData);
                toggleInventoryBtn(true);
                checkShowAdminReturnsBtn();
            };
            backToBoardsButton?.addEventListener('click', () => {
                window.toggleFabs(false);
                toggleInventoryBtn(false);
                const adminReturnsBtn = document.getElementById('adminReturnsBtn');
                if (adminReturnsBtn) adminReturnsBtn.style.display = 'none';
            });
            window.toggleFabs(false);
            toggleInventoryBtn(false);
            const adminReturnsBtn = document.getElementById('adminReturnsBtn');
            if (adminReturnsBtn) adminReturnsBtn.style.display = 'none';
        }
        // --- FIM CENTRALIZAÇÃO ---
        // [6] Modal de devoluções pendentes para admin
        if (!document.getElementById('adminReturnsModal')) {
            const modal = document.createElement('div');
            modal.id = 'adminReturnsModal';
            modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-[101] hidden';
            modal.innerHTML = `
              <div class='bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg modal-content flex flex-col'>
                <div class='flex justify-between items-center mb-4'>
                  <h3 class='text-2xl font-bold text-yellow-700 flex items-center'><i class='fas fa-undo mr-2'></i>Devoluções Pendentes</h3>
                  <button id='closeAdminReturnsModalBtn' class='text-gray-400 hover:text-red-500 text-2xl p-1 rounded-full transition'><i class='fas fa-times'></i></button>
                </div>
                <div id='adminReturnsList' class='flex-1 overflow-y-auto divide-y divide-gray-100 mb-2'></div>
              </div>
            `;
            document.body.appendChild(modal);
        }
        document.getElementById('closeAdminReturnsModalBtn')?.addEventListener('click', () => {
            document.getElementById('adminReturnsModal').classList.add('hidden');
        });

        // [7] Função para carregar e exibir devoluções pendentes
        async function loadAndShowAdminReturns() {
            if (!activeBoardId || !canManageInventory(activeBoardData)) return;
            const modal = document.getElementById('adminReturnsModal');
            const list = document.getElementById('adminReturnsList');
            if (!modal || !list) return;
            list.innerHTML = '<div class="text-center text-gray-400 py-8">Carregando...</div>';
            modal.classList.remove('hidden');
            try {
                const userWithdrawalsRef = collection(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}/userWithdrawals`);
                const q = query(userWithdrawalsRef, where('status', '==', 'devolucao_pendente'));
                const snap = await getDocs(q);
                if (snap.empty) {
                    list.innerHTML = '<div class="text-center text-gray-400 py-8">Nenhuma devolução pendente.</div>';
                    return;
                }
                list.innerHTML = '';
                snap.forEach(docSnap => {
                    const item = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between py-3 px-2';
                    div.innerHTML = `
                        <div>
                            <div class='font-semibold text-yellow-800 text-base'>${item.prodName || ''}</div>
                            <div class='text-xs text-gray-500'>Qtd: <b>${item.qty}</b> ${item.unit || ''}</div>
                            <div class='text-xs text-gray-400'>${item.date ? new Date(item.date.seconds*1000).toLocaleString('pt-BR') : ''}</div>
                            <div class='text-xs text-gray-600'>Solicitante: <b>${item.displayName || item.userId}</b></div>
                            <div class='text-xs text-gray-400'>Motivo: ${item.reason || ''}</div>
                        </div>
                        <div class='flex flex-col gap-2'>
                            <button class='approve-return-btn bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-xs font-medium' data-id='${docSnap.id}'>Aprovar</button>
                            <button class='reject-return-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-xs font-medium' data-id='${docSnap.id}'>Recusar</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
                // Listeners para aprovar/recusar
                list.querySelectorAll('.approve-return-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const withdrawalId = e.currentTarget.getAttribute('data-id');
                        if (!withdrawalId) return;
                        showLoading();
                        try {
                            // Atualiza status para devolvido
                            const userWithdrawalsRef = collection(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}/userWithdrawals`);
                            const withdrawalDoc = doc(userWithdrawalsRef, withdrawalId);
                            await updateDoc(withdrawalDoc, { status: 'devolvido', returnApprovedAt: serverTimestamp(), returnApprovedBy: currentUserId });
                            // Atualiza estoque do produto
                            const withdrawalSnap = await getDoc(withdrawalDoc);
                            const item = withdrawalSnap.data();
                            if (item && item.prodId && item.qty) {
                                const prodRef = doc(inventoryCollectionRef, item.prodId);
                                await updateDoc(prodRef, { qty: increment(item.qty) });
                            }
                            showToast('Devolução aprovada e estoque atualizado!', 'success');
                            loadAndShowAdminReturns();
                        } catch (err) {
                            showToast('Erro ao aprovar devolução.', 'error');
                        } finally {
                            hideLoading();
                        }
                    });
                });
                list.querySelectorAll('.reject-return-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const withdrawalId = e.currentTarget.getAttribute('data-id');
                        if (!withdrawalId) return;
                        showLoading();
                        try {
                            // Volta status para retirado
                            const userWithdrawalsRef = collection(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}/userWithdrawals`);
                            const withdrawalDoc = doc(userWithdrawalsRef, withdrawalId);
                            await updateDoc(withdrawalDoc, { status: 'retirado', returnRejectedAt: serverTimestamp(), returnRejectedBy: currentUserId });
                            showToast('Solicitação de devolução recusada.', 'info');
                            loadAndShowAdminReturns();
                        } catch (err) {
                            showToast('Erro ao recusar devolução.', 'error');
                        } finally {
                            hideLoading();
                        }
                    });
                });
            } catch (err) {
                list.innerHTML = '<div class="text-center text-red-500 py-8">Erro ao carregar devoluções.</div>';
            }
        }
 
        

        // ... existing code ...

        // ... existing code ...
        // Remover todas as duplicidades, redefinições e listeners antigos relacionados aos FABs
        // ... existing code ...

        // Placeholder para manter a estrutura do código
        // A função loadProductsIntoRequestSelect foi movida para baixo

        // Função para validar solicitação (atualizada para permitir pedidos com estoque zerado)
        function validateStockRequest() {
            const select = document.getElementById('requestProductSelect');
            const qtyInput = document.getElementById('requestQtyInput');
            const reasonInput = document.getElementById('requestReasonInput');
            
            if (!select.value) {
                showToast('Selecione um produto.', 'info');
                select.focus();
                return false;
            }
            
            const qty = parseFloat(qtyInput.value);
            if (isNaN(qty) || qty <= 0) {
                showToast('Quantidade inválida.', 'info');
                qtyInput.focus();
                return false;
            }
            
            const selectedOption = select.options[select.selectedIndex];
            const availableQty = parseFloat(selectedOption.dataset.qty || 0);
            
            // Se o estoque estiver zerado ou a quantidade solicitada for maior que o disponível,
            // adiciona um aviso no motivo da solicitação
            if (availableQty <= 0 || qty > availableQty) {
                const currentReason = reasonInput.value.trim();
                const warningPrefix = '[ATENÇÃO: Solicitação acima do estoque disponível] ';
                
                if (!currentReason.startsWith(warningPrefix)) {
                    reasonInput.value = warningPrefix + currentReason;
                }
                
                // Não bloqueia a solicitação, mas exige um motivo
                if (!reasonInput.value.trim()) {
                    showToast('Por favor, informe o motivo da solicitação.', 'info');
                    reasonInput.focus();
                    return false;
                }
            } else if (!reasonInput.value.trim()) {
                showToast('Informe o motivo da solicitação.', 'info');
                reasonInput.focus();
                return false;
            }
            
            return true;
        }

        // Função para carregar produtos no select de solicitação
async function loadProductsIntoRequestSelect() {
    const select = document.getElementById('requestProductSelect');
    const unitInput = document.getElementById('requestUnitInput');
    if (!select || !unitInput) return;
    
    select.innerHTML = '<option value="">Selecione um produto...</option>';
    if (!currentInventoryProducts) return;
    
    currentInventoryProducts.forEach(prod => {
        const option = document.createElement('option');
        option.value = prod.id;
        const stockStatus = prod.qty <= 0 ? '(Sem estoque)' : `(Disponível: ${prod.qty} ${prod.unit || ''})`;
        option.textContent = `${prod.name} ${stockStatus}`;
        option.dataset.unit = prod.unit || '';
        option.dataset.qty = prod.qty || 0;
        select.appendChild(option);
    });

    // Atualizar unidade ao selecionar produto
    select.removeEventListener('change', updateUnitAndQuantity);
    select.addEventListener('change', updateUnitAndQuantity);
}

// Função auxiliar para atualizar unidade e quantidade
function updateUnitAndQuantity() {
    const select = document.getElementById('requestProductSelect');
    const unitInput = document.getElementById('requestUnitInput');
    const selectedOption = select.options[select.selectedIndex];
    unitInput.value = selectedOption.dataset.unit || '';
    
    // Atualizar máximo permitido no input de quantidade, mas não limitar
    const qtyInput = document.getElementById('requestQtyInput');
    if (qtyInput) {
        const availableQty = parseFloat(selectedOption.dataset.qty) || 0;
        qtyInput.placeholder = availableQty <= 0 ? 'Sem estoque' : `Disponível: ${availableQty}`;
        // Removido o max para permitir solicitar mais que o disponível
        qtyInput.min = "1";
    }
}

        // Atualizar a validação em tempo real do input de quantidade
        document.getElementById('requestQtyInput')?.addEventListener('input', (e) => {
            const input = e.target;
            const qty = parseFloat(input.value);
            const select = document.getElementById('requestProductSelect');
            const selectedOption = select.options[select.selectedIndex];
            const availableQty = parseFloat(selectedOption.dataset.qty || 0);
            
            if (qty > availableQty) {
                input.classList.add('border-yellow-500'); // Mudado de red para yellow
                input.title = `Atenção: Quantidade maior que disponível (${availableQty})`;
            } else {
                input.classList.remove('border-yellow-500');
                input.title = '';
            }
        });

        // ... existing code ...

        // Variáveis para controle de listeners em tempo real
        let unsubscribeRequestsSnapshot = null;
        let unsubscribeMyRequestsSnapshot = null;

        // Função para configurar listener em tempo real de solicitações pendentes
        function setupPendingRequestsListener() {
            if (!activeBoardId || !canManageInventory(activeBoardData)) return;
            if (unsubscribeRequestsSnapshot) unsubscribeRequestsSnapshot();
            
            const userWithdrawalsRef = collection(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}/userWithdrawals`);
            const q = query(userWithdrawalsRef, where('status', '==', 'pendente'));
            
            unsubscribeRequestsSnapshot = onSnapshot(q, (snapshot) => {
                const modal = document.getElementById('pendingRequestsModal');
                const list = document.getElementById('pendingRequestsList');
                if (!modal || !list || modal.classList.contains('hidden')) return;
                
                if (snapshot.empty) {
                    list.innerHTML = '<div class="text-center text-gray-400 py-8">Nenhuma solicitação pendente.</div>';
                    return;
                }
                
                list.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const item = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between py-3 px-2 hover:bg-emerald-50 rounded transition';
                    div.innerHTML = `
                        <div>
                            <div class="font-semibold text-emerald-800 text-base">${item.prodName || ''}</div>
                            <div class="text-xs text-gray-500">Qtd: <b>${item.qty}</b> ${item.unit || ''}</div>
                            <div class="text-xs text-gray-400">${item.date ? new Date(item.date.seconds*1000).toLocaleString('pt-BR') : ''}</div>
                            <div class="text-xs text-gray-600">Solicitante: <b>${item.displayName || item.userId}</b></div>
                            <div class="text-xs text-gray-400">Motivo: ${item.reason || ''}</div>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button class="approve-request-btn bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-xs font-medium" data-id="${docSnap.id}">Aprovar</button>
                            <button class="reject-request-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-xs font-medium" data-id="${docSnap.id}">Recusar</button>
                        </div>
                    `;
                    
                    div.querySelector('.approve-request-btn').addEventListener('click', () => handleRequestApproval(docSnap.id, true));
                    div.querySelector('.reject-request-btn').addEventListener('click', () => handleRequestApproval(docSnap.id, false));
                    
                    list.appendChild(div);
                });
            });
        }

        // Função para configurar listener em tempo real das minhas solicitações
        function setupMyRequestsListener() {
            if (!activeBoardId || !currentUserId) return;
            if (unsubscribeMyRequestsSnapshot) unsubscribeMyRequestsSnapshot();
            
            const userWithdrawalsRef = collection(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}/userWithdrawals`);
            const q = query(userWithdrawalsRef, 
                where('userId', '==', currentUserId),
                orderBy('date', 'desc')
            );
            
            unsubscribeMyRequestsSnapshot = onSnapshot(q, (snapshot) => {
                const modal = document.getElementById('myRequestsModal');
                const list = document.getElementById('myRequestsList');
                if (!modal || !list || modal.classList.contains('hidden')) return;
                
                if (snapshot.empty) {
                    list.innerHTML = '<div class="text-center text-gray-400 py-8">Nenhuma solicitação encontrada.</div>';
                    return;
                }
                
                list.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const item = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between py-3 px-2 hover:bg-gray-50 rounded transition';
                    
                    let statusColor, statusText;
                    switch(item.status) {
                        case 'pendente':
                            statusColor = 'bg-yellow-100 text-yellow-800';
                            statusText = 'Pendente';
                            break;
                        case 'aprovado':
                            statusColor = 'bg-green-100 text-green-800';
                            statusText = 'Aprovado';
                            break;
                        case 'rejeitado':
                            statusColor = 'bg-red-100 text-red-800';
                            statusText = 'Rejeitado';
                            break;
                        default:
                            statusColor = 'bg-gray-100 text-gray-800';
                            statusText = item.status;
                    }
                    
                    div.innerHTML = `
                        <div class="flex-1">
                            <div class="font-semibold text-gray-800 text-base">${item.prodName || ''}</div>
                            <div class="text-xs text-gray-500">Qtd: <b>${item.qty}</b> ${item.unit || ''}</div>
                            <div class="text-xs text-gray-400">${item.date ? new Date(item.date.seconds*1000).toLocaleString('pt-BR') : ''}</div>
                            <div class="text-xs text-gray-600">Motivo: ${item.reason || ''}</div>
                            ${item.approvedByDisplayName ? `<div class="text-xs text-green-600">Aprovado por: ${item.approvedByDisplayName}</div>` : ''}
                            ${item.rejectedByDisplayName ? `<div class="text-xs text-red-600">Rejeitado por: ${item.rejectedByDisplayName}</div>` : ''}
                        </div>
                        <div class="ml-4">
                            <span class="px-2 py-1 rounded text-xs font-medium ${statusColor}">${statusText}</span>
                        </div>
                    `;
                    
                    list.appendChild(div);
                });
            });
        }

        // Atualizar funções existentes para usar os listeners em tempo real
        function loadAndShowPendingRequests() {
            if (!activeBoardId || !canManageInventory(activeBoardData)) return;
            document.getElementById('pendingRequestsModal').classList.remove('hidden');
            setupPendingRequestsListener();
        }

        function loadAndShowMyRequests() {
            if (!activeBoardId || !currentUserId) return;
            document.getElementById('myRequestsModal').classList.remove('hidden');
            setupMyRequestsListener();
        }

        // Limpar listeners ao sair do quadro
        const oldBackToBoardsHandler = backToBoardsButton.onclick;
        backToBoardsButton.onclick = () => {
            if (oldBackToBoardsHandler) oldBackToBoardsHandler();
            if (unsubscribeRequestsSnapshot) unsubscribeRequestsSnapshot();
            if (unsubscribeMyRequestsSnapshot) unsubscribeMyRequestsSnapshot();
        };

        // ... existing code ...

        // Função para processar solicitação
        async function processStockRequest() {
            if (!validateStockRequest()) return;
            
            const select = document.getElementById('requestProductSelect');
            const qtyInput = document.getElementById('requestQtyInput');
            const reasonInput = document.getElementById('requestReasonInput');
            const unitInput = document.getElementById('requestUnitInput');
            
            const prodId = select.value;
            const qty = parseFloat(qtyInput.value);
            const reason = reasonInput.value.trim();
            const selectedProduct = currentInventoryProducts.find(p => p.id === prodId);
            
            if (!selectedProduct) {
                showToast('Produto não encontrado.', 'error');
                return;
            }
            
            showLoading();
            try {
                // Criar solicitação no Firestore
                const userWithdrawalsRef = collection(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}/userWithdrawals`);
                const withdrawalData = {
                    prodId,
                    prodName: selectedProduct.name,
                    qty,
                    unit: unitInput.value,
                    reason,
                    userId: currentUserId,
                    displayName: currentUserDisplayName,
                    date: serverTimestamp(),
                    status: 'pendente',
                    boardId: activeBoardId
                };

                // Adicionar solicitação
                const withdrawalRef = await addDoc(userWithdrawalsRef, withdrawalData);
                
                // Criar tarefa associada
                if (tasksCollectionRef) {
                    const firstColumn = boardColumns.sort((a,b) => (a.order || 0) - (b.order || 0))[0];
                    if (firstColumn) {
                        await addDoc(tasksCollectionRef, {
                            title: `Solicitação de Estoque: ${selectedProduct.name}`,
                            description: `Quantidade: ${qty} ${unitInput.value}\nMotivo: ${reason}\nSolicitante: ${currentUserDisplayName}`,
                            priority: 'medium',
                            status: firstColumn.id,
                            createdAt: serverTimestamp(),
                            boardId: activeBoardId,
                            withdrawalId: withdrawalRef.id,
                            assignedTo: null,
                            assignedToDisplayName: null,
                            assignedAt: null,
                            completedAt: null,
                            isBlocked: false
                        });
                    }
                }
                
                showToast('Solicitação enviada com sucesso!', 'success');
                document.getElementById('requestStockModal').classList.add('hidden');
                
                // Limpar campos
                select.value = '';
                qtyInput.value = '';
                reasonInput.value = '';
                unitInput.value = '';
                
            } catch (error) {
                console.error('Erro ao processar solicitação:', error);
                showToast('Erro ao processar solicitação.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Event Listeners
        document.getElementById('requestStockBtn')?.addEventListener('click', () => {
            loadProductsIntoRequestSelect();
            document.getElementById('requestStockModal').classList.remove('hidden');
        });

        document.getElementById('cancelRequestStockBtn')?.addEventListener('click', () => {
            document.getElementById('requestStockModal').classList.add('hidden');
        });

        document.getElementById('confirmRequestStockBtn')?.addEventListener('click', processStockRequest);

        // ... existing code ...

        // Placeholder para manter a estrutura do código
// As funções de permissão foram movidas para cima

        // Atualizar painel de permissões
        function updateInventoryPermissionsPanel() {
            const panel = document.getElementById('inventoryPermissionsPanel');
            if (panel && typeof activeBoardData !== 'undefined' && activeBoardData) {
                // Lista completa de permissões de estoque
                const estoquePerms = [
                    { 
                        key: 'canManageInventory', 
                        label: 'Gerenciar Estoque', 
                        tip: 'Controle total do estoque. Inclui todas as outras permissões.' 
                    },
                    { 
                        key: 'canWithdrawInventory', 
                        label: 'Retirar Itens', 
                        tip: 'Permite solicitar e retirar itens do estoque.' 
                    },
                    { 
                        key: 'canApproveRequests', 
                        label: 'Aprovar Solicitações', 
                        tip: 'Permite aprovar ou rejeitar pedidos de retirada.' 
                    },
                    { 
                        key: 'canViewReports', 
                        label: 'Visualizar Relatórios', 
                        tip: 'Acesso a relatórios, estatísticas e histórico do estoque.' 
                    },
                    { 
                        key: 'canManageCategories', 
                        label: 'Gerenciar Categorias', 
                        tip: 'Permite criar e editar categorias de produtos.' 
                    },
                    { 
                        key: 'canApproveReturns', 
                        label: 'Aprovar Devoluções', 
                        tip: 'Permite aprovar ou rejeitar devoluções de itens.' 
                    }
                ];

                // Pega cargos/tags únicos
                const tags = Array.from(new Set(Object.values(activeBoardData.memberTags||{}).concat(['Proprietário'])));
                const rolePerms = activeBoardData.rolePermissions || {};
                
                let html = `
                <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                    <h3 class="text-blue-800 font-semibold mb-2">Níveis de Acesso ao Estoque</h3>
                    <p class="text-sm text-blue-600">Configure as permissões para cada cargo no sistema de estoque.</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                `;
                
                tags.forEach(tag => {
                    html += `
                    <div class="rounded-lg border border-gray-200 shadow p-5 bg-gray-50 hover:bg-white transition-colors duration-200">
                        <div class="font-semibold text-base text-gray-800 mb-3 pb-2 border-b border-gray-200">${tag}</div>
                        <div class="space-y-2">
                    `;
                    
                    estoquePerms.forEach(p => {
                        const checked = rolePerms[tag] && rolePerms[tag][p.key] ? 'checked' : '';
                        const isDisabled = tag === 'Proprietário' ? 'disabled' : ''; // Proprietário tem todas as permissões
                        
                        html += `
                        <label class="flex items-start gap-2 text-sm text-gray-700 cursor-pointer p-1 rounded hover:bg-gray-100 transition-colors duration-200" title="${p.tip}">
                            <div class="flex-shrink-0 mt-0.5">
                                <input type="checkbox" class="perm-checkbox" data-role="${tag}" data-perm="${p.key}" ${checked} ${isDisabled}>
                            </div>
                            <div>
                                <div class="font-medium">${p.label}</div>
                                <div class="text-xs text-gray-500">${p.tip}</div>
                            </div>
                        </label>
                        `;
                    });
                    
                    html += `
                        </div>
                    </div>
                    `;
                });
                
                html += '</div>';
                panel.innerHTML = html;

                // Adicionar listeners para os checkboxes
                panel.querySelectorAll('.perm-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', async (e) => {
                        const role = e.target.dataset.role;
                        const perm = e.target.dataset.perm;
                        const checked = e.target.checked;

                        if (role === 'Proprietário') {
                            e.target.checked = true; // Força manter marcado para Proprietário
                            return;
                        }

                        try {
                            const newRolePerms = {...(activeBoardData.rolePermissions || {})};
                            if (!newRolePerms[role]) newRolePerms[role] = {};
                            newRolePerms[role][perm] = checked;

                            const boardRef = doc(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}`);
                            await updateDoc(boardRef, {
                                rolePermissions: newRolePerms
                            });

                            showToast('Permissões atualizadas!', 'success');
                        } catch (error) {
                            console.error('Erro ao atualizar permissões:', error);
                            showToast('Erro ao atualizar permissões.', 'error');
                            e.target.checked = !checked; // Reverte a mudança em caso de erro
                        }
                    });
                });
            }
        }



        // ... existing code ...

        // Adicionar botão de relatórios aos FABs
        const fabContainer = document.querySelector('.fab-container');
        if (fabContainer) {
            const reportsBtn = document.createElement('button');
            reportsBtn.id = 'inventoryReportsBtn';
            reportsBtn.className = 'fab-button bg-purple-600 hover:bg-purple-700 hidden';
            reportsBtn.innerHTML = '<i class="fas fa-chart-bar"></i>';
            reportsBtn.title = 'Relatórios do Estoque';
            fabContainer.appendChild(reportsBtn);
        }

        // Adicionar modal de relatórios
        if (!document.getElementById('inventoryReportsModal')) {
            const modal = document.createElement('div');
            modal.id = 'inventoryReportsModal';
            modal.className = 'fixed inset-0 modal-overlay flex items-center justify-center z-[100] hidden';
            modal.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-4xl modal-content">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-purple-700 flex items-center">
                            <i class="fas fa-chart-bar mr-2"></i>Relatórios do Estoque
                        </h3>
                        <button id="closeReportsModalBtn" class="text-gray-400 hover:text-red-500 text-2xl p-1 rounded-full transition">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <!-- Cards de Resumo -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-blue-800 font-semibold mb-2">Resumo Geral</h4>
                            <div id="inventorySummary" class="space-y-2">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-600">Total de Produtos:</span>
                                    <span class="font-semibold" id="totalProducts">-</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-600">Produtos com Estoque Baixo:</span>
                                    <span class="font-semibold text-yellow-600" id="lowStockProducts">-</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-600">Produtos sem Estoque:</span>
                                    <span class="font-semibold text-red-600" id="outOfStockProducts">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="text-green-800 font-semibold mb-2">Movimentações</h4>
                            <div id="movementsSummary" class="space-y-2">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-600">Retiradas (Mês):</span>
                                    <span class="font-semibold" id="monthlyWithdrawals">-</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-600">Devoluções (Mês):</span>
                                    <span class="font-semibold" id="monthlyReturns">-</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-gray-600">Solicitações Pendentes:</span>
                                    <span class="font-semibold text-yellow-600" id="pendingRequests">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Abas de Relatórios -->
                    <div class="border-b border-gray-200 mb-6">
                        <div class="flex space-x-4" role="tablist">
                            <button class="report-tab-btn active px-4 py-2 text-sm font-medium border-b-2 border-purple-500" data-tab="movements">
                                Movimentações
                            </button>
                            <button class="report-tab-btn px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent" data-tab="products">
                                Produtos
                            </button>
                            <button class="report-tab-btn px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent" data-tab="categories">
                                Categorias
                            </button>
                        </div>
                    </div>

                    <!-- Conteúdo das Abas -->
                    <div id="reportsContent" class="min-h-[300px] max-h-[500px] overflow-y-auto">
                        <!-- O conteúdo será preenchido dinamicamente -->
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Funções para relatórios
        async function loadInventoryReport() {
            if (!activeBoardId || !canViewReports(activeBoardData)) {
                showToast('Você não tem permissão para visualizar relatórios.', 'error');
                return;
            }

            const modal = document.getElementById('inventoryReportsModal');
            if (!modal) return;

            showLoading();
            try {
                // Carregar dados do resumo
                const inventorySnapshot = await getDocs(inventoryCollectionRef);
                const products = inventorySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                
                // Atualizar cards de resumo
                document.getElementById('totalProducts').textContent = products.length;
                document.getElementById('lowStockProducts').textContent = products.filter(p => p.qty > 0 && p.qty <= 5).length;
                document.getElementById('outOfStockProducts').textContent = products.filter(p => p.qty <= 0).length;

                // Carregar movimentações do mês atual
                const startOfMonth = new Date();
                startOfMonth.setDate(1);
                startOfMonth.setHours(0, 0, 0, 0);

                const withdrawalsRef = collection(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}/userWithdrawals`);
                const withdrawalsQuery = query(
                    withdrawalsRef,
                    where('date', '>=', startOfMonth)
                );
                const withdrawalsSnapshot = await getDocs(withdrawalsQuery);
                const withdrawals = withdrawalsSnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

                document.getElementById('monthlyWithdrawals').textContent = withdrawals.filter(w => w.status === 'retirado').length;
                document.getElementById('monthlyReturns').textContent = withdrawals.filter(w => w.status === 'devolvido').length;
                document.getElementById('pendingRequests').textContent = withdrawals.filter(w => w.status === 'pendente').length;

                // Mostrar aba inicial
                showReportTab('movements');

            } catch (error) {
                console.error('Erro ao carregar relatórios:', error);
                showToast('Erro ao carregar relatórios.', 'error');
            } finally {
                hideLoading();
                modal.classList.remove('hidden');
            }
        }

        function showReportTab(tabName) {
            // Atualizar botões
            document.querySelectorAll('.report-tab-btn').forEach(btn => {
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('text-purple-600', 'border-purple-500');
                    btn.classList.remove('text-gray-500', 'border-transparent');
                } else {
                    btn.classList.remove('text-purple-600', 'border-purple-500');
                    btn.classList.add('text-gray-500', 'border-transparent');
                }
            });

            // Carregar conteúdo da aba
            const contentDiv = document.getElementById('reportsContent');
            if (!contentDiv) return;

            switch (tabName) {
                case 'movements':
                    loadMovementsReport(contentDiv);
                    break;
                case 'products':
                    loadProductsReport(contentDiv);
                    break;
                case 'categories':
                    loadCategoriesReport(contentDiv);
                    break;
            }
        }

        async function loadMovementsReport(container) {
            container.innerHTML = '<div class="text-center text-gray-400 py-8">Carregando...</div>';
            
            try {
                const withdrawalsRef = collection(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}/userWithdrawals`);
                const q = query(withdrawalsRef, orderBy('date', 'desc'), limit(50));
                const snap = await getDocs(q);

                if (snap.empty) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-8">Nenhuma movimentação encontrada.</div>';
                    return;
                }

                let html = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Data</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Qtd</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usuário</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
        `;

                snap.forEach(doc => {
                    const item = doc.data();
                    const date = item.date ? new Date(item.date.seconds * 1000).toLocaleString('pt-BR') : '-';
                    const statusColors = {
                        'pendente': 'text-yellow-600',
                        'aprovado': 'text-green-600',
                        'rejeitado': 'text-red-600',
                        'retirado': 'text-blue-600',
                        'devolvido': 'text-purple-600',
                        'devolucao_pendente': 'text-orange-600'
                    };
                    const statusLabels = {
                        'pendente': 'Pendente',
                        'aprovado': 'Aprovado',
                        'rejeitado': 'Rejeitado',
                        'retirado': 'Retirado',
                        'devolvido': 'Devolvido',
                        'devolucao_pendente': 'Devolução Pendente'
                    };

                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.prodName || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.qty} ${item.unit || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.displayName || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm ${statusColors[item.status] || 'text-gray-500'}">
                                    ${statusLabels[item.status] || item.status}
                                </span>
                            </td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                </div>
                `;

                container.innerHTML = html;

            } catch (error) {
                console.error('Erro ao carregar relatório de movimentações:', error);
                container.innerHTML = '<div class="text-center text-red-500 py-8">Erro ao carregar relatório.</div>';
            }
        }

        async function loadProductsReport(container) {
            container.innerHTML = '<div class="text-center text-gray-400 py-8">Carregando...</div>';
            
            try {
                const snap = await getDocs(inventoryCollectionRef);
                if (snap.empty) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-8">Nenhum produto encontrado.</div>';
                    return;
                }

                const products = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                
                let html = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produto</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Código</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categoria</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estoque</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
        `;

                products.forEach(prod => {
                    let statusClass = 'text-green-600';
                    let statusText = 'Normal';
                    
                    if (prod.qty <= 0) {
                        statusClass = 'text-red-600';
                        statusText = 'Sem Estoque';
                    } else if (prod.qty <= 5) {
                        statusClass = 'text-yellow-600';
                        statusText = 'Estoque Baixo';
                    }

                    html += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${prod.name || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${prod.code || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${prod.category || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${prod.qty} ${prod.unit || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm ${statusClass}">${statusText}</span>
                            </td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                </div>
                `;

                container.innerHTML = html;

            } catch (error) {
                console.error('Erro ao carregar relatório de produtos:', error);
                container.innerHTML = '<div class="text-center text-red-500 py-8">Erro ao carregar relatório.</div>';
            }
        }

        async function loadCategoriesReport(container) {
            container.innerHTML = '<div class="text-center text-gray-400 py-8">Carregando...</div>';
            
            try {
                const snap = await getDocs(inventoryCollectionRef);
                if (snap.empty) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-8">Nenhum produto encontrado.</div>';
                    return;
                }

                const products = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                const categories = {};

                // Agrupar produtos por categoria
                products.forEach(prod => {
                    const category = prod.category || 'Sem Categoria';
                    if (!categories[category]) {
                        categories[category] = {
                            totalProducts: 0,
                            totalItems: 0,
                            lowStock: 0,
                            outOfStock: 0
                        };
                    }
                    categories[category].totalProducts++;
                    categories[category].totalItems += prod.qty || 0;
                    if (prod.qty <= 0) categories[category].outOfStock++;
                    else if (prod.qty <= 5) categories[category].lowStock++;
                });

                let html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                `;

                Object.entries(categories).forEach(([category, stats]) => {
                    html += `
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">${category}</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-600">Total de Produtos:</span>
                                <span class="font-semibold">${stats.totalProducts}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-600">Total de Itens:</span>
                                <span class="font-semibold">${stats.totalItems}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-600">Estoque Baixo:</span>
                                <span class="font-semibold text-yellow-600">${stats.lowStock}</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-600">Sem Estoque:</span>
                                <span class="font-semibold text-red-600">${stats.outOfStock}</span>
                            </div>
                        </div>
                    </div>
                    `;
                });

                html += `</div>`;
                container.innerHTML = html;

            } catch (error) {
                console.error('Erro ao carregar relatório de categorias:', error);
                container.innerHTML = '<div class="text-center text-red-500 py-8">Erro ao carregar relatório.</div>';
            }
        }

        // Event Listeners para relatórios
        document.getElementById('inventoryReportsBtn')?.addEventListener('click', loadInventoryReport);
        document.getElementById('closeReportsModalBtn')?.addEventListener('click', () => {
            document.getElementById('inventoryReportsModal').classList.add('hidden');
        });

        // Event Listeners para as abas
        document.querySelectorAll('.report-tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tabName = e.target.dataset.tab;
                if (tabName) showReportTab(tabName);
            });
        });

        // ... existing code ...

        // -- Lógica para Histórico de Estoque --
        async function loadAndShowInventoryHistory() {
            if (!hasPermission(activeBoardData, currentUserId, 'canViewReports')) {
                showToast('Você não tem permissão para ver o histórico.', 'error');
                return;
            }
            const modal = document.getElementById('inventoryHistoryModal');
            const list = document.getElementById('inventoryHistoryList');
            if (!modal || !list) return;
            list.innerHTML = '<div class="text-center text-gray-400 py-8">Carregando histórico...</div>';
            modal.classList.remove('hidden');

            try {
                const withdrawalsRef = collection(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}/userWithdrawals`);
                const q = query(withdrawalsRef, orderBy('date', 'desc'));
                const snap = await getDocs(q);
                
                if (snap.empty) {
                    list.innerHTML = '<div class="text-center text-gray-400 py-8">Nenhuma movimentação registrada.</div>';
                    return;
                }

                list.innerHTML = ''; // Limpa a lista para renderizar
                const now = new Date();
                snap.forEach(docSnap => {
                    const item = docSnap.data();
                    const div = document.createElement('div');
                    const isOverdue = item.status === 'retirado' && item.deadline?.toDate() < now;
                    div.className = `py-3 px-2 ${isOverdue ? 'bg-red-50' : ''}`;

                    // Lógica para badges de status
                    const statusMap = {
                        'retirado': { text: 'Retirado', class: 'bg-blue-100 text-blue-800' },
                        'usado': { text: 'Usado', class: 'bg-green-100 text-green-800' },
                        'devolvido': { text: 'Devolvido', class: 'bg-gray-100 text-gray-800' },
                        'devolucao_pendente': { text: 'Devolução Pendente', class: 'bg-yellow-100 text-yellow-800' },
                    };
                    const statusInfo = statusMap[item.status] || { text: item.status, class: 'bg-gray-100 text-gray-800' };
                    const statusBadge = `<span class="px-2 py-1 text-xs font-medium rounded-full ${statusInfo.class}">${statusInfo.text}</span>`;
                    const overdueBadge = isOverdue ? `<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800 ml-2">ATRASADO</span>` : '';

                    div.innerHTML = `
                        <div class="grid grid-cols-4 gap-4 items-center">
                            <div>
                                <div class="font-semibold text-gray-800">${item.prodName}</div>
                                <div class="text-xs text-gray-500">Qtd: ${item.qty}</div>
                            </div>
                            <div>
                                <div class="font-medium text-sm text-gray-700">${item.displayName}</div>
                                <div class="text-xs text-gray-400">${item.userId.substring(0,10)}...</div>
                            </div>
                            <div>
                                 <div class="text-sm text-gray-600">${item.date ? new Date(item.date.seconds*1000).toLocaleString('pt-BR') : 'N/A'}</div>
                            </div>
                            <div class="text-right">
                                ${statusBadge}
                                ${overdueBadge}
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });

            } catch (err) {
                list.innerHTML = '<div class="text-center text-red-500 py-8">Erro ao carregar o histórico.</div>';
                console.error(err);
            }
        }
        document.getElementById('closeInventoryHistoryModalBtn')?.addEventListener('click', () => document.getElementById('inventoryHistoryModal').classList.add('hidden'));


        // -- Lógica para Inventário de Usuários (Admin) --
        async function loadAndShowAdminUserInventory() {
             if (!hasPermission(activeBoardData, currentUserId, 'canManageInventory')) {
                showToast('Você não tem permissão para gerenciar inventários.', 'error');
                return;
            }
            const modal = document.getElementById('adminUserInventoryModal');
            const content = document.getElementById('adminUserInventoryContent');
            if (!modal || !content) return;
            content.innerHTML = '<div class="text-center text-gray-400 py-8">Carregando usuários...</div>';
            modal.classList.remove('hidden');

            try {
                const members = activeBoardData.members || [];
                content.innerHTML = '<div class="space-y-2"></div>';
                const userListContainer = content.querySelector('div');

                for (const memberId of members) {
                    const userProfileRef = doc(db, `artifacts/${appIdFromGlobal}/userProfiles`, memberId);
                    const userProfileSnap = await getDoc(userProfileRef);
                    const displayName = userProfileSnap.exists() ? userProfileSnap.data().displayName : memberId.substring(0,12);

                    const userDiv = document.createElement('div');
                    userDiv.className = 'p-3 border rounded-lg hover:bg-gray-50 cursor-pointer';
                    userDiv.textContent = displayName;
                    userDiv.dataset.userId = memberId;
                    userDiv.dataset.userName = displayName;

                    userDiv.addEventListener('click', () => showInventoryForUser(memberId, displayName));
                    userListContainer.appendChild(userDiv);
                }

            } catch (err) {
                content.innerHTML = '<div class="text-center text-red-500 py-8">Erro ao carregar usuários.</div>';
                console.error(err);
            }
        }

        async function showInventoryForUser(userId, userName) {
            const content = document.getElementById('adminUserInventoryContent');
            content.innerHTML = `
                <button id="backToUserListBtn" class="mb-4 text-sm text-blue-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>Voltar para a lista</button>
                <h4 class="text-xl font-bold text-gray-800 mb-4">Itens com: ${userName}</h4>
                <div id="userSpecificInventoryList" class="space-y-3">Carregando itens...</div>
            `;
            document.getElementById('backToUserListBtn').addEventListener('click', loadAndShowAdminUserInventory);
            
            const list = document.getElementById('userSpecificInventoryList');
            try {
                const userWithdrawalsRef = collection(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}/userWithdrawals`);
                const q = query(userWithdrawalsRef, where('userId', '==', userId), where('status', '==', 'retirado'));
                const snap = await getDocs(q);

                if (snap.empty) {
                    list.innerHTML = '<div class="text-center text-gray-500 py-4">Este usuário não possui itens retirados.</div>';
                    return;
                }

                list.innerHTML = '';
                snap.forEach(docSnap => {
                    const item = docSnap.data();
                    const div = document.createElement('div');
                    div.className = 'p-3 border rounded-lg flex justify-between items-center';
                    div.innerHTML = `
                        <div>
                            <div class="font-semibold">${item.prodName}</div>
                            <div class="text-xs text-gray-500">Qtd: ${item.qty}</div>
                        </div>
                        <div class="flex gap-2">
                            <button class="admin-mark-used-btn bg-green-500 text-white text-xs px-3 py-1 rounded" data-id="${docSnap.id}">Marcar Usado</button>
                            <button class="admin-request-return-btn bg-yellow-500 text-white text-xs px-3 py-1 rounded" data-id="${docSnap.id}">Solicitar Devolução</button>
                        </div>
                    `;
                    div.querySelector('.admin-mark-used-btn').addEventListener('click', (e) => adminMarkAsUsed(e.currentTarget.dataset.id, userId, userName));
                    div.querySelector('.admin-request-return-btn').addEventListener('click', (e) => adminRequestReturn(e.currentTarget.dataset.id, userId, userName));
                    list.appendChild(div);
                });

            } catch(err) {
                list.innerHTML = '<div class="text-center text-red-500 py-4">Erro ao carregar itens do usuário.</div>';
            }
        }

        async function adminMarkAsUsed(withdrawalId, userId, userName) {
            // Função para admin marcar item como usado
            showMessageModal('Confirmar Ação', `Marcar o item como "Usado" para ${userName}?`, 'warning', async () => {
                showLoading();
                try {
                    const withdrawalRef = doc(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}/userWithdrawals`, withdrawalId);
                    await updateDoc(withdrawalRef, {
                        status: 'usado',
                        usedAt: serverTimestamp(),
                        actionTakenBy: currentUserId // Loga que o admin fez a ação
                    });
                    showToast('Item marcado como usado!', 'success');
                    showInventoryForUser(userId, userName); // Recarrega a lista
                } catch(err) {
                    showToast('Erro ao executar ação.', 'error');
                } finally {
                    hideLoading();
                }
            }, 'Confirmar', true);
        }

        async function adminRequestReturn(withdrawalId, userId, userName) {
            // Função para admin solicitar devolução
             showMessageModal('Confirmar Ação', `Solicitar a devolução deste item de ${userName}?`, 'warning', async () => {
                showLoading();
                try {
                    const withdrawalRef = doc(db, `artifacts/${appIdFromGlobal}/boards/${activeBoardId}/userWithdrawals`, withdrawalId);
                    await updateDoc(withdrawalRef, {
                        status: 'devolucao_pendente',
                        returnRequestDate: serverTimestamp(),
                        actionTakenBy: currentUserId // Loga que o admin fez a ação
                    });
                    showToast('Devolução solicitada!', 'success');
                    showInventoryForUser(userId, userName); // Recarrega a lista
                } catch(err) {
                    showToast('Erro ao executar ação.', 'error');
                } finally {
                    hideLoading();
                }
            }, 'Confirmar', true);
        }

        document.getElementById('closeAdminUserInventoryModalBtn')?.addEventListener('click', () => document.getElementById('adminUserInventoryModal').classList.add('hidden'));
    </script>
    <!-- Botão Estoque no menu principal (aparece só dentro do quadro) -->
    <button id="openInventoryBtn" class="fixed bottom-24 right-6 z-40 bg-emerald-600 text-white rounded-full shadow-lg w-14 h-14 flex items-center justify-center text-2xl hover:bg-emerald-700 transition-all" style="display:none;"><i class="fas fa-boxes"></i></button>
    <!-- Botão Solicitar Item flutuante -->
    <button id="requestStockBtn" class="fixed bottom-40 right-6 z-40 bg-emerald-500 text-white rounded-full shadow-lg w-14 h-14 flex items-center justify-center text-2xl hover:bg-emerald-700 transition-all" style="display:none;" title="Solicitar Item do Estoque"><i class="fas fa-box-open"></i></button>


    <!-- Modal de Estoque -->
    <div id="inventoryModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-[80] hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl modal-content flex flex-col h-[80vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-emerald-700 flex items-center"><i class="fas fa-boxes mr-2"></i>Estoque</h3>
                <button id="closeInventoryModalBtn" class="text-gray-400 hover:text-red-500 text-2xl p-1 rounded-full transition duration-150 ease-in-out flex items-center justify-center w-10 h-10 focus:outline-none focus:ring-2 focus:ring-red-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="flex justify-between items-center mb-3">
                <input id="inventorySearchInput" type="text" placeholder="Buscar produto..." class="px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 text-sm w-1/2" />
                <button id="addProductBtn" class="bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-emerald-700 font-semibold text-base ml-2 hidden"><i class="fas fa-plus mr-1"></i>Adicionar Produto</button>
            </div>
            <div id="inventoryList" class="flex-1 overflow-y-auto divide-y divide-gray-100 mb-2"></div>
        </div>
    </div>
    <!-- Modal de Adicionar Produto -->
    <div id="addProductModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-[90] hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md modal-content">
            <h3 class="text-xl font-bold text-emerald-700 mb-6">Adicionar Produto</h3>
            <div class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700 mb-1">Nome</label><input id="productNameInput" type="text" class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" placeholder="Nome do produto"></div>
                <div class="flex gap-2"><div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-1">Código</label><input id="productCodeInput" type="text" class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" placeholder="Código"></div><div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label><input id="productCategoryInput" type="text" class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" placeholder="Categoria"></div></div>
                <div class="flex gap-2"><div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-1">Quantidade Inicial</label><input id="productQtyInput" type="number" min="0" class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" placeholder="0"></div><div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-1">Unidade</label><input id="productUnitInput" type="text" class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" placeholder="un, kg, l..."></div></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label><textarea id="productDescInput" rows="2" class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" placeholder="Descrição..."></textarea></div>
            </div>
            <div class="flex justify-end space-x-4 pt-4"><button id="cancelAddProductBtn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 font-medium">Cancelar</button><button id="confirmAddProductBtn" class="bg-emerald-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-emerald-700 font-medium">Adicionar</button></div>
        </div>
    </div>

    <!-- Modal de Editar Produto -->
    <div id="editProductModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-[90] hidden">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md modal-content">
      <h3 class="text-xl font-bold text-emerald-700 mb-6">Editar Produto</h3>
      <input type="hidden" id="editProductIdInput">
      <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-1">Nome</label><input id="editProductNameInput" type="text" class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm"></div>
        <div class="flex gap-2"><div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-1">Código</label><input id="editProductCodeInput" type="text" class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm"></div><div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label><input id="editProductCategoryInput" type="text" class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm"></div></div>
        <div class="flex gap-2"><div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-1">Quantidade</label><input id="editProductQtyInput" type="number" min="0" class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm"></div><div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-1">Unidade</label><input id="editProductUnitInput" type="text" class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm"></div></div>
        <div><label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label><textarea id="editProductDescInput" rows="2" class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm"></textarea></div>
      </div>
      <div class="flex justify-end space-x-4 pt-4">
        <button id="cancelEditProductBtn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 font-medium">Cancelar</button>
        <button id="saveEditProductBtn" class="bg-emerald-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-emerald-700 font-medium">Salvar Alterações</button>
        <button id="deleteProductBtn" class="bg-red-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-red-700 font-medium">Excluir</button>
      </div>
    </div>
    </div>

    <!-- Modal de Retirada -->
    <div id="withdrawProductModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-[90] hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md modal-content">
            <h3 class="text-xl font-bold text-emerald-700 mb-6">Retirar Produto</h3>
            <input type="hidden" id="withdrawProductIdInput">
            <div class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700 mb-1">Produto</label><input id="withdrawProductNameInput" type="text" class="block w-full px-4 py-2 border border-gray-200 bg-gray-50 rounded-lg sm:text-sm" disabled></div>
                <div class="flex gap-2"><div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-1">Quantidade</label><input id="withdrawQtyInput" type="number" min="1" class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" placeholder="0"></div><div class="flex-1"><label class="block text-sm font-medium text-gray-700 mb-1">Unidade</label><input id="withdrawUnitInput" type="text" class="block w-full px-4 py-2 border border-gray-200 bg-gray-50 rounded-lg sm:text-sm" disabled></div></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1">Motivo/Observação</label><textarea id="withdrawReasonInput" rows="2" class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" placeholder="Motivo ou observação..."></textarea></div>
            </div>
            <div class="flex justify-end space-x-4 pt-4"><button id="cancelWithdrawBtn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 font-medium">Cancelar</button><button id="confirmWithdrawBtn" class="bg-emerald-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-emerald-700 font-medium">Confirmar Retirada</button></div>
        </div>
    </div>

    <!-- Modal de Solicitação de Item de Estoque -->
    <div id="requestStockModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-[95] hidden">
      <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md modal-content">
        <h3 class="text-xl font-bold text-emerald-700 mb-6 flex items-center"><i class="fas fa-box-open mr-2"></i>Solicitar Item do Estoque</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Produto</label>
            <select id="requestProductSelect" class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm"></select>
          </div>
          <div class="flex gap-2">
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700 mb-1">Quantidade</label>
              <input id="requestQtyInput" type="number" min="1" class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" placeholder="0">
            </div>
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700 mb-1">Unidade</label>
              <input id="requestUnitInput" type="text" class="block w-full px-4 py-2 border border-gray-200 bg-gray-50 rounded-lg sm:text-sm" disabled>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Motivo</label>
            <textarea id="requestReasonInput" rows="2" class="block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" placeholder="Por que precisa deste item?"></textarea>
          </div>
        </div>
        <div class="flex justify-end space-x-4 pt-4">
          <button id="cancelRequestStockBtn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg shadow-sm hover:bg-gray-300 font-medium">Cancelar</button>
          <button id="confirmRequestStockBtn" class="bg-emerald-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-emerald-700 font-medium">Solicitar</button>
        </div>
      </div>
    </div>



    <!-- Campo de menção de produto no modal de tarefa (Adicionar/Editar) -->
    <!-- Adicionar dentro do modal de tarefa, após prioridade e vencimento -->
    
    <!-- Modal de Meus Itens -->
    <div id="myItemsModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-[97] hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-blue-700 flex items-center"><i class="fas fa-box mr-2"></i>Meus Itens</h3>
                <button id="closeMyItemsModalBtn" class="text-gray-400 hover:text-red-500 text-2xl p-1 rounded-full transition"><i class="fas fa-times"></i></button>
            </div>
            <div id="myItemsList" class="flex-1 overflow-y-auto divide-y divide-gray-100 mb-2 max-h-[60vh]"></div>
        </div>
    </div>

    <!-- Modal de Solicitações Pendentes -->
    <div id="pendingRequestsModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-[98] hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-yellow-700 flex items-center"><i class="fas fa-clipboard-list mr-2"></i>Solicitações Pendentes</h3>
                <button id="closePendingRequestsModalBtn" class="text-gray-400 hover:text-red-500 text-2xl p-1 rounded-full transition"><i class="fas fa-times"></i></button>
            </div>
            <div id="pendingRequestsList" class="flex-1 overflow-y-auto divide-y divide-gray-100 mb-2 max-h-[60vh]"></div>
        </div>
    </div>

    <!-- Modal de Histórico de Solicitações -->
    <div id="myRequestsModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-[99] hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-blue-700 flex items-center"><i class="fas fa-history mr-2"></i>Histórico de Solicitações</h3>
                <button id="closeMyRequestsModalBtn" class="text-gray-400 hover:text-red-500 text-2xl p-1 rounded-full transition"><i class="fas fa-times"></i></button>
            </div>
            <div id="myRequestsList" class="flex-1 overflow-y-auto divide-y divide-gray-100 mb-2 max-h-[60vh]"></div>
        </div>
    </div>

    <!-- Modal de Histórico de Estoque (Admin) -->
    <div id="inventoryHistoryModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-[100] hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-4xl modal-content flex flex-col h-[85vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-blue-700 flex items-center"><i class="fas fa-history mr-2"></i>Histórico de Estoque</h3>
                <button id="closeInventoryHistoryModalBtn" class="text-gray-400 hover:text-red-500 text-2xl p-1"><i class="fas fa-times"></i></button>
            </div>
            <div id="inventoryHistoryList" class="flex-1 overflow-y-auto divide-y divide-gray-100 mb-2">
            </div>
        </div>
    </div>

    <!-- Modal de Inventário de Usuários (Admin) -->
    <div id="adminUserInventoryModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-[100] hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl modal-content flex flex-col h-[85vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-gray-700 flex items-center"><i class="fas fa-users-cog mr-2"></i>Inventário de Usuários</h3>
                <button id="closeAdminUserInventoryModalBtn" class="text-gray-400 hover:text-red-500 text-2xl p-1"><i class="fas fa-times"></i></button>
            </div>
            <div id="adminUserInventoryContent" class="flex-1 overflow-y-auto">
            </div>
        </div>
    </div>

</body>
</html>
